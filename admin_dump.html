<!doctype html><html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'/><meta name='color-scheme' content='dark light'/><title>Owner Admin Console ‚Äî World Cup Concierge</title>
<div class="card" style="margin-top:12px">
  <div class="row" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
    <a class="btn2" href="/admin?key=baysah23_worldcup_admin_7f3b9a8c2d1e4f5a9c0b">All</a>
    <a class="btn2" href="/admin?key=baysah23_worldcup_admin_7f3b9a8c2d1e4f5a9c0b&days=7">Last 7 days</a>
    <a class="btn2" href="/admin?key=baysah23_worldcup_admin_7f3b9a8c2d1e4f5a9c0b&days=30">Last 30 days</a>
    <a class="btn" href="/admin/api/leads/export?key=baysah23_worldcup_admin_7f3b9a8c2d1e4f5a9c0b">Export CSV</a>
    <span class="note" style="margin-left:auto;opacity:.75">Export matches current filter</span>
  </div>
</div>

<style>
:root{
  color-scheme:dark;
  --bg:#0b1020;
  --panel:#0f1b33;
  --line:rgba(255,255,255,.10);
  --text:#eaf0ff;
  --muted:#b9c7ee;
  --gold:#d4af37;
  --good:#2ea043;
  --warn:#ffcc66;
  --bad:#ff5d5d;

  /* menu / dropdown tokens */
  --menu-bg:#0f172a;
  --menu-hover:#1e293b;
  --menu-text:#f8fafc;
}

body{
  margin:0;
  font-family:Arial,system-ui,sans-serif;
  background:radial-gradient(900px 700px at 20% 10%, #142a5b 0%, var(--bg) 55%);
  color:var(--text);
}

.wrap{max-width:1200px;margin:0 auto;padding:18px;}
.topbar{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:12px;}
.h1{font-size:18px;font-weight:800;letter-spacing:.3px}
.sub{color:var(--muted);font-size:12px;margin-top:4px}

.pills{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.pill{
  border:1px solid var(--line);
  background:rgba(255,255,255,.03);
  padding:8px 10px;
  border-radius:999px;
  font-size:12px
}
.pillbtn{cursor:pointer}

.pillselect,
select{
  border:1px solid var(--line);
  background:rgba(255,255,255,.03);
  color:var(--menu-text);
  padding:8px 10px;
  border-radius:999px;
  font-size:12px;
  outline:none;
  z-index:9999;
}

.pillselect option,
select option{
  background:var(--menu-bg) !important;
  color:var(--menu-text) !important;
}

.pillselect option:hover,
select option:hover{
  background:var(--menu-hover) !important;
}

/* iOS Safari native picker fix */
@supports (-webkit-touch-callout: none) {
  html{color-scheme:dark;}
  .pillselect,select{
    color-scheme:dark;
    -webkit-appearance:none;
    appearance:none;
  }
  .pillselect option,select option{
    background:#0f172a;
    color:#ffffff;
  }
}

.pills .pill input[type="checkbox"]{
  transform:translateY(1px);
  margin-left:8px;
}

.pill b{color:var(--gold)}

.tabs{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0 14px}
.tabgroup{
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
  padding:6px 8px;
  border-radius:14px;
  background:rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.07)
}
.tablabel{font-size:11px;letter-spacing:.14em;text-transform:uppercase;opacity:.65;margin-right:4px}
.tabbtn{
  border:1px solid var(--line);
  background:rgba(255,255,255,.03);
  color:var(--text);
  padding:10px 12px;
  border-radius:12px;
  font-size:13px;
  font-weight:700;
  cursor:pointer
}
.tabbtn.active{
  border-color:rgba(212,175,55,.6);
  box-shadow:0 0 0 1px rgba(212,175,55,.25) inset
}
.tabbtn.locked{opacity:.45;cursor:not-allowed}
.tabbtn.locked:hover{transform:none}

.card{
  background:rgba(255,255,255,.04);
  border:1px solid var(--line);
  border-radius:14px;
  padding:12px 12px;
  margin:10px 0;
  overflow:visible;
}

.h2{font-size:14px;font-weight:800;margin:0 0 8px}
.small{font-size:12px;color:var(--muted)}

.tablewrap{
  overflow:auto;
  border-radius:12px;
  border:1px solid var(--line)
}

table{width:100%;border-collapse:collapse;font-size:12px}
th,td{
  padding:10px 8px;
  border-bottom:1px solid rgba(255,255,255,.08);
  vertical-align:top
}
th{
  position:sticky;
  top:0;
  background:rgba(10,16,32,.9);
  text-align:left
}

.badge{
  display:inline-block;
  padding:4px 8px;
  border-radius:999px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.03);
  font-size:11px
}
.badge.good{border-color:rgba(46,160,67,.35)}
.badge.warn{border-color:rgba(255,204,102,.35)}
.badge.bad{border-color:rgba(255,93,93,.35)}

.inp,textarea,select{
  width:100%;
  box-sizing:border-box;
  background:rgba(255,255,255,.04);
  border:1px solid var(--line);
  color:var(--menu-text);
  padding:10px;
  border-radius:12px;
  font-size:13px;
  outline:none
}

.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:900px){.row{grid-template-columns:1fr}}

.btn{
  border:1px solid rgba(212,175,55,.45);
  background:rgba(212,175,55,.12);
  color:var(--text);
  padding:10px 12px;
  border-radius:12px;
  font-size:13px;
  font-weight:800;
  cursor:pointer
}
.btn2{
  border:1px solid var(--line);
  background:rgba(255,255,255,.03);
  color:var(--text);
  padding:10px 12px;
  border-radius:12px;
  font-size:13px;
  font-weight:700;
  cursor:pointer
}
.btnTiny{
  margin-left:6px;
  min-width:32px;
  height:32px;
  line-height:30px;
  padding:0 8px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.06);
  color:var(--text);
  cursor:pointer
}
.btnTiny:hover{background:rgba(255,255,255,.10)}

.note{margin-top:8px;font-size:12px;color:var(--muted)}
.hidden{display:none}
.locked{opacity:.45;filter:saturate(.7);cursor:not-allowed}
.locked::after{content:'‚õî No permission';margin-left:6px;font-size:12px;opacity:.8}

.code{
  font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
  font-size:12px
}

.miniState{
  margin-left:10px;
  padding:2px 8px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.04);
  font-size:12px;
  letter-spacing:.01em;
  opacity:0;
  transition:opacity .18s ease;
}
</style>
</head><body><div class='wrap'><div class='topbar'><div><div class='h1'>Owner Admin Console</div><div class='sub'>Tabs + Rules Config + Menu Upload (fan UI unchanged) ¬∑ Full control ‚Äî Admin key</div><div class='pills'><span class='pill'><b>Ops</b> 0</span><span class='pill'><b>VIP</b> 0</span><button class='pill' id='notifBtn' type='button' onclick="openNotifications()">üîî <b id='notifCount'>0</b></button><button class='pill pillbtn' id='refreshBtn' type='button' onclick="refreshAll('manual')">‚Üª <b>Refresh</b></button><button class='pill pillbtn' id='autoBtn' type='button' onclick="toggleAutoRefresh()">‚ü≥ <b id='autoLabel'>Auto: Off</b></button><select class='pillselect' id='autoEvery' onchange="autoEveryChanged()"><option value='10'>10s</option><option value='30' selected>30s</option><option value='60'>60s</option></select><span class='pill' id='lastRef'>Last refresh: ‚Äî</span><span class='pill'><b>New</b> 0</span><span class='pill'><b>Confirmed</b> 0</span><span class='pill'><b>Seated</b> 0</span><span class='pill'><b>No-Show</b> 0</span></div></div><div style='text-align:right'><div class='small'>Admin key: <span class='code'>‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span></div><div style='margin-top:8px;display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap'><a class='btn2' style='text-decoration:none' href='/admin/export.csv?key=baysah23_worldcup_admin_7f3b9a8c2d1e4f5a9c0b'>Export CSV</a><a class='btn2' style='text-decoration:none' href='#fanzone' onclick="showTab('fanzone');return false;">Fan Zone</a></div></div></div>
<div class="tabs">
  <div class="tabgroup">
    <span class="tablabel">Operate</span>
    <button type="button" class="tabbtn active" data-tab="ops" onclick="showTab('ops');return false;">Ops</button>
    <button type="button" class="tabbtn" data-tab="leads" onclick="showTab('leads');return false;">Leads</button>
    <button type="button" class="tabbtn" data-tab="aiq" onclick="showTab('aiq');return false;">AI Queue</button>
    <button type="button" class="tabbtn" data-tab="monitor" onclick="showTab('monitor');return false;">Monitoring</button>
    <button type="button" class="tabbtn" data-tab="audit" onclick="showTab('audit');return false;">Audit</button>
  </div>
  <div class="tabgroup">
    <span class="tablabel">Configure</span>
    <button type="button" class="tabbtn" data-tab="ai" data-minrole="owner" onclick="showTab('ai');return false;">AI Settings</button>
    <button type="button" class="tabbtn" data-tab="rules" data-minrole="owner" onclick="showTab('rules');return false;">Rules</button>
    <button type="button" class="tabbtn" data-tab="menu" data-minrole="owner" onclick="showTab('menu');return false;">Menu</button>
    <button type="button" class="tabbtn" data-tab="policies" data-minrole="owner" onclick="showTab('policies');return false;">Policies</button>
  </div>
</div>

<!-- OPS TAB -->
<div id="tab-ops" class="tabpane">
  <div class="card" id="ops-controls">
    <div class="h2">Ops</div>
    <div class="small">Fast operational controls (audited).</div>
    <div class="small" id="ops-meta" style="margin-top:6px;opacity:.85"></div>

    <div style="margin-top:12px;display:flex;flex-direction:column;gap:10px">
      <label class="small" style="display:flex;align-items:center;gap:10px">
        <input type="checkbox" id="ops-pause" onchange="saveOps()">
        <span><b>Pause Reservations</b></span>
        <span id="mini-pause" class="note" style="margin-left:auto;opacity:0;transition:opacity .18s"></span>
      </label>

      <label class="small" style="display:flex;align-items:center;gap:10px">
        <input type="checkbox" id="ops-viponly" onchange="saveOps()">
        <span><b>VIP Only</b></span>
        <span id="mini-vip" class="note" style="margin-left:auto;opacity:0;transition:opacity .18s"></span>
      </label>

      <label class="small" style="display:flex;align-items:center;gap:10px">
        <input type="checkbox" id="ops-waitlist" onchange="saveOps()">
        <span><b>Waitlist Mode</b> <span style="opacity:.75">(AI Waiting List)</span></span>
        <span id="mini-wait" class="note" style="margin-left:auto;opacity:0;transition:opacity .18s"></span>
      </label>
    </div>

    <div id="ops-msg" class="note" style="margin-top:10px"></div>
    <div class="small" style="margin-top:10px;opacity:.72">
      Tip: toggles auto-save (‚ÄúSaving‚Ä¶‚Äù ‚Üí ‚ÄúSaved‚Äù).
    </div>
  </div>

  <div class="card" id="matchdayCard">
    <div class="h2">Match Day Ops</div>
    <div class="small">One-click presets that set multiple Ops toggles + key Rules. Audited.</div>
    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
      <button type="button" class="btn2" onclick="applyPreset('Kickoff Rush')">Kickoff Rush</button>
      <button type="button" class="btn2" onclick="applyPreset('Halftime Surge')">Halftime Surge</button>
      <button type="button" class="btn2" onclick="applyPreset('Post-game')">Post-game</button>
    </div>
    <div id="preset-msg" class="note" style="margin-top:10px"></div>
    <div class="small" style="margin-top:10px;opacity:.72">
      Tip: presets update Ops + Rules instantly so staff can shift modes fast.
    </div>
  </div>

  <div class="card" id="notifCard">
    <div class="h2">Notifications</div>
    <div id="notifBody" class="small" style="margin-top:8px"></div>
    <div id="notif-msg" class="note" style="margin-top:8px"></div>
  </div>
</div>

<!-- FAN ZONE TAB -->
<div id="tab-fanzone" class="tabpane hidden">
  <div class="card">
    <div class="h2">Fan Zone</div>
    <div class="small">Fan Zone admin controls.</div>
    <div id="fanzoneAdminRoot" class="small" style="margin-top:10px"></div>
  </div>
</div>

<!-- LEADS TAB -->

<div id="tab-monitor" class="tabpane hidden">
  <div class="card" id="healthCard">
    <div class="h2">System Health</div>
    <div class="small">Read-only checks for Sheets, Queue, Fixtures, and outbound readiness. Alerts are optional.</div>
    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
      <button type="button" class="btn" onclick="runHealth()">Run checks</button>
      <button type="button" class="btn2" onclick="loadHealth()">Refresh</button>
      <span id="health-msg" class="note"></span>
      <span style="margin-left:auto" class="note" id="health-ts"></span>
    </div>
    <div id="health-body" class="small" style="margin-top:12px;white-space:pre-wrap"></div>
  </div>
  <div class="card" id="forecastCard">
  <div class="h2">Tonight Forecast</div>
  <div class="small">Read-only load forecast (last 7/30 days). Helps staffing + VIP readiness.</div>
  <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
    <button class="btn2" type="button" onclick="loadForecast()">Refresh</button>
    <span id="forecast-msg" class="note"></span>
  </div>
  <div id="forecastBody" class="small" style="margin-top:10px;line-height:1.4"></div>
</div>
  <div class="card" id="alertsCard">
    <div class="h2">Alerts Settings</div>
    <div class="small">Configure monitoring alerts (Slack/Email/SMS). Alerts are rate-limited and best-effort (never crash the app).</div>

    <div class="grid2" style="margin-top:12px">
      <div>
        <label class="small" style="display:flex;gap:8px;align-items:center">
          <input id="al-enabled" type="checkbox"/>
          <span>Enable alerts</span>
        </label>
        <div class="small" style="opacity:.8;margin-top:6px">When enabled, <b>Run checks</b> can emit alerts on failures (rate-limited).</div>
      </div>
      <div>
        <label class="small">Rate limit (seconds)</label>
        <input id="al-rate" class="inp" type="number" min="60" step="60" placeholder="600"/>
      </div>
    </div>

    <div class="grid2" style="margin-top:12px">
      <div>
        <label class="small" style="display:flex;gap:8px;align-items:center">
          <input id="al-slack-en" type="checkbox"/>
          <span>Slack</span>
        </label>
        <input id="al-slack-url" class="inp" placeholder="Slack webhook URL"/>
      </div>
      <div>
        <label class="small" style="display:flex;gap:8px;align-items:center">
          <input id="al-email-en" type="checkbox"/>
          <span>Email</span>
        </label>
        <input id="al-email-to" class="inp" placeholder="Alert email TO"/>
        <input id="al-email-from" class="inp" placeholder="Alert email FROM (optional)"/>
      </div>
    </div>

    <div class="grid2" style="margin-top:12px">
      <div>
        <label class="small" style="display:flex;gap:8px;align-items:center">
          <input id="al-sms-en" type="checkbox"/>
          <span>SMS (critical only)</span>
        </label>
        <input id="al-sms-to" class="inp" placeholder="Alert SMS TO (E.164)"/>
        <div class="small" style="opacity:.75;margin-top:6px">SMS only sends on <b>error</b> severity alerts (to prevent spam).</div>
      </div>
      <div>
        <label class="small">Fixtures stale threshold (seconds)</label>
        <input id="al-fixtures-stale" class="inp" type="number" min="3600" step="3600" placeholder="86400"/>
      </div>
    </div>

    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
      <button type="button" class="btn2" onclick="loadAlerts()">Load</button>
      <button type="button" class="btn" data-min-role="owner" onclick="saveAlerts()">Save</button>
      <button type="button" class="btn2" data-min-role="owner" onclick="testAlert()">Send test alert</button>
      <span id="al-msg" class="note"></span>
    </div>
  </div>
</div>

<div id="tab-leads" class="tabpane hidden">
<div class='card'><div class='h2'>Leads</div><div class='small'>No leads yet.</div></div></div>

<div id="tab-ai" class="tabpane hidden">
  <div class="card">
    <div class="h2">AI Automation</div>
    <div class="small">Managers can enable/disable AI and choose how much autonomy it has. Owners can tune advanced behavior.</div>
  </div>

  <div class="row">
    <div class="card" style="margin:0">
      <div class="h2" style="margin-bottom:6px">Runtime controls</div>

      <label class="small" style="display:flex;gap:10px;align-items:center">
        <input type="checkbox" id="ai-enabled">
        <span><b>Enable AI</b> (master switch)</span>
      </label>

      <div style="margin-top:10px">
        <label class="small">Mode</label>
        <select class="inp" id="ai-mode">
          <option value="off">Off</option>
          <option value="suggest">Suggest (recommended)</option>
          <option value="auto">Auto (guardrails)</option>
        </select>
        <div class="note">Suggest = AI drafts/recommends; humans approve. Auto = AI can apply actions (still gated).</div>
      </div>

      <div style="margin-top:10px">
        <label class="small" style="display:flex;gap:10px;align-items:center">
          <input type="checkbox" id="ai-approval">
          <span><b>Require approval</b> (recommended)</span>
        </label>
      </div>

      <div style="margin-top:10px">
        <label class="small">Min confidence (0‚Äì1)</label>
        <input class="inp" id="ai-minconf" type="number" min="0" max="1" step="0.05" />
      </div>

      <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
        <button type="button" class="btn" onclick="saveAI()">Save AI Settings</button>
        <button class="btn2" onclick="loadAI()">Reload</button>
        <span id="ai-msg" class="note"></span>
      </div>
    </div>

    <div class="card" style="margin:0">
      <div class="h2" style="margin-bottom:6px">Owner settings</div>
      <div class="small">Only Owners can edit these fields.</div>

      <div style="margin-top:10px">
        <label class="small">Model</label>
        <input class="inp" id="ai-model" placeholder="gpt-4o-mini"/>
      </div>

      <div style="margin-top:10px">
        <label class="small">System prompt</label>
        <textarea class="inp" id="ai-prompt" rows="6"></textarea>
      </div>

      <div style="margin-top:10px">
        <div class="small" style="font-weight:800;margin-bottom:6px">Allowed actions</div>
        <label class="small"><input type="checkbox" id="ai-act-vip"> VIP tagging</label><br/>
        <label class="small"><input type="checkbox" id="ai-act-status"> Status updates</label><br/>
        <label class="small"><input type="checkbox" id="ai-act-draft"> Reply drafts</label>
      </div>

      <div class="note">Tip: keep actions limited until you trust the workflow.</div>
    </div>
  </div>
</div>

  <div class="card" style="margin-top:14px">
    <div class="h2">AI Replay (Read-only)</div>
    <div class="small">Owner tool to re-run AI suggestions for a specific lead row without applying changes.</div>
    <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
      <input id="replay-row" class="pillselect" style="min-width:120px" placeholder="Row #" />
      <button class="btn2" type="button" onclick="replayAI()">Replay</button>
      <span id="replay-msg" class="note"></span>
    </div>
    <pre id="replayOut" style="margin-top:10px;white-space:pre-wrap;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:10px;max-height:260px;overflow:auto"></pre>
  </div>

<div id="tab-aiq" class="tabpane hidden">
  <div class="card">
    <div class="h2">AI Approval Queue</div>
    <div class="small">Proposed AI actions wait here for <b>Approve</b>, <b>Deny</b>, or <b>Owner Override</b>. This keeps automation powerful but controlled.</div>
    <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
      <button class="btn2" onclick="loadAIQueue()">Refresh</button>
      <span class="note" style="opacity:.6">|</span>
      <input id="ai-run-limit" class="inp" type="number" min="1" max="25" step="1" value="5" style="max-width:90px" title="How many newest New leads to analyze" />
      <button class="btn2" onclick="runAINew()">Run AI (New)</button>
      <input id="ai-run-row" class="inp" type="number" min="2" step="1" placeholder="Row #" style="max-width:110px" title="Run AI for a specific Google Sheet row number" />
      <button class="btn2" onclick="runAIRow()">Run AI (Row)</button>

      <select id="aiq-filter" class="inp" style="max-width:180px" onchange="loadAIQueue()">
        <option value="">All</option>
        <option value="pending">Pending</option>
        <option value="approved">Approved</option>
        <option value="denied">Denied</option>
      </select>
      <span id="aiq-msg" class="note"></span>
    </div>
  </div>

  <div class="card">
    <div id="aiq-list" class="small">Loading‚Ä¶</div>
  </div>
</div>

<div id="tab-rules" class="tabpane hidden">
  <div class="card">
    <div class="h2">Business Rules</div>
    <div class="small">These rules power reservation guardrails (max party size, closed dates, hours, banner). Saved rules persist on the server.</div>
  </div>

  <div class="card">
    <div class="row">
      <div>
        <label class="small">Max party size</label>
        <input id="rules-max-party" class="inp" type="number" min="1" step="1"/>
      </div>
      <div>
        <label class="small">Match-day banner</label>
        <input id="rules-banner" class="inp" placeholder="üèüÔ∏è Match-day mode..."/>
      </div>
    </div>

    <div style="margin-top:10px">
      <label class="small">Closed dates (YYYY-MM-DD, one per line)</label>
      <textarea id="rules-closed" class="inp" rows="5" placeholder="2026-06-11&#10;2026-06-12"></textarea>
    </div>

    <div style="margin-top:10px">
      <div class="small" style="font-weight:800;margin-bottom:8px">Hours (HH:MM-HH:MM)</div>
      <div class="row">
        <div><label class="small">Mon</label><input id="h-mon" class="inp" placeholder="11:00-22:00"/></div>
        <div><label class="small">Tue</label><input id="h-tue" class="inp" placeholder="11:00-22:00"/></div>
        <div><label class="small">Wed</label><input id="h-wed" class="inp" placeholder="11:00-22:00"/></div>
        <div><label class="small">Thu</label><input id="h-thu" class="inp" placeholder="11:00-23:00"/></div>
        <div><label class="small">Fri</label><input id="h-fri" class="inp" placeholder="11:00-01:00"/></div>
        <div><label class="small">Sat</label><input id="h-sat" class="inp" placeholder="10:00-01:00"/></div>
        <div><label class="small">Sun</label><input id="h-sun" class="inp" placeholder="10:00-22:00"/></div>
      </div>
    </div>

    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
      <button type="button" class="btn" data-min-role="owner" onclick="saveRules()">Save Rules</button>
      <button class="btn2" onclick="loadRules()">Reload</button>
      <span id="rules-msg" class="note"></span>
    </div>
  </div>
  
</div>

  
<div id="tab-menu" class="tabpane hidden">
  <div class="card">
    <div class="h2">Menu Manager</div>
    <div class="small">Upload a JSON menu file to update <span class="code">/menu.json</span> (fan UI stays the same). Supports en/es/pt/fr blocks.</div>
  </div>

  <div class="card">
    <div class="row">
      <div>
        <label class="small">Upload menu JSON file</label>
        <input id="menu-file" class="inp" type="file" accept="application/json"/>
        <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
          <button type="button" class="btn" data-min-role="owner" onclick="uploadMenu()">Upload</button>
          <button class="btn2" onclick="loadMenu()">Load Current</button>
          <span id="menu-msg" class="note"></span>
        </div>
      </div>
      <div>
        <label class="small">Or paste menu JSON</label>
        <textarea id="menu-json" class="inp code" rows="12" placeholder='{"en":{"title":"Menu","items":[{"category_id":"bites","name":"Nachos","price":"$16","desc":"...","tag":"Share"}]}}'></textarea>
        <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn2" onclick="saveMenuJson()">Save JSON</button>
        </div>
      </div>
    </div>
  </div>
</div>


<div id="tab-policies" class="tabpane hidden">
  <div class="card" >
    <div class="h2">Partner / Venue Policies (Hard)</div>
    <div class="small">
      Policies are enforced on <b>AI suggestions</b> and again on <b>Apply</b>. They cannot be bypassed by AI.
      Defaults are safe until you set partner-specific rules.
    </div>

    <div class="grid2" style="margin-top:10px">
      <div>
        <label class="small">Partner / Venue ID</label>
        <input id="pp-partner" class="inp" placeholder="e.g., VENUE_ABC"/>
        <div class="small" style="opacity:.8;margin-top:6px">Tip: use a stable ID you also store in your leads (partner/venue field). "default" applies if no partner is detected.</div>
      </div>
      <div>
        <label class="small">VIP minimum budget (USD)</label>
        <input id="pp-vip-min" class="inp" type="number" min="0" step="50" placeholder="1500"/>
      </div>
    </div>

    <div class="grid2" style="margin-top:10px">
      <div>
        <label class="small">Status updates</label>
        <label class="small" style="display:flex;gap:8px;align-items:center;margin-top:8px">
          <input id="pp-never-status" type="checkbox" checked/>
          <span>Hard block AI status_update (recommended)</span>
        </label>
        <div class="small" style="opacity:.8;margin-top:6px">Even if status_update is allowlisted, this can still block it per partner.</div>
      </div>
      <div>
        <label class="small">Allowed statuses (comma-separated)</label>
        <input id="pp-allowed-statuses" class="inp" placeholder="New, Confirmed, Seated, No-Show, Handled"/>
      </div>
    </div>

    <div class="grid2" style="margin-top:10px">
      <div>
        <label class="small">Outbound allowed channels</label>
        <input id="pp-allowed-channels" class="inp" placeholder="email, sms, whatsapp"/>
        <div class="small" style="opacity:.8;margin-top:6px">Used by outbound sending (next phase). Human-in-the-middle is always enforced.</div>
      </div>
      <div>
        <label class="small">Outbound requires role</label>
        <select id="pp-outbound-role" class="inp">
          <option value="manager">Manager+</option>
          <option value="owner">Owner only</option>
        </select>
      </div>
    </div>

    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
      <button type="button" class="btn" data-min-role="owner" onclick="savePartnerPolicy()">Save Policy</button>
      <button class="btn2" onclick="loadPartnerPolicy()">Load Policy</button>
      <button class="btn2" data-min-role="owner" onclick="deletePartnerPolicy()">Delete Policy</button>
      <button class="btn2" onclick="loadPartnerList()">List Partners</button>
      <span id="pp-msg" class="note"></span>
    </div>

    <div id="pp-list" class="small" style="margin-top:10px;opacity:.9"></div>
  </div>
</div>

<div id="tab-audit" class="tabpane hidden">
  <div class="card">
    <div class="h2">Audit Log</div>
    <div class="small">Shows who changed ops/rules/menu and when.</div>
    <div style="margin-top:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <input class="inp" id="audit-limit" type="number" min="10" max="500" value="200" style="width:120px" />
      <select class="inp" id="audit-filter" style="width:220px">
        <option value="all">All events</option>
      </select>
      <button class="btn2" onclick="loadAudit()">Refresh</button>
      <span id="audit-msg" class="note"></span>
    </div>
    <div class="tablewrap" style="margin-top:10px">
      <table>
        <thead><tr><th>Time</th><th>Actor</th><th>Role</th><th>Event</th><th>Details</th><th></th></tr></thead>
        <tbody id="audit-body"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* Admin tabs bootstrap (runs even if later script has a parse error) */
(function(){
  function qsa(sel){ return document.querySelectorAll(sel); }
  function setActive(tab){
    try{
      var btn = document.querySelector('.tabbtn[data-tab="'+tab+'"]');
      var minRole = (btn && btn.getAttribute && btn.getAttribute('data-minrole')) ? btn.getAttribute('data-minrole') : "manager";
      if(ROLE_RANK && ROLE_RANK[ROLE] !== undefined && ROLE_RANK[minRole] !== undefined){
        if(ROLE_RANK[ROLE] < ROLE_RANK[minRole]){
          try{ toast("Owner-only section"); }catch(e){}
          // snap back to Ops if a hash tried to open a locked tab
          try{
            if(tab !== "ops" && document.querySelector('.tabbtn[data-tab="ops"]')) tab = "ops";
          }catch(e){}
        }
      }
    }catch(e){}

    try{
      var btns = qsa('.tabbtn');
      for(var i=0;i<btns.length;i++){
        var b = btns[i];
        if(b && b.classList){
          var dt = b.getAttribute('data-tab');
          if(dt === tab) b.classList.add('active'); else b.classList.remove('active');
        }
      }
      var panes = qsa('.tabpane');
      for(var j=0;j<panes.length;j++){
        var p = panes[j];
        if(p && p.classList) p.classList.add('hidden');
      }
      var pane = document.getElementById('tab-'+tab);
      if(pane && pane.classList) pane.classList.remove('hidden');
      try{ history.replaceState(null,'','#'+tab); }catch(e){}
    }catch(e){}
  }
  window.showTab = function(tab){
  try{
    var b = document.querySelector('.tabbtn[data-tab="'+tab+'"]');
    var minr = (b && b.getAttribute) ? (b.getAttribute('data-minrole') || 'manager') : 'manager';
    if(ROLE_RANK && ROLE_RANK[ROLE] !== undefined && ROLE_RANK[minr] !== undefined){
      if(ROLE_RANK[ROLE] < ROLE_RANK[minr]){
        try{ toast('Owner only ‚Äî redirected to Ops', 'warn'); }catch(e){}
        try{ setActive('ops'); }catch(e){}
        return false;
      }
    }
  }catch(e){}

  // switch tab panes
  try{ setActive(tab); }catch(e){}

  // Fan Zone: only init when the Fan Zone tab is selected
  if(tab === 'fanzone'){
    try{ initFanZoneAdmin(); }catch(e){}
  }

  return false;
};

  function bind(){
    var btns = qsa('.tabbtn');
    
    // mark owner-only tabs for managers
    try{
      for(var j=0;j<btns.length;j++){
        var br = btns[j];
        var minr = (br && br.getAttribute) ? (br.getAttribute('data-minrole')||'manager') : 'manager';
        if(ROLE_RANK && ROLE_RANK[ROLE] !== undefined && ROLE_RANK[minr] !== undefined){
          if(ROLE_RANK[ROLE] < ROLE_RANK[minr]){
            try{ br.classList.add('locked'); br.setAttribute('title','Owner only'); }catch(e){}
          }
        }
      }
    }catch(e){}
for(var i=0;i<btns.length;i++){
      (function(b){
        try{
          b.addEventListener('click', function(ev){
            try{ ev.preventDefault(); }catch(e){}
            var t = b.getAttribute('data-tab');
            if(t){
              try{
                var minr = (b && b.getAttribute) ? (b.getAttribute('data-minrole') || 'manager') : 'manager';
                if(ROLE_RANK && ROLE_RANK[ROLE] !== undefined && ROLE_RANK[minr] !== undefined){
                  if(ROLE_RANK[ROLE] < ROLE_RANK[minr]){ try{ toast('Owner only ‚Äî redirected to Ops', 'warn'); }catch(e){} setActive('ops'); return; }
                }
              }catch(e){}
              setActive(t);
            }
          });
        }catch(e){}
      })(btns[i]);
    }
    // initial hash or default ops
    var h = (location.hash || '').replace('#','').trim();
    if(h && document.querySelector('.tabbtn[data-tab="'+h+'"]')) showTab(h);
    else showTab('ops');
    window.addEventListener('hashchange', function(){
      var t = (location.hash || '').replace('#','').trim();
      if(t && document.querySelector('.tabbtn[data-tab="'+t+'"]')) showTab(t);
    });
  }

  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', bind);
  else bind();
})();
</script>

<script>
const KEY = (new URLSearchParams(window.location.search).get('key') || '');
let ROLE = ("owner" || 'manager');

// Auto-append ?key=... to same-origin admin/api calls so buttons always work
(function(){
  const _origFetch = window.fetch;
  window.fetch = function(input, init){
    try{
      let url = (typeof input === 'string') ? input : (input && input.url) ? input.url : '';
      if(url && url.startsWith('/')){
        if(url.startsWith('/admin') || url.startsWith('/api') || url.startsWith('/health')){
          if(url.indexOf('key=') === -1){
            url += (url.indexOf('?') === -1 ? '?' : '&') + 'key=' + encodeURIComponent(KEY || '');
            if(typeof input === 'string') input = url;
            else input = new Request(url, input);
          }
        }
      }
    }catch(e){}
    return _origFetch(input, init);
  };
})();

// Refresh role from server so manager/owner locks are always correct
async function _refreshRole(){
  try{
    const r = await fetch(`/admin/api/whoami?key=${encodeURIComponent(KEY||'')}`, {cache:'no-store'});
    const j = await r.json();
    if(j && j.ok && j.role){ ROLE = j.role; }
  }catch(e){}
}

// Enforce owner-only locks (tabs + buttons)
document.addEventListener('click', function(ev){
  try{
    const el = ev.target && ev.target.closest ? ev.target.closest('[data-minrole],[data-min-role]') : null;
    if(!el) return;
    const need = (el.getAttribute('data-minrole') || el.getAttribute('data-min-role') || '').toLowerCase();
    if(need === 'owner' && ROLE !== 'owner'){
      ev.preventDefault();
      ev.stopPropagation();
      try{ toast('Owner-only'); }catch(e){ alert('Owner-only'); }
      try{ if(typeof showTab === 'function') showTab('ops'); }catch(e){}
      return false;
    }
  }catch(e){}
}, true);

document.addEventListener('DOMContentLoaded', function(){
  try{ _refreshRole(); setTimeout(_refreshRole, 500); }catch(e){}
});

const ROLE_RANK = { "manager": 1, "owner": 2 };

function _elSig(el){
  if(!el) return "null";
  const id = el.id ? ("#"+el.id) : "";
  const cls = (el.className && typeof el.className==="string") ? ("."+el.className.trim().replace(/\s+/g,'.')) : "";
  return (el.tagName||"").toLowerCase()+id+cls;
}

// If an invisible overlay is intercepting clicks, this will disable pointer-events on it
// and show a tiny toast with what was unblocked.
function installClickUnblocker(){
  try{
    document.addEventListener('click', (e)=>{
      try{
        // If the click is already hitting a real control, do nothing.
        const t = e.target;
        if(t && (t.closest('button,a,input,select,textarea,label,[role="button"],.tabbtn,.pillbtn'))){
          return;
        }
        const x = e.clientX, y = e.clientY;
        if(!(Number.isFinite(x) && Number.isFinite(y))) return;

        let top = document.elementFromPoint(x,y);
        // If top is the root containers, nothing to unblock.
        if(!top || top === document.body || top === document.documentElement) return;

        // Don't ever disable the main app container.
        if(top.closest && top.closest('.wrap')) return;

        // Heuristic: large positioned layers are most commonly the culprits.
        const cs = window.getComputedStyle(top);
        const pos = (cs.position||"");
        const pe  = (cs.pointerEvents||"");
        const op  = parseFloat(cs.opacity||"1");
        const rect = top.getBoundingClientRect();
        const big = rect.width >= (window.innerWidth*0.9) && rect.height >= (window.innerHeight*0.9);

        if(pe !== 'none' && (pos === 'fixed' || pos === 'absolute') && (big || op < 0.25)){
          top.style.pointerEvents = 'none';
          toast("Unblocked overlay: " + _elSig(top));
        }
      }catch(err){}
    }, true); // capture phase so it runs even if the overlay is the target
  }catch(err){}
}

function hasRole(minRole){
  const need = ROLE_RANK[minRole||"manager"] || 1;
  const have = ROLE_RANK[ROLE||"manager"] || 1;
  return have >= need;
}

function markLockedControls(){
  document.querySelectorAll('[data-min-role]').forEach(el=>{
    const need = ((el.getAttribute('data-min-role') || el.getAttribute('data-minrole')) || 'manager');
    if(!hasRole(need)){
      el.classList.add('locked');
      el.setAttribute('title', 'Owner-only');
      // Ensure it can still be tapped/clicked to explain why
      el.style.pointerEvents = 'auto';
    }
  });
}
window.addEventListener('DOMContentLoaded', markLockedControls);

// Make "locked" controls still clickable (they show a helpful message instead of silently failing)
document.addEventListener('click', (e)=>{
  const el = e.target && e.target.closest ? e.target.closest('[data-min-role],[data-minrole]') : null;
  if(!el) return;
  const need = ((el.getAttribute('data-min-role') || el.getAttribute('data-minrole')) || 'manager');
  if(hasRole(need)) return;
  e.preventDefault();
  e.stopPropagation();
  const label = (el.textContent||'').trim() || 'This action';
  alert(label + ' is Owner-only.');
}, true);



// ===== Leads filters (simple + fast) =====
let leadTierFilter = "all";   // all | vip | regular
let leadEntryFilter = "all";  // all | <entry_point>

function norm(s){ return (s||"").toString().trim().toLowerCase(); }

function applyLeadFilters(){
  const rows = document.querySelectorAll('#leadsTable tbody tr');
  let shown = 0;
  rows.forEach(tr=>{
    const tier = norm(tr.getAttribute('data-tier')||"");
    const entry = norm(tr.getAttribute('data-entry')||"");
    const isVip = (tier === 'vip');

    let ok = true;
    if(leadTierFilter === "vip") ok = isVip;
    if(leadTierFilter === "regular") ok = !isVip;

    if(ok && leadEntryFilter !== "all"){
      ok = (entry === leadEntryFilter);
    }

    tr.style.display = ok ? "" : "none";
    if(ok) shown++;
  });

  const hint = qs('#leadsCount');
  if(hint) hint.textContent = shown + " shown";
}

function setupLeadFilters(){
  const tbl = qs('#leadsTable');
  if(!tbl) return;

  // Build entry dropdown
  const entries = new Set();
  document.querySelectorAll('#leadsTable tbody tr').forEach(tr=>{
    const ep = norm(tr.getAttribute('data-entry')||"");
    if(ep) entries.add(ep);
  });

  const sel = qs('#flt-entry');
  if(sel){
    sel.innerHTML = "";
    const all = document.createElement('option');
    all.value = "all"; all.textContent = "All";
    sel.appendChild(all);
    Array.from(entries).sort().forEach(ep=>{
      const o = document.createElement('option');
      o.value = ep; o.textContent = ep.replace(/_/g,' ');
      sel.appendChild(o);
    });
    sel.addEventListener('change', ()=>{
      leadEntryFilter = norm(sel.value||"all") || "all";
      applyLeadFilters();
    });
  }

  function setBtn(activeId){
    ['flt-all','flt-vip','flt-reg'].forEach(id=>{
      const b = qs('#'+id);
      if(!b) return;
      b.style.borderColor = (id===activeId) ? 'rgba(212,175,55,.65)' : 'rgba(255,255,255,.12)';
      b.style.background = (id===activeId) ? 'rgba(212,175,55,.12)' : 'rgba(255,255,255,.03)';
      b.style.color = (id===activeId) ? '#fff' : 'rgba(234,240,255,.92)';
    });
  }

  qs('#flt-all')?.addEventListener('click', ()=>{ leadTierFilter="all"; setBtn('flt-all'); applyLeadFilters(); });
  qs('#flt-vip')?.addEventListener('click', ()=>{ leadTierFilter="vip"; setBtn('flt-vip'); applyLeadFilters(); });
  qs('#flt-reg')?.addEventListener('click', ()=>{ leadTierFilter="regular"; setBtn('flt-reg'); applyLeadFilters(); });

  setBtn('flt-all');
  applyLeadFilters();
}


function qs(sel){return document.querySelector(sel);}
function qsa(sel){return Array.from(document.querySelectorAll(sel));}

qsa('.tabbtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    qsa('.tabbtn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const t = btn.dataset.tab;
    ['leads','ai','aiq','rules','menu','audit'].forEach(x=>{
      const pane = document.getElementById('tab-'+x);
      if(!pane) return;
      pane.classList.toggle('hidden', x!==t);
    });
if(t==='ai') loadAI();
    if(t==='aiq') loadAIQueue();
    if(t==='rules') loadRules();
    if(t==='menu') loadMenu();
    if(t==='audit') loadAudit();
  });
});

async function saveLead(sheetRow){
  const status = qs('#status-'+sheetRow).value;
  const vip = qs('#vip-'+sheetRow).value;
  const res = await fetch('/admin/update-lead?key='+encodeURIComponent(KEY), {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({row: sheetRow, status, vip})
  });
  const j = await res.json().catch(()=>{});
  if(j && j.ok) alert('Saved');
  else alert('Save failed: ' + (j.error||res.status));
}

async function markHandled(sheetRow){
  // Minimal: set status to Handled + write an audit entry.
  const res = await fetch('/admin/update-lead?key='+encodeURIComponent(KEY), {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({row: sheetRow, status: 'Handled'})
  });
  const j = await res.json().catch(()=>{});
  if(j && j.ok){
    const sel = qs('#status-'+sheetRow);
    if(sel) sel.value = 'Handled';
  } else {
    alert('Failed: ' + (j && j.error ? j.error : res.status));
  }
}

async function loadRules(){
  const msg = qs('#rules-msg'); if(msg) msg.textContent='';
  const res = await fetch('/admin/api/rules?key='+encodeURIComponent(KEY));
  const j = await res.json().catch(()=>null);
  if(!j || !j.ok){ if(msg) msg.textContent='Failed to load rules'; return; }
  const r = j.rules || {};
  qs('#rules-max-party').value = r.max_party_size || '';
  qs('#rules-banner').value = r.match_day_banner || '';
  qs('#rules-closed').value = (r.closed_dates||[]).join('\n');
  const h = r.hours || {};
  ['mon','tue','wed','thu','fri','sat','sun'].forEach(d=>{
    const el = qs('#h-'+d);
    if(el) el.value = (h[d]||'');
  });
}

async function saveRules(){
  const msg = qs('#rules-msg'); if(msg) msg.textContent='Saving...';
  const hours={};
  ['mon','tue','wed','thu','fri','sat','sun'].forEach(d=>hours[d]=qs('#h-'+d).value);
  const payload={
    max_party_size: parseInt(qs('#rules-max-party').value || '0', 10),
    match_day_banner: qs('#rules-banner').value || '',
    closed_dates: qs('#rules-closed').value || '',
    hours: hours
  };
  const res = await fetch('/admin/api/rules?key='+encodeURIComponent(KEY), {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  const j = await res.json().catch(()=>null);
  if(j && j.ok){
    if(msg) msg.textContent='Saved ‚úî';
    // Optional: normalize inputs from server (in case it clamps values)
    try{ await loadRules(); }catch(e){}
    setTimeout(()=>{ try{ if(msg) msg.textContent=''; }catch(e){} }, 1400);
  } else {
    if(msg) msg.textContent='Save failed';
    alert('Save failed: '+(j && j.error ? j.error : res.status));
  }
}


// ===============================
// Partner / Venue Policies (Hard)
// ===============================
async function loadPartnerList(){
  const msg = qs('#pp-msg'); if(msg) msg.textContent='Loading partners...';
  const box = qs('#pp-list'); if(box) box.textContent='';
  try{
    const res = await fetch('/admin/api/partner-policies/list?key='+encodeURIComponent(KEY));
    const j = await res.json().catch(()=>null);
    if(!j || !j.ok){ if(msg) msg.textContent='Failed'; return; }
    const partners = (j.partners||[]).filter(Boolean);
    if(box){
      box.innerHTML = partners.length
        ? ('<b>Known partners:</b> ' + partners.map(p=>'<code style="padding:2px 6px;border:1px solid rgba(255,255,255,.12);border-radius:10px">'+escapeHtml(p)+'</code>').join(' '))
        : 'No partner policies saved yet (only default).';
    }
    if(msg) msg.textContent='Loaded ‚úî';
  }catch(e){
    if(msg) msg.textContent='Error';
  }
}

function _getPartnerId(){
  const p = (qs('#pp-partner')?.value||'').trim();
  return p || 'default';
}

async function loadPartnerPolicy(){
  const msg = qs('#pp-msg'); if(msg) msg.textContent='Loading...';
  const partner = _getPartnerId();
  try{
    const res = await fetch('/admin/api/partner-policies?key='+encodeURIComponent(KEY)+'&partner='+encodeURIComponent(partner));
    const j = await res.json().catch(()=>null);
    if(!j || !j.ok){ if(msg) msg.textContent='Failed'; return; }
    const pol = j.policy || {};
    qs('#pp-vip-min').value = (pol.vip_min_budget ?? 0);
    qs('#pp-never-status').checked = !!pol.never_status_update;
    qs('#pp-allowed-statuses').value = Array.isArray(pol.allowed_statuses) ? pol.allowed_statuses.join(', ') : (pol.allowed_statuses||'');
    const oa = pol.outbound_allowed || {};
    const allowed = Object.keys(oa).filter(k=>oa[k]);
    qs('#pp-allowed-channels').value = allowed.join(', ');
    qs('#pp-outbound-role').value = (pol.outbound_require_role || 'manager');
    if(msg) msg.textContent='Loaded ‚úî';
  }catch(e){
    if(msg) msg.textContent='Error';
  }
}

async function savePartnerPolicy(){
  const msg = qs('#pp-msg'); if(msg) msg.textContent='Saving...';
  const partner = _getPartnerId();
  const vipMin = parseInt(qs('#pp-vip-min').value||'0',10) || 0;
  const neverStatus = !!qs('#pp-never-status').checked;
  const statusesRaw = (qs('#pp-allowed-statuses').value||'').trim();
  const statuses = statusesRaw ? statusesRaw.split(',').map(s=>s.trim()).filter(Boolean) : [];
  const chRaw = (qs('#pp-allowed-channels').value||'').trim();
  const ch = chRaw ? chRaw.split(',').map(s=>s.trim().toLowerCase()).filter(Boolean) : [];
  const outbound_allowed = { email:false, sms:false, whatsapp:false };
  ch.forEach(k=>{ if(Object.prototype.hasOwnProperty.call(outbound_allowed,k)) outbound_allowed[k]=true; });
  const outbound_role = (qs('#pp-outbound-role').value||'manager').trim() || 'manager';

  const payload = {
    partner: partner,
    policy: {
      vip_min_budget: vipMin,
      never_status_update: neverStatus,
      allowed_statuses: statuses.length ? statuses : undefined,
      outbound_allowed: outbound_allowed,
      outbound_require_role: outbound_role
    }
  };

  try{
    const res = await fetch('/admin/api/partner-policies/set?key='+encodeURIComponent(KEY), {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const j = await res.json().catch(()=>null);
    if(j && j.ok){
      if(msg) msg.textContent='Saved ‚úî';
      try{ await loadPartnerList(); }catch(e){}
    } else {
      if(msg) msg.textContent=(j && j.error) ? ('Blocked: '+j.error) : 'Failed';
    }
  }catch(e){
    if(msg) msg.textContent='Error';
  }
}

async function deletePartnerPolicy(){
  const msg = qs('#pp-msg'); if(msg) msg.textContent='Deleting...';
  const partner = _getPartnerId();
  try{
    const res = await fetch('/admin/api/partner-policies/delete?key='+encodeURIComponent(KEY), {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({partner: partner})
    });
    const j = await res.json().catch(()=>null);
    if(j && j.ok){
      if(msg) msg.textContent='Deleted ‚úî';
      try{ await loadPartnerList(); }catch(e){}
      if(partner !== 'default'){ qs('#pp-partner').value=''; }
      try{ await loadPartnerPolicy(); }catch(e){}
    } else {
      if(msg) msg.textContent=(j && j.error) ? ('Blocked: '+j.error) : 'Failed';
    }
  }catch(e){
    if(msg) msg.textContent='Error';
  }
}

async function loadAlerts(){
  try{
    qs('#al-msg').textContent = 'Loading‚Ä¶';
    const res = await fetch('/admin/api/alerts/settings?key='+encodeURIComponent(KEY));
    const j = await res.json().catch(()=>null);
    if(!j || !j.ok){ qs('#al-msg').textContent = 'Load failed: ' + ((j&&j.error)||res.status); return; }
    const s = j.settings || {};
    qs('#al-enabled').checked = !!s.enabled;
    qs('#al-rate').value = s.rate_limit_seconds ?? 600;
    const checks = s.checks || {};
    qs('#al-fixtures-stale').value = checks.fixtures_stale_seconds ?? 86400;

    const ch = s.channels || {};
    const slack = ch.slack || {};
    const email = ch.email || {};
    const sms = ch.sms || {};

    qs('#al-slack-en').checked = !!slack.enabled;
    qs('#al-slack-url').value = slack.webhook_url || '';

    qs('#al-email-en').checked = !!email.enabled;
    qs('#al-email-to').value = email.to || '';
    qs('#al-email-from').value = email.from || '';

    qs('#al-sms-en').checked = !!sms.enabled;
    qs('#al-sms-to').value = sms.to || '';

    qs('#al-msg').textContent = 'Loaded';
  }catch(e){
    qs('#al-msg').textContent = 'Load error';
  }
}

async function saveAlerts(){
  if(!hasRole('owner')){ qs('#al-msg').textContent = 'Owner only'; return; }
  try{
    qs('#al-msg').textContent = 'Saving‚Ä¶';
    const payload = {
      enabled: qs('#al-enabled').checked,
      rate_limit_seconds: parseInt(qs('#al-rate').value||'600',10),
      checks: { fixtures_stale_seconds: parseInt(qs('#al-fixtures-stale').value||'86400',10) },
      channels: {
        slack: { enabled: qs('#al-slack-en').checked, webhook_url: (qs('#al-slack-url').value||'').trim() },
        email: { enabled: qs('#al-email-en').checked, to: (qs('#al-email-to').value||'').trim(), from: (qs('#al-email-from').value||'').trim() },
        sms: { enabled: qs('#al-sms-en').checked, to: (qs('#al-sms-to').value||'').trim() }
      }
    };
    const res = await fetch('/admin/api/alerts/settings?key='+encodeURIComponent(KEY), {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const j = await res.json().catch(()=>null);
    if(!j || !j.ok){ qs('#al-msg').textContent = 'Save failed: ' + ((j&&j.error)||res.status); return; }
    qs('#al-msg').textContent = 'Saved';
  }catch(e){
    qs('#al-msg').textContent = 'Save error';
  }
}

async function testAlert(){
  if(!hasRole('owner')){ qs('#al-msg').textContent = 'Owner only'; return; }
  try{
    qs('#al-msg').textContent = 'Sending test‚Ä¶';
    const res = await fetch('/admin/api/alerts/test?key='+encodeURIComponent(KEY), { method:'POST' });
    const j = await res.json().catch(()=>null);
    if(!j || !j.ok){ qs('#al-msg').textContent = 'Test failed: ' + ((j&&j.error)||res.status); return; }
    qs('#al-msg').textContent = 'Test sent';
  }catch(e){
    qs('#al-msg').textContent = 'Test error';
  }
}

async function loadMenu(){
  const msg = qs('#menu-msg'); if(msg) msg.textContent='';
  const res = await fetch('/admin/api/menu?key='+encodeURIComponent(KEY));
  const j = await res.json().catch(()=>null);
  if(j && j.ok){
    qs('#menu-json').value = JSON.stringify(j.menu || {}, null, 2);
    if(msg) msg.textContent='Loaded ‚úî';
  } else {
    if(msg) msg.textContent='Failed to load';
  }
}

async function saveMenuJson(){
  const msg = qs('#menu-msg'); if(msg) msg.textContent='Saving...';
  let payload=null;
  try { payload = JSON.parse(qs('#menu-json').value || '{}'); } catch(e) {
    alert('Invalid JSON'); if(msg) msg.textContent='Invalid JSON'; return;
  }
  const res = await fetch('/admin/api/menu?key='+encodeURIComponent(KEY), {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  const j = await res.json().catch(()=>null);
  if(j && j.ok){ if(msg) msg.textContent='Saved ‚úî'; }
  else { if(msg) msg.textContent='Save failed'; alert('Save failed: '+(j && j.error ? j.error : res.status)); }
}

async function uploadMenu(){
  const msg = qs('#menu-msg'); if(msg) msg.textContent='Uploading...';
  const f = qs('#menu-file').files[0];
  if(!f){ alert('Choose a JSON file'); if(msg) msg.textContent='No file'; return; }
  const fd = new FormData();
  fd.append('file', f);
  const res = await fetch('/admin/api/menu-upload?key='+encodeURIComponent(KEY), {
    method:'POST',
    body: fd
  });
  const j = await res.json().catch(()=>null);
  if(j && j.ok){ qs('#menu-json').value = JSON.stringify(j.menu || {}, null, 2); if(msg) msg.textContent='Uploaded ‚úî'; }
  else { if(msg) msg.textContent='Upload failed'; alert('Upload failed: '+(j && j.error ? j.error : res.status)); }
}


function _ensureMiniState(el, idSuffix){
  try{
    if(!el) return null;
    const id = 'ops-mini-'+idSuffix;
    let s = document.getElementById(id);
    if(!s){
      s = document.createElement('span');
      s.id = id;
      s.className = 'miniState';
      // place right after the control
      const parent = el.parentElement;
      if(parent){
        parent.appendChild(s);
      } else {
        el.insertAdjacentElement('afterend', s);
      }
    }
    return s;
  }catch(e){ return null; }
}
function _setMiniState(el, idSuffix, text){
  const s = _ensureMiniState(el, idSuffix);
  if(s){ s.textContent = text || ''; s.style.opacity = text ? '1' : '0'; }
}
function _ensureOpsMeta(){
  let el = document.getElementById('ops-meta');
  if(!el){
    el = document.createElement('div');
    el.id = 'ops-meta';
    el.className = 'small';
    el.style.marginTop = '6px';
    // Prefer to place near ops message area if present
    const msg = qs('#ops-msg');
    if(msg && msg.parentElement){
      msg.parentElement.appendChild(el);
    } else {
      // fallback: add to ops card area
      (document.querySelector('#tab-leads') || document.body).appendChild(el);
    }
  }
  return el;
}
function _renderOpsMeta(meta){
  try{
    const el = _ensureOpsMeta();
    if(!meta || !meta.ts) { el.textContent = ''; return; }
    const who = (meta.role? meta.role.toUpperCase():'') + (meta.actor? ' ('+meta.actor+')':'');
    el.textContent = `Last updated: ${meta.ts} ${who}`;
  }catch(e){}
}

async function loadOps(){
  const msg = qs('#ops-msg'); if(msg) msg.textContent='Loading...';
  const res = await fetch('/admin/api/ops?key='+encodeURIComponent(KEY));
  const j = await res.json().catch(()=>null);
  if(!j || !j.ok){ if(msg) msg.textContent='Failed to load ops'; return; }
  try{ _renderOpsMeta(j.meta); }catch(e){}
  const o = j.ops || {};
  const pause = qs('#ops-pause'); if(pause) pause.checked = (o.pause_reservations===true || o.pause_reservations==='true');
  const vip = qs('#ops-viponly'); if(vip) vip.checked = (o.vip_only===true || o.vip_only==='true');
  const wl = qs('#ops-waitlist'); if(wl) wl.checked = (o.waitlist_mode===true || o.waitlist_mode==='true');
  if(msg) msg.textContent='';
}

async function saveOps(){
  const msg = qs('#ops-msg'); if(msg) msg.textContent='Saving...';
  const payload = {
    pause_reservations: !!(qs('#ops-pause') && qs('#ops-pause').checked),
    vip_only: !!(qs('#ops-viponly') && qs('#ops-viponly').checked),
    waitlist_mode: !!(qs('#ops-waitlist') && qs('#ops-waitlist').checked),
  };
    // Per-toggle micro feedback
  const elPause = qs('#ops-pause');
  const elVip   = qs('#ops-viponly');
  const elWait  = qs('#ops-waitlist');
  _setMiniState(elPause,'pause','Saving‚Ä¶');
  _setMiniState(elVip,'vip','Saving‚Ä¶');
  _setMiniState(elWait,'wait','Saving‚Ä¶');
  if(elPause) elPause.disabled = true;
  if(elVip) elVip.disabled = true;
  if(elWait) elWait.disabled = true;
  const res = await fetch('/admin/api/ops?key='+encodeURIComponent(KEY), {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  const j = await res.json().catch(()=>null);
  if(j && j.ok){ if(msg) msg.textContent='Saved ‚úî'; }
  else { if(msg) msg.textContent='Save failed'; alert('Save failed: '+(j && j.error ? j.error : res.status)); }
}



// ===== AI Automation =====
  // Re-enable toggles after save attempt
  try{
    if(elPause) elPause.disabled = false;
    if(elVip) elVip.disabled = false;
    if(elWait) elWait.disabled = false;
  }catch(e){}

async function loadAI(){
  const msg = qs('#ai-msg'); if(msg) msg.textContent = '';
  try{
    const r = await fetch(`/admin/api/ai/settings?key=${encodeURIComponent(KEY)}`, {cache:'no-store'});
    const data = await r.json();
    if(!data.ok) throw new Error(data.error || 'Failed');
    const s = data.settings || {};
    // runtime
    qs('#ai-enabled').checked = !!s.enabled;
    qs('#ai-mode').value = (s.mode || 'suggest');
    qs('#ai-approval').checked = !!s.require_approval;
    qs('#ai-minconf').value = (typeof s.min_confidence === 'number' ? s.min_confidence : 0.7);

    // owner
    const isOwner = (ROLE === 'owner');
    qs('#ai-model').value = (s.model || '');
    qs('#ai-prompt').value = (s.system_prompt || '');

    const allow = s.allow_actions || {};
    qs('#ai-act-vip').checked = !!allow.vip_tag;
    qs('#ai-act-status').checked = !!allow.status_update;
    qs('#ai-act-draft').checked = !!allow.reply_draft;

    const feat = s.features || {};
    if(qs('#ai-feat-vip')) qs('#ai-feat-vip').checked = (feat.auto_vip_tag !== false);
    if(qs('#ai-feat-status')) qs('#ai-feat-status').checked = !!feat.auto_status_update;
    if(qs('#ai-feat-draft')) qs('#ai-feat-draft').checked = (feat.auto_reply_draft !== false);

    // lock owner-only fields for managers
    ['ai-model','ai-prompt','ai-act-vip','ai-act-status','ai-act-draft'].forEach(id=>{
      const el = qs('#'+id); if(!el) return;
      el.disabled = !isOwner;
      el.style.opacity = isOwner ? '1' : '.55';
    });
  }catch(e){
    if(msg) msg.textContent = 'Load failed: ' + (e.message || e);
  }
}

async function saveAI(){
  const msg = qs('#ai-msg'); if(msg) msg.textContent = 'Saving‚Ä¶';
  const payload = {
    enabled: qs('#ai-enabled')?.checked ? true : false,
    mode: qs('#ai-mode')?.value || 'suggest',
    require_approval: qs('#ai-approval')?.checked ? true : false,
    min_confidence: parseFloat(qs('#ai-minconf')?.value || '0.7'),
  };

  // owner fields
  if(ROLE === 'owner'){
    payload.model = (qs('#ai-model')?.value || '').trim();
    payload.system_prompt = (qs('#ai-prompt')?.value || '').trim();
    payload.allow_actions = {
      vip_tag: qs('#ai-act-vip')?.checked ? true : false,
      status_update: qs('#ai-act-status')?.checked ? true : false,
      reply_draft: qs('#ai-act-draft')?.checked ? true : false,
    };
  }

  try{
    const r = await fetch(`/admin/api/ai/settings?key=${encodeURIComponent(KEY)}`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await r.json();
    if(!data.ok) throw new Error(data.error || 'Failed');
    if(msg) msg.textContent = 'Saved ‚úî';
    // refresh to reflect merged settings
    loadAI();
  }catch(e){
    if(msg) msg.textContent = 'Save failed: ' + (e.message || e);
  }
}
async function applyPreset(name){
  const msg = qs('#preset-msg'); if(msg) msg.textContent='Applying "'+name+'" ...';
  const res = await fetch('/admin/api/presets/apply?key='+encodeURIComponent(KEY), {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({name})
  });
  const j = await res.json().catch(()=>null);
  if(j && j.ok){
    if(msg) msg.textContent='Applied ‚úî (logged)';
    await loadOps();
    // If you are owner and preset touched rules, refresh rules form for visibility.
    if(j.rules) await loadRules();
  } else {
    if(msg) msg.textContent='Apply failed';
    alert('Preset failed: '+(j && j.error ? j.error : res.status));
  }
}


// ===== AI Approval Queue =====
async function loadAIQueue(){
  const msg = qs('#aiq-msg'); if(msg) msg.textContent = 'Loading‚Ä¶';
  const list = qs('#aiq-list'); if(list) list.innerHTML = 'Loading‚Ä¶';
  try{
    const filt = (qs('#aiq-filter')?.value || '').trim();
    const url = `/admin/api/ai/queue?key=${encodeURIComponent(KEY)}` + (filt ? `&status=${encodeURIComponent(filt)}` : '');
    const r = await fetch(url, {cache:'no-store'});
    const data = await r.json();
    if(!data.ok) throw new Error(data.error || 'Failed');
    const q = data.queue || [];
    renderAIQueue(q);
    if(msg) msg.textContent = q.length ? (`${q.length} item(s)`) : 'No items';
  }catch(e){
    if(msg) msg.textContent = 'Load failed: ' + (e.message || e);
    if(list) list.textContent = 'Failed to load queue.';
  }
}

async function runAINew(){
  const msg = qs('#aiq-msg'); if(msg) msg.textContent = 'Running AI‚Ä¶';
  const lim = parseInt(qs('#ai-run-limit')?.value || '5', 10);
  try{
    const r = await fetch(`/admin/api/ai/run?key=${encodeURIComponent(KEY)}`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({mode:'new', limit: isNaN(lim)?5:lim})
    });
    const data = await r.json();
    if(!data.ok) throw new Error(data.error || 'Failed');
    if(msg) msg.textContent = `Ran ${data.ran||0}. Proposed ${data.proposed||0}.`;
    await loadAIQueue();
  }catch(e){
    if(msg) msg.textContent = 'Run failed: ' + (e.message || e);
  }
}

async function runAIRow(){
  const msg = qs('#aiq-msg'); if(msg) msg.textContent = 'Running AI‚Ä¶';
  const row = parseInt(qs('#ai-run-row')?.value || '0', 10);
  if(!row || row < 2){
    if(msg) msg.textContent = 'Enter a valid sheet Row # (>= 2).';
    return;
  }
  try{
    const r = await fetch(`/admin/api/ai/run?key=${encodeURIComponent(KEY)}`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({row})
    });
    const data = await r.json();
    if(!data.ok) throw new Error(data.error || 'Failed');
    if(msg) msg.textContent = `Row ${row}: Proposed ${data.proposed||0}.`;
    await loadAIQueue();
  }catch(e){
    if(msg) msg.textContent = 'Run failed: ' + (e.message || e);
  }
}


function esc(s){ return (s||'').toString().replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

function renderAIQueue(items){
  const list = qs('#aiq-list');
  if(!list) return;

  // Explicit empty state for CI tests + clarity
  if(!items || !items.length){
    list.innerHTML = '<div class="note">AI Queue empty ‚Äî no queued actions.</div>';
    return;
  }

  const rows = (items || []).map((it)=>{
    const id = esc(it.id || '');
    const typ = esc(it.type || '');
    const st  = esc(it.status || '');
    const conf = (typeof it.confidence === 'number') ? it.confidence.toFixed(2) : '';
    const when = esc(it.created_at || '');
    const why  = esc(it.why || it.reason || '');
    const payload = esc(JSON.stringify(it.payload || {}));

    const canAct = (st === 'pending');

    const approveBtn = `<button type="button" class="btn" ${canAct ? '' : 'disabled'} onclick="aiqApprove('${id}', this)">Approve</button>`;
    const denyBtn    = `<button type="button" class="btn2" ${canAct ? '' : 'disabled'} onclick="aiqDeny('${id}', this)">Deny</button>`;
    const overrideBtn = `<button type="button" class="btn" onclick="aiqOverride('${id}', this)">Owner Override</button>`;

    return `
      <div class="card" style="margin-bottom:10px">
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center">
          <div>
            <b>${typ || 'AI item'}</b>
            <span class="chip" style="margin-left:8px">${st || 'unknown'}</span>
            ${conf ? `<span class="note" style="margin-left:8px">conf ${conf}</span>` : ``}
          </div>
          <div class="note">${when}</div>
        </div>
        ${why ? `<div class="small" style="margin-top:8px;opacity:.9">${why}</div>` : ``}
        <details style="margin-top:8px">
          <summary class="small">Payload</summary>
          <pre class="small" style="white-space:pre-wrap;opacity:.9">${payload}</pre>
        </details>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
          ${approveBtn}
          ${denyBtn}
          ${overrideBtn}
        </div>
      </div>
    `;
  });

  list.innerHTML = rows.join('');
}

async function aiqApprove(id, btn){
  if(!confirm('Approve this action?')) return;
  // Button-level loading state
  const _btn = btn;
  if(_btn){ _btn.disabled = true; _btn.dataset.prevText = _btn.textContent || ''; _btn.textContent = 'Approving‚Ä¶'; }

  const msg = qs('#aiq-msg'); if(msg) msg.textContent = 'Approving‚Ä¶';
  const r = await fetch(`/admin/api/ai/queue/${encodeURIComponent(id)}/approve?key=${encodeURIComponent(KEY)}`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({})
  });
  const j = await r.json().catch(()=>null);
  if(j && j.ok){ if(msg) msg.textContent='Approved ‚úî'; if(_btn){ _btn.disabled = false; _btn.textContent = (_btn.dataset.prevText || 'Approve'); } await loadAIQueue(); }
  else { if(msg) msg.textContent='Approve failed'; if(_btn){ _btn.disabled = false; _btn.textContent = (_btn.dataset.prevText || 'Approve'); } alert('Approve failed: '+(j && j.error ? j.error : r.status)); }
}


async function aiqSend(id, btn){
  if(!confirm('Send this outbound message now?')) return;
  const _btn = btn;
  if(_btn){ _btn.disabled = true; _btn.dataset.prevText = _btn.textContent || ''; _btn.textContent = 'Sending‚Ä¶'; }
  const msg = qs('#aiq-msg'); if(msg) msg.textContent = 'Sending‚Ä¶';
  const r = await fetch(`/admin/api/ai/queue/${encodeURIComponent(id)}/send?key=${encodeURIComponent(KEY)}`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({})
  });
  const j = await r.json().catch(()=>null);
  if(j && j.ok){
    if(msg) msg.textContent='Sent ‚úî';
    if(_btn){ _btn.disabled=false; _btn.textContent=(_btn.dataset.prevText || 'Send'); }
    await loadAIQueue();
  }else{
    if(msg) msg.textContent='Send failed';
    if(_btn){ _btn.disabled=false; _btn.textContent=(_btn.dataset.prevText || 'Send'); }
    alert('Send failed: '+(j && j.error ? j.error : r.status));
  }
}

async function aiqDeny(id, btn){
  if(!confirm('Deny this action?')) return;
  const _btn = btn;
  if(_btn){ _btn.disabled = true; _btn.dataset.prevText = _btn.textContent || ''; _btn.textContent = 'Denying‚Ä¶'; }

  const msg = qs('#aiq-msg'); if(msg) msg.textContent = 'Denying‚Ä¶';
  const r = await fetch(`/admin/api/ai/queue/${encodeURIComponent(id)}/deny?key=${encodeURIComponent(KEY)}`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({})
  });
  const j = await r.json().catch(()=>null);
  if(j && j.ok){ if(msg) msg.textContent='Denied ‚úî'; if(_btn){ _btn.disabled = false; _btn.textContent = (_btn.dataset.prevText || 'Deny'); } await loadAIQueue(); }
  else { if(msg) msg.textContent='Deny failed'; if(_btn){ _btn.disabled = false; _btn.textContent = (_btn.dataset.prevText || 'Deny'); } alert('Deny failed: '+(j && j.error ? j.error : r.status)); }
}

async function aiqOverride(id, btn){
  if(typeof hasRole === 'function' && !hasRole('owner')){
    alert('Owner-only: override is locked for managers.');
    return;
  }
  const _btn = btn;
  if(_btn){ _btn.disabled = true; _btn.dataset.prevText = _btn.textContent || ''; _btn.textContent = 'Overriding‚Ä¶'; }

  // Owner-only: allow quick edit of payload/type before applying
  const typ = prompt('Override action type (vip_tag, status_update, reply_draft):', 'vip_tag');
  if(!typ){ if(_btn){ _btn.disabled=false; _btn.textContent=(_btn.dataset.prevText || 'Owner Override'); } return; }
  let payloadTxt = prompt('Override payload JSON (must be valid JSON object):', '{"row":2,"vip":"VIP"}');
  if(payloadTxt === null){ if(_btn){ _btn.disabled=false; _btn.textContent=(_btn.dataset.prevText || 'Owner Override'); } return; }
  payloadTxt = payloadTxt.trim();
  let payloadObj = null;
  try{ payloadObj = JSON.parse(payloadTxt); }catch(e){ if(_btn){ _btn.disabled=false; _btn.textContent=(_btn.dataset.prevText || 'Owner Override'); } alert('Invalid JSON'); return; }
  const msg = qs('#aiq-msg'); if(msg) msg.textContent = 'Applying override‚Ä¶';
  const r = await fetch(`/admin/api/ai/queue/${encodeURIComponent(id)}/override?key=${encodeURIComponent(KEY)}`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({type: typ, payload: payloadObj})
  });
  const j = await r.json().catch(()=>null);
  if(j && j.ok){ if(msg) msg.textContent='Override applied ‚úî'; if(_btn){ _btn.disabled=false; _btn.textContent=(_btn.dataset.prevText || 'Owner Override'); } await loadAIQueue(); }
  else { if(msg) msg.textContent='Override failed'; if(_btn){ _btn.disabled=false; _btn.textContent=(_btn.dataset.prevText || 'Owner Override'); } alert('Override failed: '+(j && j.error ? j.error : r.status)); }
}


function esc(s){
  return (s==null?'':String(s))
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#39;");
}

async function loadAudit(){
  const msg = qs('#audit-msg'); if(msg) msg.textContent='Loading...';
  const lim = parseInt((qs('#audit-limit') && qs('#audit-limit').value) || '200', 10) || 200;
  const filterEl = qs('#audit-filter');
  const selected = (filterEl && filterEl.value) ? filterEl.value : 'all';

  const url = '/admin/api/audit?key='+encodeURIComponent(KEY)+'&limit='+encodeURIComponent(lim);
  const res = await fetch(url, {cache:'no-store'});
  const j = await res.json().catch(()=>null);
  if(!j || !j.ok){ if(msg) msg.textContent='Failed to load audit'; return; }

  let entries = (j.entries || j.items || []);
  // Normalize older shapes if any
  entries = entries.map(e=>{
    if(e && (e.event || e.ts)) return e;
    return {
      ts: e.ts || e.time || '',
      event: e.action || e.event || '',
      role: e.role || '',
      actor: e.actor || '',
      details: e.details || e.meta || {}
    };
  });

  // Newest first
  entries.sort((a,b)=> String(b.ts||'').localeCompare(String(a.ts||'')));

  // Populate filter options (event types)
  if(filterEl){
    const keep = filterEl.value || 'all';
    const events = Array.from(new Set(entries.map(e=>String(e.event||'').trim()).filter(Boolean))).sort();
    let html = '<option value="all">All events</option>';
    events.forEach(ev=>{ html += '<option value="'+esc(ev)+'">'+esc(ev)+'</option>'; });
    filterEl.innerHTML = html;
    filterEl.value = (events.includes(keep) ? keep : 'all');
    filterEl.onchange = ()=>loadAudit();
  }

  const activeFilter = (filterEl && filterEl.value) ? filterEl.value : selected;

  const body = qs('#audit-body');
  if(body){
    body.innerHTML = '';
    const shown = entries.filter(e=> activeFilter==='all' ? true : String(e.event||'')===String(activeFilter));
    if(!shown.length){
      body.innerHTML = '<tr><td colspan="6"><span class="note">No audit entries.</span></td></tr>';
    } else {
      shown.forEach(e=>{
        const details = (e.details || {});
        const copyPayload = JSON.stringify(e, null, 2);
        const tr = document.createElement('tr');
        tr.innerHTML =
          '<td>'+esc(e.ts||'')+'</td>'
          +'<td><span class="code">'+esc(e.actor||'')+'</span></td>'
          +'<td>'+esc(e.role||'')+'</td>'
          +'<td>'+esc(e.event||'')+'</td>'
          +'<td><span class="code">'+esc(JSON.stringify(details))+'</span></td>'
          +'<td><button class="btn2" type="button">Copy</button></td>';
        const btn = tr.querySelector('button');
        if(btn){
          btn.addEventListener('click', async ()=>{
            try{
              if(navigator && navigator.clipboard && navigator.clipboard.writeText){
                await navigator.clipboard.writeText(copyPayload);
              } else {
                const ta = document.createElement('textarea');
                ta.value = copyPayload;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                ta.remove();
              }
              if(msg){ msg.textContent = 'Copied'; setTimeout(()=>{ if(msg) msg.textContent=''; }, 800); }
            }catch(_){
              if(msg){ msg.textContent = 'Copy failed'; setTimeout(()=>{ if(msg) msg.textContent=''; }, 1200); }
            }
          });
        }
        body.appendChild(tr);
      });
    }
  }
  if(msg) msg.textContent='';
}



async function loadNotifs(){
  const msg = qs('#notif-msg'); 
  if(msg) msg.textContent = 'Loading‚Ä¶';

  try{
    const r = await fetch(`/admin/api/notifications?limit=50&key=${encodeURIComponent(KEY||'')}`, { cache:'no-store' });
    const j = await r.json().catch(()=>null);
    const items = (j && j.items) ? (j.items || []) : [];

    // update badge
    const c = document.querySelector('#notifCount');
    if(c) c.textContent = String(items.length || 0);

    const body = document.querySelector('#notifBody');
    if(body){
      body.innerHTML = '';

      if(!items.length){
        body.innerHTML = '<div class="note">No notifications.</div>';
      } else {
        items.forEach(it=>{
          const d = it.details || {};
          const row = document.createElement('div');

          row.style.cssText =
            'padding:10px;border:1px solid rgba(255,255,255,16);border-radius:14px;margin-bottom:10px;background:rgba(255,255,255,06)';

          const text =
            d.message ||
            d.title ||
            d.details ||
            (typeof d === 'string' ? d : JSON.stringify(d));

          row.innerHTML =
            '<div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center">' +
              '<div class="note">'+esc(it.ts || '')+'</div>' +
              '<div><span class="code">'+esc(it.event || '')+'</span></div>' +
            '</div>' +
            '<div class="small" style="margin-top:6px;opacity:.90;word-break:break-word">' +
              esc(text) +
            '</div>';

          body.appendChild(row);
        });
      }
    }

    if(msg) msg.textContent = '';
  }catch(e){
    if(msg) msg.textContent = 'Load failed';
  }
}

/* =========================
   Fan Zone Admin UI
   ========================= */

async function initFanZoneAdmin(){
  const root = document.querySelector('#fanzoneAdminRoot');
  if(!root) return;

  if(!root.dataset.built){
    root.dataset.built = "1";
    root.innerHTML = `
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px">
        <button class="btn2" type="button" id="fzLoadBtn">Load</button>
        <button class="btn" type="button" id="fzSaveBtn">Save</button>
        <span class="note" id="fzMsg"></span>
      </div>
      <textarea id="fzJson" class="inp"
        style="width:100%;min-height:220px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;">
      </textarea>
      <div class="small" style="opacity:.7;margin-top:8px">Edit JSON then Save.</div>
    `;

    document.querySelector('#fzLoadBtn')?.addEventListener('click', loadFanZoneState);
    document.querySelector('#fzSaveBtn')?.addEventListener('click', saveFanZoneState);
  }

  await loadFanZoneState();
}

async function loadFanZoneState(){
  const msg = document.querySelector('#fzMsg');
  const ta  = document.querySelector('#fzJson');
  if(msg) msg.textContent = 'Loading‚Ä¶';
  try{
    const r = await fetch(`/admin/api/fanzone/state?key=${encodeURIComponent(KEY||'')}`, {cache:'no-store'});
    const j = await r.json().catch(()=>null);
    if(!j || !j.ok) throw new Error('Load failed');
    if(ta) ta.value = JSON.stringify(j.state || {}, null, 2);
    if(msg) msg.textContent = 'Loaded ‚úì';
  }catch(e){
    if(msg) msg.textContent = 'Load failed';
  }
}

async function saveFanZoneState(){
  const msg = document.querySelector('#fzMsg');
  const ta  = document.querySelector('#fzJson');
  if(msg) msg.textContent = 'Saving‚Ä¶';
  try{
    const payload = JSON.parse((ta && ta.value) ? ta.value : '{}');
    const r = await fetch(`/admin/api/fanzone/save?key=${encodeURIComponent(KEY||'')}`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const j = await r.json().catch(()=>null);
    if(!j || !j.ok) throw new Error('Save failed');
    if(msg) msg.textContent = 'Saved ‚úì';
  }catch(e){
    if(msg) msg.textContent = 'Save failed (bad JSON?)';
  }
}

    if(msg) msg.textContent = '';
  }catch(e){
    if(msg) msg.textContent = 'Load failed';
  }
}

async function clearNotifs(){
  const msg = qs('#notif-msg'); if(msg) msg.textContent='Clearing‚Ä¶';
  try{
    const r = await fetch(`/admin/api/notifications/clear?key=${encodeURIComponent(KEY||'')}`, {method:'POST'});
    const j = await r.json();
    if(j.ok){
      if(msg) msg.textContent='Cleared';
      loadNotifs();
    }else{
      if(msg) msg.textContent='Error';
    }
  }catch(e){
    if(msg) msg.textContent='Error';
  }
}

window.showTab = function(tab){
  try{
    document.querySelectorAll('.tabbtn').forEach(b=>b.classList.toggle('active', b.getAttribute('data-tab')===tab));
    document.querySelectorAll('.tabpane').forEach(p=>p.classList.add('hidden'));
    const pane = document.querySelector('#tab-'+tab);
    if(pane) pane.classList.remove('hidden');

    if(tab === 'rules'){
      try{ loadPartnerList(); loadPartnerPolicy(); }catch(e){}
      try{ loadRules(); }catch(e){}
    }

    if(tab === 'fanzone'){
      try{ initFanZoneAdmin(); }catch(e){}
    }

    try{ history.replaceState(null,'','#'+tab); }catch(e){}
  }catch(e){}
};
function setupTabs(){
  const btns = Array.from(document.querySelectorAll('.tabbtn'));
  const panes = Array.from(document.querySelectorAll('.tabpane'));
  if(!btns.length || !panes.length) return;

  function show(tab){
    btns.forEach(b=>b.classList.toggle('active', b.getAttribute('data-tab')===tab));
    panes.forEach(p=>p.classList.add('hidden'));
    const pane = document.querySelector('#tab-'+tab);
    if(pane) pane.classList.remove('hidden');
    // keep URL hash for deep-linking
    try{ history.replaceState(null, '', '#'+tab); }catch(e){}
  }

  btns.forEach(b=>{
    b.addEventListener('click', (e)=>{
      e.preventDefault();
      const tab = b.getAttribute('data-tab');
      if(tab) show(tab);
    });
  });

  // Make inline onclick handlers use the same implementation
  window.showTab = show;

  // open tab from URL hash if present, otherwise default to Ops
  const initial = (location.hash||'').replace('#','').trim();
  if(initial && document.querySelector('.tabbtn[data-tab="'+initial+'"]')) {
    show(initial);
  } else {
    show('ops');
  }

  // keep in sync if hash changes
  window.addEventListener('hashchange', ()=>{
    const t = (location.hash||'').replace('#','').trim();
    if(t && document.querySelector('.tabbtn[data-tab="'+t+'"]')) show(t);
  });
}
function openNotifications(){
  try{
    showTab('ops');
    setTimeout(()=>{ document.querySelector('#notifCard')?.scrollIntoView({behavior:'smooth', block:'start'}); }, 60);
    loadNotifs();
  }catch(e){}
}
// Poll notifications lightly
setInterval(()=>{ try{ loadNotifs(); }catch(e){} }, 15000);


// --- Refresh controls (visual-only; calls existing loaders safely) ---
let __autoTimer = null;

function _nowHHMMSS(){
  const d=new Date();
  const p=n=>String(n).padStart(2,'0');
  return `${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;
}
function updateLastRef(){
  const el=document.getElementById('lastRef');
  if(el) el.textContent = `Last refresh: ${_nowHHMMSS()}`;
}

function refreshAll(source){
  try{ loadNotifs(); }catch(e){}
  try{ loadOps(); }catch(e){}
  try{ loadAI(); }catch(e){}
  try{ loadAIQueue(); }catch(e){}
  // These are safe even if you're not on the tab; they just fetch current configs
  try{ loadRules(); }catch(e){}
  try{ loadMenu(); }catch(e){}
  try{ loadHealth(); }catch(e){}
  updateLastRef();
}

async function loadHealth(){
  const msg = qs('#health-msg'); if(msg) msg.textContent='Loading‚Ä¶';
  const body = qs('#health-body'); if(body) body.textContent='';
  try{
    const r = await fetch(`/admin/api/health?key=${encodeURIComponent(KEY)}`, {cache:'no-store'});
    const j = await r.json();
    if(!j.ok) throw new Error(j.error||'Failed');
    const rep = j.report || {};
    if(msg) {
      const last = (j.alerts_last_any_ts||'').trim();
      const lastTxt = last ? (' ¬∑ last alert ' + last.replace('T',' ').replace('Z','')) : ' ¬∑ last alert never';
      msg.textContent = (rep.status||'ok').toUpperCase() + (j.alerts_enabled ? ' ¬∑ alerts ON' : ' ¬∑ alerts OFF') + lastTxt;
    }
    const ts = qs('#health-ts'); if(ts) ts.textContent = rep.ts ? ('Updated '+rep.ts) : '';
    if(body){
      const lines = (rep.checks||[]).map(c=>{
        const badge = c.ok ? '‚úÖ' : (c.severity==='error' ? 'üö®' : '‚ö†Ô∏è');
        return `${badge} ${c.name}: ${c.message||''}`;
      });
      body.textContent = lines.join('\n');
    }
  }catch(e){
    if(msg) msg.textContent='Load failed: '+(e.message||e);
    if(body) body.textContent='Unable to load health report.';
  }
}

async function runHealth(){
  const msg = qs('#health-msg'); if(msg) msg.textContent='Running‚Ä¶';
  const body = qs('#health-body'); if(body) body.textContent='';
  try{
    const r = await fetch(`/admin/api/health/run?key=${encodeURIComponent(KEY)}`, {method:'POST'});
    const j = await r.json();
    if(!j.ok) throw new Error(j.error||'Failed');
    const rep = j.report || {};
    if(msg){
      const last = (j.alerts_last_any_ts||'').trim();
      const lastTxt = last ? (' ¬∑ last alert ' + last.replace('T',' ').replace('Z','')) : ' ¬∑ last alert never';
      msg.textContent = (rep.status||'ok').toUpperCase() + ' ¬∑ checked' + lastTxt;
    }
    const ts = qs('#health-ts'); if(ts) ts.textContent = rep.ts ? ('Updated '+rep.ts) : '';
    if(body){
      const lines = (rep.checks||[]).map(c=>{
        const badge = c.ok ? '‚úÖ' : (c.severity==='error' ? 'üö®' : '‚ö†Ô∏è');
        return `${badge} ${c.name}: ${c.message||''}`;
      });
      body.textContent = lines.join('\n');
    }
    // also refresh notifications (alerts may have been emitted)
    try{ loadNotifs(); }catch(e){}
  }catch(e){
    if(msg) msg.textContent='Run failed: '+(e.message||e);
    if(body) body.textContent='Unable to run health checks.';
  }
}



function _setAutoLabel(on){
  const lab=document.getElementById('autoLabel');
  if(lab) lab.textContent = on ? "Auto: On" : "Auto: Off";
}

function _getAutoEvery(){
  const sel=document.getElementById('autoEvery');
  const v = sel ? parseInt(sel.value||"30",10) : 30;
  return (isFinite(v) && v>0) ? v : 30;
}

function startAutoRefresh(){
  stopAutoRefresh();
  const every=_getAutoEvery();
  __autoTimer = setInterval(()=>{ refreshAll('auto'); }, every*1000);
  localStorage.setItem('wc_auto_refresh','1');
  localStorage.setItem('wc_auto_refresh_every', String(every));
  _setAutoLabel(true);
}

function stopAutoRefresh(){
  if(__autoTimer){ try{ clearInterval(__autoTimer); }catch(e){} }
  __autoTimer=null;
  localStorage.setItem('wc_auto_refresh','0');
  _setAutoLabel(false);
}

function toggleAutoRefresh(){
  if(__autoTimer) stopAutoRefresh();
  else startAutoRefresh();
}

function autoEveryChanged(){
  const every=_getAutoEvery();
  localStorage.setItem('wc_auto_refresh_every', String(every));
  if(__autoTimer) startAutoRefresh(); // restart with new interval
}

function _initRefreshControls(){
  // restore interval
  const savedEvery = parseInt(localStorage.getItem('wc_auto_refresh_every')||"30",10);
  const sel=document.getElementById('autoEvery');
  if(sel && isFinite(savedEvery)) sel.value = String(savedEvery);
  // set initial last refresh time
  updateLastRef();
  // restore auto state
  const on = (localStorage.getItem('wc_auto_refresh')||"0") === "1";
  if(on) startAutoRefresh();
  else _setAutoLabel(false);
}

document.addEventListener('DOMContentLoaded', ()=>{
  
  try{ installClickUnblocker(); }catch(e){}
try{ setupTabs(); }catch(e){}
  if(tab === 'fanzone'){
  try{ initFanZoneAdmin(); }catch(e){}
}
  try{ markLockedControls(); }catch(e){}
  try{ setupLeadFilters(); }catch(e){}
  try{ loadNotifs(); }catch(e){}
  try{ _initRefreshControls(); }catch(e){}
  try{ refreshAll('boot'); }catch(e){}
});
</script>
</div></body></html>