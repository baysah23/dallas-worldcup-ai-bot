<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dallas World Cup 2026 Concierge</title>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#070a12; color:#e8e8e8; height:100vh; }
    .wrap { max-width: 1050px; margin: 0 auto; height:100vh; display:flex; flex-direction:column; }

    header {
      background: radial-gradient(1200px 450px at 20% 10%, rgba(46,160,67,0.25), transparent 60%),
                  radial-gradient(900px 450px at 85% 0%, rgba(31,111,235,0.25), transparent 55%),
                  #0c1020;
      border-bottom: 1px solid rgba(255,255,255,0.09);
      padding: 18px 18px 14px;
    }
    .toprow { display:flex; align-items:flex-start; justify-content:space-between; gap:12px; }
    .brand h1 { margin:0; font-size:18px; letter-spacing:0.4px; }
    .brand p { margin:6px 0 0; font-size:12px; color:#b9c0d4; line-height:1.35; }

    .badges { display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .badge {
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
      color:#d7def4;
    }
    .badge strong { color:#fff; }

    .toolbar {
      margin-top: 12px;
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    }
    .btn {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.14);
      color:#fff;
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 13px;
      cursor:pointer;
    }
    .btn.primary { background:#1f6feb; border-color:#1f6feb; }
    .btn.green { background:#2ea043; border-color:#2ea043; }
    .btn:disabled { opacity:0.6; cursor:not-allowed; }

    .grid {
      display:grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 14px;
      padding: 14px 18px;
      flex:1;
      overflow:hidden;
    }

    /* Chat area */
    .card {
      border:1px solid rgba(255,255,255,0.09);
      background: rgba(255,255,255,0.03);
      border-radius: 16px;
      overflow:hidden;
      display:flex; flex-direction:column;
      min-height: 0;
    }
    .cardHead {
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      display:flex; justify-content:space-between; align-items:center;
      gap:10px;
    }
    .cardHead .title { font-weight: 800; font-size: 13px; color:#fff; }
    .cardHead .sub { font-size:12px; color:#b9c0d4; }

    #chat { padding: 14px; overflow-y:auto; flex:1; display:flex; flex-direction:column; gap:10px; }
    .bubble { max-width: 78%; padding: 10px 12px; border-radius: 12px; white-space:pre-wrap; word-wrap:break-word; border:1px solid rgba(255,255,255,0.08); }
    .user { align-self:flex-end; background:#1f6feb; color:#fff; border-bottom-right-radius:4px; }
    .bot { align-self:flex-start; background:#121a33; color:#e8e8e8; border-bottom-left-radius:4px; }

    .composer { display:flex; gap:10px; padding: 12px; border-top: 1px solid rgba(255,255,255,0.08); background: rgba(0,0,0,0.12); }
    textarea {
      flex:1; height:44px; max-height:140px; resize:none;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,0.12);
      background:#070a12;
      color:#fff;
      padding: 10px 12px;
      font-size: 14px;
      outline:none;
    }

    /* Right panel */
    .panel { display:flex; flex-direction:column; gap:14px; min-height:0; }
    .mini { padding: 12px; }
    .mini h3 { margin:0 0 8px; font-size: 13px; }
    .muted { color:#b9c0d4; font-size: 12px; line-height:1.35; }
    .divider { height:1px; background: rgba(255,255,255,0.08); margin: 10px 0; }

    .matchBanner {
      display:none;
      padding: 10px 12px;
      background: rgba(46,160,67,0.16);
      border: 1px solid rgba(46,160,67,0.35);
      border-radius: 12px;
      color:#eaffef;
      font-size: 13px;
      font-weight:700;
    }

    .countdown {
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top: 6px;
    }
    .tile {
      min-width: 78px;
      padding: 10px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      text-align:center;
    }
    .tile .num { font-size: 18px; font-weight: 900; }
    .tile .lbl { font-size: 11px; color:#b9c0d4; margin-top: 2px; }

    .matches { overflow:auto; max-height: 320px; border-radius: 12px; border:1px solid rgba(255,255,255,0.10); }
    .matchRow {
      display:flex; gap:10px; justify-content:space-between;
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.07);
      font-size: 12px;
    }
    .matchRow:last-child { border-bottom:none; }
    .matchRow .left { display:flex; flex-direction:column; gap:2px; }
    .matchRow .right { text-align:right; color:#b9c0d4; min-width: 110px; }
    .tag {
      display:inline-block;
      font-size: 11px;
      padding: 2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.12);
      color:#d7def4;
      background: rgba(255,255,255,0.04);
      width: fit-content;
    }
    .next {
      background: rgba(255,215,0,0.14);
      border-color: rgba(255,215,0,0.35);
    }

    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="toprow">
        <div class="brand">
          <h1>‚öΩ Dallas World Cup 2026 Concierge</h1>
          <p>World Cup‚Äìstyle match-day booking + questions, built for Dallas-area fans and venues. <br/>
            Speak in multiple languages ‚Äî use the buttons below or just type normally.
          </p>
        </div>

        <div class="badges">
          <div class="badge"><strong>Languages:</strong> English ‚Ä¢ Espa√±ol ‚Ä¢ Portugu√™s ‚Ä¢ Fran√ßais</div>
          <div class="badge"><strong>Dallas:</strong> AT&amp;T Stadium (Arlington)</div>
        </div>
      </div>

      <div class="toolbar">
        <button class="btn primary" onclick="setLanguage('en')">English</button>
        <button class="btn primary" onclick="setLanguage('es')">Espa√±ol</button>
        <button class="btn primary" onclick="setLanguage('pt')">Portugu√™s</button>
        <button class="btn primary" onclick="setLanguage('fr')">Fran√ßais</button>

        <button class="btn green" onclick="recallReservation()">Recall reservation so far</button>
        <span class="muted" id="langStatus">Language: auto</span>
      </div>
    </header>

    <div class="grid">
      <!-- Left: Chat -->
      <div class="card">
        <div class="cardHead">
          <div>
            <div class="title">Chat</div>
            <div class="sub">Ask about hours, address, specials ‚Äî or book a reservation.</div>
          </div>
          <div class="muted" id="rateHint"></div>
        </div>

        <div id="chat"></div>

        <div class="composer">
          <textarea id="msg" placeholder="Type your message... (Enter to send, Shift+Enter for new line)"></textarea>
          <button class="btn green" id="sendBtn" onclick="sendMessage()">Send</button>
        </div>
      </div>

      <!-- Right: Widgets -->
      <div class="panel">

        <div class="matchBanner" id="matchBanner">
          üéâ Match-day mode: Opening at <span id="matchOpenTime">11:00</span> on match days.
        </div>

        <div class="card mini">
          <h3>World Cup Countdown</h3>
          <div class="muted">Countdown uses your device‚Äôs local time (safe).</div>
          <div class="countdown" id="countdown"></div>
          <div class="divider"></div>
          <div class="muted">Tournament dates: Jun 11 ‚Äì Jul 19, 2026. (Official FIFA schedule)</div>
        </div>

        <div class="card mini" style="min-height:0;">
          <h3>Dallas Match Schedule</h3>
          <div class="muted">Auto-highlights the next upcoming match. ‚ÄúMatch-day mode‚Äù turns on automatically.</div>
          <div class="divider"></div>
          <div class="matches" id="matches"></div>
        </div>

      </div>
    </div>
  </div>

<script>
  // ================================
  // Client-side memory + language
  // ================================
  const history = [];
  let currentLang = "auto";

  const chatEl = document.getElementById("chat");
  const msgEl = document.getElementById("msg");
  const sendBtn = document.getElementById("sendBtn");
  const langStatus = document.getElementById("langStatus");

  function addBubble(role, text) {
    const b = document.createElement("div");
    b.className = "bubble " + (role === "user" ? "user" : "bot");
    b.textContent = text;
    chatEl.appendChild(b);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function setSending(sending) {
    sendBtn.disabled = sending;
    msgEl.disabled = sending;
    sendBtn.textContent = sending ? "..." : "Send";
  }

  async function setLanguage(lang) {
    currentLang = lang;
    langStatus.textContent = "Language: " + (lang === "en" ? "English" :
      lang === "es" ? "Espa√±ol" :
      lang === "pt" ? "Portugu√™s" :
      lang === "fr" ? "Fran√ßais" : "auto");

    // Also send a ‚Äúrespond in X‚Äù instruction (your requested behavior)
    const instruction = lang === "en" ? "Respond in English." :
                        lang === "es" ? "Respond in Spanish." :
                        lang === "pt" ? "Respond in Portuguese." :
                        "Respond in French.";
    await sendRaw(instruction, true);
  }

  async function recallReservation() {
    await sendRaw("Recall reservation so far", false);
  }

  async function sendRaw(text, hideUserBubble) {
    const trimmed = (text || "").trim();
    if (!trimmed) return;

    if (!hideUserBubble) {
      addBubble("user", trimmed);
    }
    history.push({ role: "user", content: trimmed });

    setSending(true);
    try {
      const res = await fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: trimmed, history: history, lang: currentLang === "auto" ? "" : currentLang })
      });
      const data = await res.json();
      const reply = data.reply || "Sorry ‚Äî no reply received.";
      addBubble("assistant", reply);
      history.push({ role: "assistant", content: reply });
    } catch (e) {
      addBubble("assistant", "‚ö†Ô∏è Network error. Please try again.");
    } finally {
      setSending(false);
      msgEl.focus();
    }
  }

  async function sendMessage() {
    const text = msgEl.value.trim();
    if (!text) return;
    msgEl.value = "";
    msgEl.style.height = "44px";
    await sendRaw(text, false);
  }

  msgEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  msgEl.addEventListener("input", () => {
    msgEl.style.height = "44px";
    msgEl.style.height = Math.min(msgEl.scrollHeight, 140) + "px";
  });

  // Initial greeting
  addBubble("assistant", "Hi! Want to book a table for a match day? Ask me anything.");
  history.push({ role: "assistant", content: "Hi! Want to book a table for a match day? Ask me anything." });

  // ================================
  // Countdown widget (safe/local)
  // ================================
  // Tournament start: June 11, 2026 (local time)
  const tournamentStart = new Date(2026, 5, 11, 0, 0, 0); // month is 0-based: 5 = June

  function renderCountdown() {
    const now = new Date();
    let diff = tournamentStart - now;
    if (diff < 0) diff = 0;

    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
    const mins = Math.floor((diff / (1000 * 60)) % 60);
    const secs = Math.floor((diff / 1000) % 60);

    const el = document.getElementById("countdown");
    el.innerHTML = `
      <div class="tile"><div class="num">${days}</div><div class="lbl">Days</div></div>
      <div class="tile"><div class="num">${hours}</div><div class="lbl">Hours</div></div>
      <div class="tile"><div class="num">${mins}</div><div class="lbl">Minutes</div></div>
      <div class="tile"><div class="num">${secs}</div><div class="lbl">Seconds</div></div>
    `;
  }
  setInterval(renderCountdown, 1000);
  renderCountdown();

  // ================================
  // Schedule (dynamic from server)
  // ================================
  let rules = null;
  let schedule = [];

  function isoTodayLocal() {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function findNextMatch(matches) {
    const today = isoTodayLocal();
    const upcoming = matches
      .map(m => ({...m}))
      .sort((a,b) => a.date.localeCompare(b.date))
      .filter(m => m.date >= today);
    return upcoming.length ? upcoming[0] : null;
  }

  function renderMatches() {
    const el = document.getElementById("matches");
    el.innerHTML = "";

    const today = isoTodayLocal();
    const next = findNextMatch(schedule);

    schedule
      .slice()
      .sort((a,b) => a.date.localeCompare(b.date))
      .forEach(m => {
        const row = document.createElement("div");
        row.className = "matchRow";
        if (next && m.date === next.date && m.home === next.home && m.away === next.away) {
          row.classList.add("next");
        }
        const vs = `${m.home} vs ${m.away}`;
        row.innerHTML = `
          <div class="left">
            <div><strong>${m.date}</strong> ‚Ä¢ ${vs}</div>
            <div class="tag">${m.stage}</div>
          </div>
          <div class="right">
            <div>${m.time || "TBD"}</div>
          </div>
        `;
        el.appendChild(row);
      });

    // Match-day banner: on if today is a match date
    const isMatchDay = schedule.some(m => m.date === today);
    const banner = document.getElementById("matchBanner");
    const matchOpen = document.getElementById("matchOpenTime");

    if (rules && isMatchDay) {
      matchOpen.textContent = rules.open_time_matchday || "11:00";
      banner.style.display = "block";
    } else {
      banner.style.display = "none";
    }
  }

  async function loadRulesAndSchedule() {
    const r = await fetch("/rules").then(x => x.json());
    rules = r;

    const s = await fetch("/schedule").then(x => x.json());
    schedule = s.matches || [];

    renderMatches();
  }

  loadRulesAndSchedule();
</script>
</body>
</html>