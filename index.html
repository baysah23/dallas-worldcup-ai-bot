<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>World Cup 2026 Dallas Concierge</title>
  <style>
    :root{
      --bg:#071022;
      --panel:#0f1b33;
      --panel2:#0b152c;
      --line:rgba(255,255,255,.12);
      --text:#eaf0ff;
      --muted:#b9c7ee;
      --accent:#2ea043;
      --accent2:#1f6feb;
      --warn:#ffcc66;
    }
    body{
      margin:0; height:100vh; display:flex; flex-direction:column;
      font-family: Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% 10%, #132a5b 0%, var(--bg) 55%);
      color:var(--text);
    }
    .wrap{max-width:1050px; width:100%; margin:0 auto; display:flex; flex-direction:column; height:100%;}
    header{
      padding:16px 18px;
      background: linear-gradient(90deg, #0b1733 0%, #0f1b33 55%, #102246 100%);
      border-bottom:1px solid var(--line);
    }
    .toprow{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    .brand{display:flex; gap:12px; align-items:center;}
    .badge{
      width:44px; height:44px; border-radius:12px;
      background: linear-gradient(135deg, #f5d76e 0%, #2ea043 45%, #1f6feb 100%);
      box-shadow: 0 10px 35px rgba(0,0,0,.25);
    }
    h1{margin:0; font-size:16px; font-weight:800; letter-spacing:.2px;}
    .sub{margin:6px 0 0; color:var(--muted); font-size:12px;}

    .langbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .langbtn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:8px 10px;
      border-radius:10px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .langbtn.active{background:rgba(46,160,67,.18); border-color:rgba(46,160,67,.45);}

    .grid{
      display:grid; grid-template-columns: 1.2fr .8fr; gap:14px;
      padding:14px; flex:1; min-height:0;
    }
    @media (max-width: 950px){
      .grid{grid-template-columns:1fr; }
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06) 0%, rgba(255,255,255,.03) 100%);
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
      min-height:0;
    }
    .cardhead{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: rgba(0,0,0,.12);
    }
    .cardhead .title{font-weight:800; font-size:13px;}
    .pill{
      font-size:11px; color:var(--muted);
      border:1px solid var(--line);
      padding:6px 10px; border-radius:999px;
      background:rgba(0,0,0,.12);
      white-space:nowrap;
    }
    .banner{
      padding:10px 14px;
      border-bottom:1px dashed rgba(255,255,255,.16);
      color:var(--warn);
      font-size:12px;
      display:none;
    }
    .banner.show{display:block;}

    #chat{
      padding:14px; height:100%; overflow:auto;
      display:flex; flex-direction:column; gap:10px;
    }
    .bubble{
      max-width:78%;
      padding:10px 12px;
      border-radius:14px;
      line-height:1.35;
      white-space:pre-wrap;
      word-wrap:break-word;
      border:1px solid rgba(255,255,255,.10);
    }
    .user{
      align-self:flex-end;
      background: rgba(31,111,235,.22);
      border-color: rgba(31,111,235,.35);
    }
    .bot{
      align-self:flex-start;
      background: rgba(0,0,0,.18);
    }

    .composer{
      display:flex; gap:10px; padding:12px 14px;
      border-top:1px solid var(--line);
      background: rgba(0,0,0,.12);
      align-items:center;
    }
    textarea{
      flex:1; resize:none; height:44px; max-height:130px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color:var(--text);
      padding:10px 12px; font-size:14px; outline:none;
    }
    button{
      background: var(--accent);
      border:none;
      padding:10px 14px;
      border-radius:12px;
      font-size:14px;
      font-weight:800;
      color:#fff;
      cursor:pointer;
      min-width:92px;
    }
    button:disabled{opacity:.6; cursor:not-allowed;}

    .sidepad{padding:12px 14px;}
    .countdown{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
    }
    .countdown .label{font-size:12px; color:var(--muted); font-weight:700;}

    /* tightened to fit one line */
    .countdown .nums{
      display:flex;
      gap:8px;
      align-items:baseline;
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
      letter-spacing:-0.2px;
    }
    .nums span{color:var(--text);}
    .nums b{color:#f5d76e;}

    .schedule{max-height:260px; overflow:auto;}
    .match{
      display:flex; justify-content:space-between; gap:10px;
      padding:10px 12px;
      border-top:1px solid rgba(255,255,255,.10);
      font-size:12px;
    }
    .match .left{display:flex; flex-direction:column; gap:2px;}
    .match .when{color:var(--muted);}
    .match.next{
      background: rgba(46,160,67,.18);
      border-top:1px solid rgba(46,160,67,.35);
    }
    .matchday{
      margin:12px 14px 0;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(245,215,110,.35);
      background: rgba(245,215,110,.10);
      font-size:12px;
      display:none;
    }
    .matchday.show{display:block;}

    .menu{
      border-top:1px solid rgba(255,255,255,.10);
      padding:10px 12px;
      font-size:12px;
      display:flex; flex-direction:column; gap:8px;
    }
    .menuitem{
      padding:8px 10px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      background: rgba(0,0,0,.14);
    }
    .menuitem .name{font-weight:800;}
    .menuitem .desc{color:var(--muted); margin-top:3px;}
    .menuitem .price{margin-top:6px; font-weight:800; color:#f5d76e;}

    .hint{
      padding:10px 14px;
      font-size:12px;
      color:var(--muted);
      border-top:1px dashed rgba(255,255,255,.14);
    }
    code{background:rgba(255,255,255,.10); padding:2px 6px; border-radius:8px;}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="toprow">
        <div class="brand">
          <div class="badge" aria-hidden="true"></div>
          <div>
            <h1>World Cup 2026 ‚Ä¢ Dallas Match-Day Concierge</h1>
            <div class="sub" id="subtitle">
              Reserve tables, see Dallas match schedule, and chat in English ‚Ä¢ Espa√±ol ‚Ä¢ Portugu√™s ‚Ä¢ Fran√ßais
            </div>
          </div>
        </div>

        <div class="langbar" aria-label="Language toggle">
          <div class="langbtn" data-lang="en">English</div>
          <div class="langbtn" data-lang="es">Espa√±ol</div>
          <div class="langbtn" data-lang="pt">Portugu√™s</div>
          <div class="langbtn" data-lang="fr">Fran√ßais</div>
        </div>
      </div>
    </header>

    <div class="grid">
      <!-- Chat -->
      <div class="card" style="display:flex;flex-direction:column;min-height:0;">
        <div class="cardhead">
          <div class="title" id="chatTitle">Chat</div>
          <div class="pill" id="pillMode">Mode: Standard</div>
        </div>

        <div class="banner" id="matchBanner"></div>

        <div id="chat"></div>

        <div class="composer">
          <textarea id="msg" placeholder="Type your message... (Enter to send, Shift+Enter for new line)"></textarea>
          <button id="sendBtn">Send</button>
        </div>

        <div class="hint" id="helperHint"></div>
      </div>

      <!-- Sidebar -->
      <div class="card" style="display:flex;flex-direction:column;min-height:0;">
        <div class="cardhead">
          <div class="title" id="sideTitle">Dallas Schedule + Menu</div>
          <div class="pill" id="pillLang">EN</div>
        </div>

        <div class="countdown">
          <div>
            <div class="label" id="countLabel">World Cup countdown</div>
            <div class="sub" style="margin:4px 0 0;" id="countSub">Dallas / Arlington match days</div>
          </div>
          <div class="nums" id="countNums">
            <span><b id="d">0</b>d</span>
            <span><b id="h">0</b>h</span>
            <span><b id="m">0</b>m</span>
            <span><b id="s">0</b>s</span>
          </div>
        </div>

        <div class="matchday" id="matchdayBox"></div>

        <div class="sidepad" style="padding-bottom:0;">
          <div class="pill" style="display:inline-block;" id="nextHint">Next upcoming match is highlighted</div>
        </div>

        <div class="schedule" id="schedule"></div>

        <div class="cardhead" style="border-top:1px solid var(--line); border-bottom:none;">
          <div class="title" id="menuTitle">Menu</div>
          <div class="pill" id="menuLangPill">4 languages</div>
        </div>
        <div class="menu" id="menu"></div>
      </div>
    </div>
  </div>

<script>
  // -----------------------
  // Session + state
  // -----------------------
  const sessionId = (localStorage.getItem("session_id") || (() => {
    const id = "sess_" + Math.random().toString(16).slice(2) + "_" + Date.now();
    localStorage.setItem("session_id", id);
    return id;
  })());

  let lang = localStorage.getItem("lang") || "en";
  let ui = null;
  let config = null;
  let scheduleData = null;

  // Conversation memory (client-side history)
  const history = [];

  const chatEl = document.getElementById("chat");
  const msgEl = document.getElementById("msg");
  const sendBtn = document.getElementById("sendBtn");
  const helperHint = document.getElementById("helperHint");

  const pillLang = document.getElementById("pillLang");
  const pillMode = document.getElementById("pillMode");
  const matchBanner = document.getElementById("matchBanner");
  const matchdayBox = document.getElementById("matchdayBox");

  // UI labels
  const subtitle = document.getElementById("subtitle");
  const chatTitle = document.getElementById("chatTitle");
  const sideTitle = document.getElementById("sideTitle");
  const countLabel = document.getElementById("countLabel");
  const countSub = document.getElementById("countSub");
  const nextHint = document.getElementById("nextHint");
  const menuTitle = document.getElementById("menuTitle");

  function addBubble(role, text){
    const b = document.createElement("div");
    b.className = "bubble " + (role === "user" ? "user" : "bot");
    b.textContent = text;
    chatEl.appendChild(b);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function setSending(isSending){
    sendBtn.disabled = isSending;
    msgEl.disabled = isSending;
    sendBtn.textContent = isSending ? "..." : (ui?.strings?.send_btn || "Send");
  }

  // -----------------------
  // Fetchers
  // -----------------------
  async function loadConfig(){
    const res = await fetch("/api/config", { cache: "no-store" });
    config = await res.json();
  }

  async function loadUI(lang){
    const res = await fetch("/api/ui?lang=" + encodeURIComponent(lang), { cache: "no-store" });
    ui = await res.json();

    // Apply localized UI text (labels + hint + placeholder)
    helperHint.textContent = ui.strings.helper;
    msgEl.placeholder = ui.strings.placeholder;

    subtitle.textContent = ui.strings.subtitle;
    chatTitle.textContent = ui.strings.chat_title;
    sideTitle.textContent = ui.strings.side_title;
    countLabel.textContent = ui.strings.countdown_label;
    countSub.textContent = ui.strings.countdown_sub;
    nextHint.textContent = ui.strings.next_highlight_hint;
    menuTitle.textContent = ui.strings.menu_title;

    // send button label
    sendBtn.textContent = ui.strings.send_btn;
  }

  async function loadSchedule(){
    const res = await fetch("/api/schedule", { cache: "no-store" });
    scheduleData = await res.json();
    renderSchedule();
    updateMatchDayMode();
  }

  async function loadMenu(lang){
    const res = await fetch("/api/menu?lang=" + encodeURIComponent(lang), { cache: "no-store" });
    const data = await res.json();
    renderMenu(data.items);
  }

  // -----------------------
  // Countdown (safe local clock)
  // -----------------------
  function startCountdown(){
    const target = new Date(config.countdown_target); // ISO
    const dEl = document.getElementById("d");
    const hEl = document.getElementById("h");
    const mEl = document.getElementById("m");
    const sEl = document.getElementById("s");

    function tick(){
      const now = new Date();
      let diff = Math.max(0, target - now);

      const days = Math.floor(diff / (1000*60*60*24)); diff -= days*(1000*60*60*24);
      const hrs  = Math.floor(diff / (1000*60*60)); diff -= hrs*(1000*60*60);
      const mins = Math.floor(diff / (1000*60)); diff -= mins*(1000*60);
      const secs = Math.floor(diff / 1000);

      dEl.textContent = days;
      hEl.textContent = hrs;
      mEl.textContent = mins;
      sEl.textContent = secs;
    }

    tick();
    setInterval(tick, 1000);
  }

  // -----------------------
  // Schedule rendering + next match highlight
  // -----------------------
  function renderSchedule(){
    const el = document.getElementById("schedule");
    el.innerHTML = "";

    const matches = scheduleData.matches.slice().map(m => {
      let ts;
      if (m.time && m.time !== "TBD") {
        // If time is like "19:00" (24h), this works perfectly.
        // If time is "7pm", server should ideally normalize to "19:00".
        ts = Date.parse(m.date + "T" + m.time + ":00");
      } else {
        ts = Date.parse(m.date + "T23:59:59");
      }
      return {...m, ts};
    });

    const now = Date.now();
    const upcoming = matches.filter(m => m.ts >= now).sort((a,b)=>a.ts-b.ts);
    const nextId = upcoming.length ? upcoming[0].id : null;

    matches.sort((a,b)=>a.ts-b.ts).forEach(m => {
      const row = document.createElement("div");
      row.className = "match" + (m.id === nextId ? " next" : "");
      const timeTxt = (m.time && m.time !== "TBD") ? m.time : "TBD";
      row.innerHTML = `
        <div class="left">
          <div><b>${m.stage}</b> ‚Ä¢ ${m.home} vs ${m.away}</div>
          <div class="when">${m.date} ‚Ä¢ ${timeTxt}</div>
        </div>
        <div class="pill">${m.venue_short || m.id}</div>
      `;
      el.appendChild(row);
    });
  }

  function updateMatchDayMode(){
    const todayISO = new Date().toISOString().slice(0,10);
    const isMatch = scheduleData.matches.some(m => m.date === todayISO);

    if (isMatch){
      pillMode.textContent = ui?.strings?.mode_matchday || "Mode: Match-day";
      matchBanner.textContent = config.business_rules.match_day_banner || "Match-day hours";
      matchBanner.classList.add("show");

      matchdayBox.textContent = ui?.strings?.matchday_box || "üèüÔ∏è Match-day mode is ON today. Expect higher traffic ‚Äî reserve early!";
      matchdayBox.classList.add("show");
    } else {
      pillMode.textContent = ui?.strings?.mode_standard || "Mode: Standard";
      matchBanner.classList.remove("show");
      matchdayBox.classList.remove("show");
    }
  }

  // -----------------------
  // Menu rendering
  // -----------------------
  function renderMenu(items){
    const el = document.getElementById("menu");
    el.innerHTML = "";
    items.forEach(it => {
      const d = document.createElement("div");
      d.className = "menuitem";
      d.innerHTML = `
        <div class="name">${it.name}</div>
        <div class="desc">${it.desc}</div>
        <div class="price">${it.price}</div>
      `;
      el.appendChild(d);
    });
  }

  // -----------------------
  // Language toggle: sends an instruction to the bot + localizes UI
  // -----------------------
  const LANG_INSTRUCTIONS = {
    en: "Respond in English.",
    es: "Responde en espa√±ol.",
    pt: "Responda em portugu√™s.",
    fr: "R√©pondez en fran√ßais."
  };

  async function setLanguage(newLang){
    lang = newLang;
    localStorage.setItem("lang", lang);

    document.querySelectorAll(".langbtn").forEach(btn => {
      btn.classList.toggle("active", btn.dataset.lang === lang);
    });

    pillLang.textContent = lang.toUpperCase();

    // load UI strings + menu in that language
    await loadUI(lang);
    await loadMenu(lang);

    // tell the bot to respond in selected language
    const instruction = LANG_INSTRUCTIONS[lang] || LANG_INSTRUCTIONS.en;

    addBubble("assistant", ui.strings.lang_set);
    history.push({role:"assistant", content: ui.strings.lang_set});

    // Send instruction silently (doesn't need user typing)
    await sendHiddenInstruction(instruction);

    // Then show localized helper message (in the selected language)
    addBubble("assistant", ui.strings.helper);
    history.push({role:"assistant", content: ui.strings.helper});

    updateMatchDayMode();
  }

  async function sendHiddenInstruction(text){
    try{
      setSending(true);
      const res = await fetch("/chat", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({
          message: text,
          history,
          session_id: sessionId,
          lang
        })
      });
      const data = await res.json();
      const reply = data.reply || "";
      // Optional: don‚Äôt show the assistant reply to the hidden instruction
      // but we DO store it in history so the model sticks to language.
      if (reply) history.push({role:"assistant", content: reply});
    } finally {
      setSending(false);
    }
  }

  document.querySelectorAll(".langbtn").forEach(btn => {
    btn.addEventListener("click", () => setLanguage(btn.dataset.lang));
  });

  // -----------------------
  // Chat send
  // -----------------------
  async function sendMessage(){
    const text = msgEl.value.trim();
    if (!text) return;

    addBubble("user", text);
    history.push({role:"user", content:text});
    msgEl.value = "";
    msgEl.style.height = "44px";
    setSending(true);

    try{
      const res = await fetch("/chat", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({
          message: text,
          history,
          session_id: sessionId,
          lang
        })
      });
      const data = await res.json();
      const reply = data.reply || "Sorry ‚Äî no reply received.";
      addBubble("assistant", reply);
      history.push({role:"assistant", content: reply});
    } catch(e){
      addBubble("assistant", ui?.strings?.network_error || "‚ö†Ô∏è Network error. Please try again.");
    } finally{
      setSending(false);
      msgEl.focus();
    }
  }

  sendBtn.addEventListener("click", sendMessage);

  // Enter to send, Shift+Enter newline
  msgEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // Auto-grow textarea
  msgEl.addEventListener("input", () => {
    msgEl.style.height = "44px";
    msgEl.style.height = Math.min(msgEl.scrollHeight, 130) + "px";
  });

  // -----------------------
  // Init
  // -----------------------
  (async function init(){
    await loadConfig();
    await loadUI(lang);
    await loadSchedule();
    await loadMenu(lang);
    startCountdown();

    pillLang.textContent = lang.toUpperCase();
    document.querySelectorAll(".langbtn").forEach(btn => {
      btn.classList.toggle("active", btn.dataset.lang === lang);
    });

    addBubble("assistant", ui.strings.welcome);
    history.push({role:"assistant", content: ui.strings.welcome});

    helperHint.textContent = ui.strings.helper;

    // stick language preference immediately
    await sendHiddenInstruction(LANG_INSTRUCTIONS[lang] || LANG_INSTRUCTIONS.en);
  })();
</script>

</body>
</html>