<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>World Cup 2026 • Dallas Match-Day HQ</title>
  <style>
    :root{--bg:#071022;--panel:#0f1b33;--line:rgba(255,255,255,.12);--text:#eaf0ff;--muted:#b9c7ee;--gold:#d4af37;}
    body{margin:0;font-family:Arial,system-ui;background:radial-gradient(1200px 600px at 20% 10%, #132a5b 0%, var(--bg) 55%);color:var(--text);}
    .wrap{max-width:1150px;margin:0 auto;padding:16px;}
    .banner{border:1px solid var(--line);border-radius:18px;overflow:hidden;background:linear-gradient(135deg, rgba(212,175,55,.10), rgba(15,27,51,.90));padding:14px;}
    .banner h1{margin:0;font-size:20px;letter-spacing:.5px}
    .banner .sub{color:var(--muted);margin-top:4px;font-size:13px}
    .grid{display:grid;grid-template-columns:1.25fr .75fr;gap:14px;margin-top:14px;}
    @media(max-width:980px){.grid{grid-template-columns:1fr;}}
    .card{background:rgba(15,27,51,.92);border:1px solid var(--line);border-radius:18px;padding:12px;}
    .card h2{margin:0 0 10px 0;font-size:15px}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.18);color:var(--text);font-weight:800;cursor:pointer;}
    .btn.primary{background:var(--gold);border:0;color:#0b1020;}
    .btnRow{display:flex;flex-wrap:wrap;gap:8px;}
    .muted{color:var(--muted);font-size:13px}
    .pollBox{border:1px solid rgba(255,255,255,.16);border-radius:16px;padding:10px;background:rgba(0,0,0,.14)}
    .teamRow{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:10px}
    .bar{height:10px;border-radius:999px;background:rgba(255,255,255,.10);overflow:hidden}
    .fill{height:10px;background:rgba(212,175,55,.75)}
    .winner{outline:2px solid rgba(212,175,55,.75);box-shadow:0 0 22px rgba(212,175,55,.25);border-radius:14px}
    .toast{margin-top:10px;font-size:13px;color:var(--muted)}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:9999;}
    .modal .panel{width:min(760px,92vw);max-height:82vh;overflow:auto;background:rgba(15,27,51,.98);border:1px solid var(--line);border-radius:18px;padding:14px;}
    .gridCountries{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:10px;}
    @media(max-width:720px){.gridCountries{grid-template-columns:repeat(2,1fr);}}
    .chip{padding:9px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.14);cursor:pointer;text-align:center;font-weight:800;font-size:13px}
    .chip.active{border-color:rgba(212,175,55,.7);box-shadow:0 0 18px rgba(212,175,55,.18)}
    .chatBox{display:flex;gap:8px;margin-top:10px}
    input[type=text]{flex:1;padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.16);color:var(--text)}
    .log{margin-top:10px;max-height:240px;overflow:auto;border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:10px;background:rgba(0,0,0,.10)}
    .msg{margin:0 0 8px 0;font-size:14px}
    .msg b{color:var(--gold)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="banner">
      <h1>WORLD CUP 2026 • DALLAS MATCH DAY HQ</h1>
      <div class="sub">Fan Zone + Reservations + Match of the Day Fan Pick</div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Chat Concierge</h2>
        <div class="muted">Type <b>reservation</b> to book a table. Ask about Dallas matches, all matches, or the menu.</div>
        <div class="chatBox">
          <input id="chatInput" type="text" placeholder='Try: reservation' />
          <button class="btn primary" id="sendBtn">Send</button>
        </div>
        <div class="log" id="chatLog"></div>
      </div>

      <div class="card" id="fanZone">
        <h2>Fan Zone</h2>
        <div class="btnRow">
          <button class="btn" id="pickCountryBtn">Which country are you supporting?</button>
          <button class="btn" id="qrBtn">QR poster</button>
        </div>

        <div style="height:10px"></div>

        <div class="pollBox">
          <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;">
            <div>
              <div class="muted" id="pollSponsor">Fan Pick</div>
              <div style="font-weight:900" id="pollTitle">Match of the Day</div>
              <div class="muted" id="pollMeta"></div>
            </div>
            <div class="muted" id="pollLock"></div>
          </div>

          <div class="teamRow" id="homeRow">
            <div style="font-weight:900" id="homeTeam">—</div>
            <button class="btn primary" id="voteHome">Vote</button>
          </div>
          <div class="bar"><div class="fill" id="homeFill" style="width:0%"></div></div>
          <div class="muted" id="homePct">0%</div>

          <div style="height:8px"></div>

          <div class="teamRow" id="awayRow">
            <div style="font-weight:900" id="awayTeam">—</div>
            <button class="btn primary" id="voteAway">Vote</button>
          </div>
          <div class="bar"><div class="fill" id="awayFill" style="width:0%"></div></div>
          <div class="muted" id="awayPct">0%</div>

          <div class="toast" id="pollToast"></div>
        </div>

        <div style="height:12px"></div>

        <div class="pollBox" id="drinkBox">
          <div style="font-weight:900" id="drinkName">Country-themed drink highlight</div>
          <div class="muted" id="drinkDesc">Pick a country to unlock a tailored drink suggestion.</div>
        </div>

        <div class="pollBox" id="qrCard" style="display:none;margin-top:10px;">
          <div style="font-weight:900">Scan to open this app</div>
          <div class="muted" style="margin-top:6px">Link: <a id="qrLink" href="#" style="color:var(--gold)"></a></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="countryModal" aria-hidden="true">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
        <div style="font-weight:900">Select a qualified country</div>
        <button class="btn" id="closeCountry">Close</button>
      </div>
      <div class="muted" id="countryMeta" style="margin-top:6px;"></div>
      <div class="gridCountries" id="countryGrid"></div>
    </div>
  </div>

<script>
(function(){
  const chatLog = document.getElementById('chatLog');
  const chatInput = document.getElementById('chatInput');
  const sendBtn = document.getElementById('sendBtn');

  function esc(s){ return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
  function addMsg(role, text){
    const p = document.createElement('p');
    p.className = 'msg';
    p.innerHTML = role === 'you' ? `<b>You:</b> ${esc(text)}` : `<b>Concierge:</b> ${esc(text)}`;
    chatLog.appendChild(p);
    chatLog.scrollTop = chatLog.scrollHeight;
  }
  async function send(){
    const msg = (chatInput.value||'').trim();
    if(!msg) return;
    addMsg('you', msg);
    chatInput.value = '';
    try{
      const r = await fetch('/chat', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({message: msg})});
      const j = await r.json();
      addMsg('bot', j.reply || '—');
    }catch(e){
      addMsg('bot','⚠️ Network error.');
    }
  }
  sendBtn.addEventListener('click', send);
  chatInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') send(); });

  // Fan Zone
  const pickCountryBtn = document.getElementById('pickCountryBtn');
  const countryModal = document.getElementById('countryModal');
  const closeCountry = document.getElementById('closeCountry');
  const countryGrid = document.getElementById('countryGrid');
  const countryMeta = document.getElementById('countryMeta');

  const drinkName = document.getElementById('drinkName');
  const drinkDesc = document.getElementById('drinkDesc');

  const qrBtn = document.getElementById('qrBtn');
  const qrCard = document.getElementById('qrCard');
  const qrLink = document.getElementById('qrLink');

  const pollSponsor = document.getElementById('pollSponsor');
  const pollLock = document.getElementById('pollLock');
  const homeTeam = document.getElementById('homeTeam');
  const awayTeam = document.getElementById('awayTeam');
  const voteHome = document.getElementById('voteHome');
  const voteAway = document.getElementById('voteAway');
  const homeFill = document.getElementById('homeFill');
  const awayFill = document.getElementById('awayFill');
  const homePct = document.getElementById('homePct');
  const awayPct = document.getElementById('awayPct');
  const pollToast = document.getElementById('pollToast');
  const homeRow = document.getElementById('homeRow');
  const awayRow = document.getElementById('awayRow');

  let selectedCountry = localStorage.getItem('wc26_country') || '';
  let poll = { match_id:'', home:'', away:'', kickoff_utc:'', locked:false, winner:'' };
  let voter = localStorage.getItem('wc26_voter') || '';

  function openModal(){ countryModal.style.display='flex'; countryModal.setAttribute('aria-hidden','false'); }
  function closeModal(){ countryModal.style.display='none'; countryModal.setAttribute('aria-hidden','true'); }

  pickCountryBtn.addEventListener('click', openModal);
  closeCountry.addEventListener('click', closeModal);
  countryModal.addEventListener('click', (e)=>{ if(e.target === countryModal) closeModal(); });

  qrBtn.addEventListener('click', ()=>{
    const url = location.href;
    qrLink.textContent = url;
    qrLink.href = url;
    qrCard.style.display = (qrCard.style.display === 'none' || !qrCard.style.display) ? 'block' : 'none';
  });

  function setDrink(country){
    if(!country){
      drinkName.textContent = "Country-themed drink highlight";
      drinkDesc.textContent = "Pick a country to unlock a tailored drink suggestion.";
      return;
    }
    const map = {
      "Mexico": ["Paloma Royale", "Grapefruit, lime, salt rim — luxury refresh."],
      "Brazil": ["Gold Caipirinha", "Cachaça, lime, sugar — served over crushed ice."],
      "England": ["Royal Gin Fizz", "Gin, lemon, soda — crisp and classic."],
      "Argentina": ["Malbec Spritz", "Bold and smooth — match-night energy."],
      "Japan": ["Yuzu Highball", "Light, bright, ultra-clean."],
    };
    const pick = map[country] || ["VIP Signature", `A premium pick inspired by ${country}.`];
    drinkName.textContent = pick[0];
    drinkDesc.textContent = pick[1];
  }

  function renderCountries(list, asOf){
    countryGrid.innerHTML = '';
    countryMeta.textContent = `Qualified teams list (as of ${asOf}).`;
    list.forEach(c=>{
      const b = document.createElement('button');
      b.className = 'chip' + (c===selectedCountry ? ' active' : '');
      b.textContent = c;
      b.addEventListener('click', ()=>{
        selectedCountry = c;
        localStorage.setItem('wc26_country', c);
        document.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        setDrink(c);
      });
      countryGrid.appendChild(b);
    });
    setDrink(selectedCountry);
  }

  async function loadQualifiedCountries(){
    try{
      const r = await fetch('/countries/qualified.json', {cache:'no-store'});
      const j = await r.json();
      if(j && j.countries && Array.isArray(j.countries)){
        renderCountries(j.countries, j.as_of || '—');
      }
    }catch(e){
      countryMeta.textContent = "Could not load countries.";
    }
  }

  function applyPollUI(){
    homeTeam.textContent = poll.home || "Home";
    awayTeam.textContent = poll.away || "Away";
    pollLock.textContent = poll.locked ? "Locked at kickoff" : "";
    voteHome.disabled = !!poll.locked;
    voteAway.disabled = !!poll.locked;
    voteHome.style.opacity = poll.locked ? .55 : 1;
    voteAway.style.opacity = poll.locked ? .55 : 1;
    homeRow.classList.toggle('winner', poll.winner === 'home');
    awayRow.classList.toggle('winner', poll.winner === 'away');
  }
  function applyPercentages(t){
    const hp = Number(t.home_pct||0), ap = Number(t.away_pct||0);
    homeFill.style.width = Math.max(0, Math.min(100, hp)) + '%';
    awayFill.style.width = Math.max(0, Math.min(100, ap)) + '%';
    homePct.textContent = hp + '%';
    awayPct.textContent = ap + '%';
  }

  async function loadPoll(){
    try{
      const r = await fetch('/poll/match.json', {cache:'no-store'});
      const j = await r.json();
      if(!j || !j.ok){
        pollSponsor.textContent = "Fan Pick";
        pollToast.textContent = "Admin must set Match of the Day from /admin.";
        return;
      }
      pollSponsor.textContent = (j.sponsor || "Fan Pick") + " presented by …";
      poll.match_id = j.match.id;
      poll.home = j.match.home || "Home";
      poll.away = j.match.away || "Away";
      poll.kickoff_utc = j.match.kickoff_utc || "";
      poll.locked = !!j.match.locked;
      poll.winner = j.match.winner || "";
      applyPollUI();
      applyPercentages(j.totals || {});
      pollToast.textContent = "";
    }catch(e){
      pollToast.textContent = "Poll temporarily unavailable.";
    }
  }

  function getVoter(){
    if(!voter){
      voter = Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2);
      localStorage.setItem('wc26_voter', voter);
    }
    return voter;
  }

  async function vote(team){
    pollToast.textContent = "";
    if(!poll.match_id){
      pollToast.textContent = "No Match of the Day set yet.";
      return;
    }
    try{
      const payload = {match_id: poll.match_id, team, home: poll.home, away: poll.away, kickoff_utc: poll.kickoff_utc, voter: getVoter()};
      const r = await fetch('/poll/vote', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      const j = await r.json();
      if(j.voter){ localStorage.setItem('wc26_voter', j.voter); voter = j.voter; }
      if(j.locked){ poll.locked = true; applyPollUI(); pollToast.textContent = "Poll locked at kickoff."; }
      if(j.already_voted){ pollToast.textContent = "You already voted for this match."; }
      if(j.totals){ applyPercentages(j.totals); }
      if(j.winner){ poll.winner = j.winner; applyPollUI(); }
    }catch(e){
      pollToast.textContent = "Vote failed. Try again.";
    }
  }

  voteHome.addEventListener('click', ()=>vote('home'));
  voteAway.addEventListener('click', ()=>vote('away'));

  loadQualifiedCountries();
  loadPoll();
  setInterval(loadPoll, 15000);
})();
</script>
</body>
</html>
