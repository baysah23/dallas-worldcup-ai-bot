<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>World Cup 2026 Dallas Concierge</title>

  <style>
    :root{
      --bg:#071022;
      --panel:#0f1b33;
      --panel2:#0b152c;
      --line:rgba(255,255,255,.12);
      --text:#eaf0ff;
      --muted:#b9c7ee;
      --accent:#2ea043;
      --accent2:#1f6feb;
      --warn:#ffcc66;
    }
    body{
      margin:0; height:100vh; display:flex; flex-direction:column;
      font-family: Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% 10%, #132a5b 0%, var(--bg) 55%);
      color:var(--text);
    }
    .wrap{max-width:1050px; width:100%; margin:0 auto; display:flex; flex-direction:column; height:100%;}
    header{
      padding:16px 18px;
      background: linear-gradient(90deg, #0b1733 0%, #0f1b33 55%, #102246 100%);
      border-bottom:1px solid var(--line);
    }
    .toprow{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    .brand{display:flex; gap:12px; align-items:center;}
    .badge{
      width:44px; height:44px; border-radius:12px;
      background: linear-gradient(135deg, #f5d76e 0%, #2ea043 45%, #1f6feb 100%);
      box-shadow: 0 10px 35px rgba(0,0,0,.25);
    }
    h1{margin:0; font-size:16px; font-weight:800; letter-spacing:.2px;}
    .sub{margin:6px 0 0; color:var(--muted); font-size:12px;}
    .langbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .langbtn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:8px 10px;
      border-radius:10px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .langbtn.active{background:rgba(46,160,67,.18); border-color:rgba(46,160,67,.45);}

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      padding:14px;
      flex:1;
      min-height:0;
    }
    @media (max-width: 950px){ .grid{grid-template-columns:1fr;} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06) 0%, rgba(255,255,255,.03) 100%);
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
      min-height:0;
    }
    .cardhead{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(0,0,0,.12);
    }
    .cardhead .title{font-weight:800; font-size:13px;}
    .pill{
      font-size:11px;
      color:var(--muted);
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      background:rgba(0,0,0,.12);
      white-space:nowrap;
    }
    .banner{
      padding:10px 14px;
      border-bottom:1px dashed rgba(255,255,255,.16);
      color:var(--warn);
      font-size:12px;
      display:none;
    }
    .banner.show{display:block;}

    #chat{
      padding:14px;
      height:100%;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .bubble{
      max-width:78%;
      padding:10px 12px;
      border-radius:14px;
      line-height:1.35;
      white-space:pre-wrap;
      word-wrap:break-word;
      border:1px solid rgba(255,255,255,.10);
    }
    .user{
      align-self:flex-end;
      background: rgba(31,111,235,.22);
      border-color: rgba(31,111,235,.35);
    }
    .bot{
      align-self:flex-start;
      background: rgba(0,0,0,.18);
    }

    .composer{
      display:flex;
      gap:10px;
      padding:12px 14px;
      border-top:1px solid var(--line);
      background: rgba(0,0,0,.12);
      align-items:center;
    }
    textarea{
      flex:1;
      resize:none;
      height:44px;
      max-height:130px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color:var(--text);
      padding:10px 12px;
      font-size:14px;
      outline:none;
    }
    button{
      background: var(--accent);
      border:none;
      padding:10px 14px;
      border-radius:12px;
      font-size:14px;
      font-weight:800;
      color:#fff;
      cursor:pointer;
      min-width:92px;
    }
    button:disabled{opacity:.6; cursor:not-allowed;}

    .sidepad{padding:12px 14px;}

    .countdown{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
    }
    .countdown .label{font-size:12px; color:var(--muted); font-weight:700;}
    .countdown .nums{
      display:flex;
      gap:10px;
      align-items:baseline;
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
    }
    .nums span{color:var(--text);}
    .nums b{color:#f5d76e;}

    .schedule{max-height:260px; overflow:auto;}
    .match{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-top:1px solid rgba(255,255,255,.10);
      font-size:12px;
    }
    .match .left{display:flex; flex-direction:column; gap:2px;}
    .match .when{color:var(--muted);}
    .match.next{
      background: rgba(46,160,67,.18);
      border-top:1px solid rgba(46,160,67,.35);
    }

    .matchday{
      margin:12px 14px 0;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(245,215,110,.35);
      background: rgba(245,215,110,.10);
      font-size:12px;
      display:none;
    }
    .matchday.show{display:block;}

    .menu{
      border-top:1px solid rgba(255,255,255,.10);
      padding:10px 12px;
      font-size:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .menuitem{
      padding:8px 10px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      background: rgba(0,0,0,.14);
    }
    .menuitem .name{font-weight:800;}
    .menuitem .desc{color:var(--muted); margin-top:3px;}
    .menuitem .price{margin-top:6px; font-weight:800; color:#f5d76e;}

    .hint{
      padding:10px 14px;
      font-size:12px;
      color:var(--muted);
      border-top:1px dashed rgba(255,255,255,.14);
    }
    code{background:rgba(255,255,255,.10); padding:2px 6px; border-radius:8px;}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="toprow">
        <div class="brand">
          <div class="badge" aria-hidden="true"></div>
          <div>
            <h1>World Cup 2026 ‚Ä¢ Dallas Match-Day Concierge</h1>
            <div class="sub">Reserve tables, see Dallas match schedule, and chat in English ‚Ä¢ Espa√±ol ‚Ä¢ Portugu√™s ‚Ä¢ Fran√ßais</div>
          </div>
        </div>

        <div class="langbar" aria-label="Language toggle">
          <div class="langbtn active" data-lang="en">English</div>
          <div class="langbtn" data-lang="es">Espa√±ol</div>
          <div class="langbtn" data-lang="pt">Portugu√™s</div>
          <div class="langbtn" data-lang="fr">Fran√ßais</div>
        </div>
      </div>
    </header>

    <div class="grid">
      <!-- Chat -->
      <div class="card" style="display:flex;flex-direction:column;min-height:0;">
        <div class="cardhead">
          <div class="title">Chat</div>
          <div class="pill" id="pillMode">Mode: Standard</div>
        </div>

        <div class="banner" id="matchBanner"></div>

        <div id="chat"></div>

        <div class="composer">
          <textarea id="msg" placeholder="Type your message... (Enter to send, Shift+Enter for new line)"></textarea>
          <button id="sendBtn">Send</button>
        </div>

        <div class="hint" id="helperHint"></div>
      </div>

      <!-- Sidebar -->
      <div class="card" style="display:flex;flex-direction:column;min-height:0;">
        <div class="cardhead">
          <div class="title">Dallas Schedule + Menu</div>
          <div class="pill" id="pillLang">EN</div>
        </div>

        <div class="countdown">
          <div>
            <div class="label">World Cup countdown</div>
            <div class="sub" style="margin:4px 0 0;">Dallas / Arlington match days</div>
          </div>
          <div class="nums" id="countNums">
            <span><b id="d">0</b>d</span>
            <span><b id="h">0</b>h</span>
            <span><b id="m">0</b>m</span>
            <span><b id="s">0</b>s</span>
          </div>
        </div>

        <div class="matchday" id="matchdayBox"></div>

        <div class="sidepad" style="padding-bottom:0;">
          <div class="pill" style="display:inline-block;">Next upcoming match is highlighted</div>
        </div>

        <div class="schedule" id="schedule"></div>

        <div class="cardhead" style="border-top:1px solid var(--line); border-bottom:none;">
          <div class="title">Menu</div>
          <div class="pill">4 languages</div>
        </div>

        <div class="menu" id="menu"></div>
      </div>
    </div>
  </div>

  <script>
    // =========================================================
    // IMPORTANT: This rewrite keeps every feature you already had:
    // - multi-language toggle (EN/ES/PT/FR)
    // - chat w/ client-side history + session_id
    // - schedule rendering + next match highlight
    // - match-day mode banner/box
    // - countdown timer
    // - menu localized
    //
    // AND it is "app.py update friendly":
    // - it auto-detects / falls back across common endpoint changes
    // - it tolerates config shape changes (countdown_target names, etc.)
    // =========================================================

    // -----------------------
    // Session + state
    // -----------------------
    const sessionId = (localStorage.getItem("session_id") || (() => {
      const id = "sess_" + Math.random().toString(16).slice(2) + "_" + Date.now();
      localStorage.setItem("session_id", id);
      return id;
    })());

    let lang = localStorage.getItem("lang") || "en";

    // server-provided payloads
    let ui = null;
    let config = null;
    let scheduleData = null;

    // Conversation memory (client-side history)
    // NOTE: we keep this EXACT feature; we only sanitize outgoing shape to match server variants.
    const history = [];

    // DOM
    const chatEl = document.getElementById("chat");
    const msgEl = document.getElementById("msg");
    const sendBtn = document.getElementById("sendBtn");
    const helperHint = document.getElementById("helperHint");
    const pillLang = document.getElementById("pillLang");
    const pillMode = document.getElementById("pillMode");
    const matchBanner = document.getElementById("matchBanner");
    const matchdayBox = document.getElementById("matchdayBox");

    // -----------------------
    // Utilities
    // -----------------------
    function safeText(v){
      // Never inject server text via innerHTML by default (prevents XSS)
      return (v === null || v === undefined) ? "" : String(v);
    }

    function addBubble(role, text){
      const b = document.createElement("div");
      b.className = "bubble " + (role === "user" ? "user" : "bot");
      b.textContent = safeText(text);
      chatEl.appendChild(b);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function setSending(isSending){
      sendBtn.disabled = isSending;
      msgEl.disabled = isSending;
      sendBtn.textContent = isSending ? "..." : "Send";
    }

    async function fetchFirstOk(urls, options){
      // tries URLs in order, returns { url, res, json } for first that works
      let lastErr = null;
      for (const url of urls){
        try{
          const res = await fetch(url, options);
          if (!res.ok) {
            lastErr = new Error("HTTP " + res.status + " for " + url);
            continue;
          }
          const ct = (res.headers.get("content-type") || "").toLowerCase();
          const json = ct.includes("application/json") ? await res.json() : null;
          return { url, res, json };
        }catch(e){
          lastErr = e;
        }
      }
      throw lastErr || new Error("No endpoint succeeded.");
    }

    function normalizeUI(payload){
      // supports multiple possible server shapes
      // expected by your UI logic: ui.strings.welcome, ui.strings.helper, ui.strings.lang_set
      if (!payload) return { strings: { welcome: "Welcome!", helper: "", lang_set: "" } };

      if (payload.strings) return payload;

      // common alternative shape
      if (payload.ui && payload.ui.strings) return payload.ui;

      // if server returns flat keys
      const strings = payload.strings || payload;
      return {
        strings: {
          welcome: strings.welcome || strings.WELCOME || "Welcome!",
          helper: strings.helper || strings.HELPER || "",
          lang_set: strings.lang_set || strings.LANG_SET || ""
        }
      };
    }

    function normalizeConfig(payload){
      // supports config variations
      const p = payload || {};
      const countdown_target =
        p.countdown_target ||
        p.countdownTarget ||
        p.COUNTDOWN_TARGET ||
        p.target ||
        null;

      const business_rules = p.business_rules || p.businessRules || p.rules || {};
      return {
        ...p,
        countdown_target,
        business_rules
      };
    }

    function normalizeSchedule(payload){
      // expected scheduleData.matches: array
      // each match: {id, date(YYYY-MM-DD), time(HH:MM or TBD), stage, home, away}
      if (!payload) return { matches: [] };
      if (Array.isArray(payload.matches)) return payload;
      if (payload.schedule && Array.isArray(payload.schedule.matches)) return payload.schedule;
      if (Array.isArray(payload)) return { matches: payload };
      return { matches: [] };
    }

    function normalizeMenu(payload){
      // expected: { items: [...] } where each item: {name, desc, price}
      if (!payload) return { items: [] };
      if (Array.isArray(payload.items)) return payload;
      if (Array.isArray(payload.menu)) return { items: payload.menu };
      if (Array.isArray(payload)) return { items: payload };
      return { items: [] };
    }

    function normalizeChatResponse(payload){
      // common variants: {reply}, {message}, {assistant}, {output_text}, {data:{reply}}
      if (!payload) return { reply: "" };
      if (typeof payload === "string") return { reply: payload };

      const reply =
        payload.reply ||
        payload.message ||
        payload.assistant ||
        payload.output_text ||
        (payload.data && (payload.data.reply || payload.data.message)) ||
        "";

      return { reply: safeText(reply) };
    }

    // -----------------------
    // Language toggle
    // -----------------------
    function setLanguage(newLang){
      lang = newLang;
      localStorage.setItem("lang", lang);

      document.querySelectorAll(".langbtn").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.lang === lang);
      });

      pillLang.textContent = lang.toUpperCase();

      // refresh UI strings + menu
      loadUI(lang).then(() => {
        const msg = safeText(ui.strings.lang_set) + (ui.strings.helper ? ("\n\n" + safeText(ui.strings.helper)) : "");
        addBubble("assistant", msg.trim() || "Language updated.");
        history.push({ role: "assistant", content: msg.trim() || "Language updated." });
        helperHint.textContent = safeText(ui.strings.helper);
      }).catch(() => {
        // keep current features even if UI endpoint changed
        addBubble("assistant", "Language updated.");
        history.push({ role: "assistant", content: "Language updated." });
      });

      loadMenu(lang).catch(() => {});
    }

    document.querySelectorAll(".langbtn").forEach(btn => {
      btn.addEventListener("click", () => setLanguage(btn.dataset.lang));
    });

    // -----------------------
    // Fetchers (update-friendly)
    // -----------------------
    async function loadConfig(){
      const { json } = await fetchFirstOk(
        [
          "/api/config",
          "/config",
          "/api/settings",
          "/settings"
        ],
        { method: "GET" }
      );
      config = normalizeConfig(json);
    }

    async function loadUI(lang){
      const { json } = await fetchFirstOk(
        [
          "/api/ui?lang=" + encodeURIComponent(lang),
          "/ui?lang=" + encodeURIComponent(lang),
          "/api/i18n?lang=" + encodeURIComponent(lang),
          "/i18n?lang=" + encodeURIComponent(lang)
        ],
        { method: "GET" }
      );
      ui = normalizeUI(json);
      helperHint.textContent = safeText(ui.strings.helper);
    }

    async function loadSchedule(){
      const { json } = await fetchFirstOk(
        [
          "/api/schedule",
          "/schedule",
          "/api/matches",
          "/matches"
        ],
        { method: "GET" }
      );
      scheduleData = normalizeSchedule(json);
      renderSchedule();
      updateMatchDayMode();
    }

    async function loadMenu(lang){
      const { json } = await fetchFirstOk(
        [
          "/api/menu?lang=" + encodeURIComponent(lang),
          "/menu?lang=" + encodeURIComponent(lang),
          "/api/menu/" + encodeURIComponent(lang),
          "/menu/" + encodeURIComponent(lang)
        ],
        { method: "GET" }
      );
      const data = normalizeMenu(json);
      renderMenu(data.items);
    }

    // -----------------------
    // Countdown (safe local clock)
    // -----------------------
    function startCountdown(){
      const dEl = document.getElementById("d");
      const hEl = document.getElementById("h");
      const mEl = document.getElementById("m");
      const sEl = document.getElementById("s");

      // tolerate missing/renamed countdown target
      const targetISO = config && config.countdown_target ? config.countdown_target : null;
      const target = targetISO ? new Date(targetISO) : null;

      function tick(){
        if (!target || isNaN(target.getTime())){
          dEl.textContent = "0"; hEl.textContent = "0"; mEl.textContent = "0"; sEl.textContent = "0";
          return;
        }
        const now = new Date();
        let diff = Math.max(0, target - now);
        const days = Math.floor(diff / (1000*60*60*24));
        diff -= days*(1000*60*60*24);
        const hrs = Math.floor(diff / (1000*60*60));
        diff -= hrs*(1000*60*60);
        const mins = Math.floor(diff / (1000*60));
        diff -= mins*(1000*60);
        const secs = Math.floor(diff / 1000);

        dEl.textContent = String(days);
        hEl.textContent = String(hrs);
        mEl.textContent = String(mins);
        sEl.textContent = String(secs);
      }

      tick();
      setInterval(tick, 1000);
    }

    // -----------------------
    // Schedule rendering + next match highlight
    // -----------------------
    function renderSchedule(){
      const el = document.getElementById("schedule");
      el.innerHTML = "";

      const matchesIn = (scheduleData && Array.isArray(scheduleData.matches)) ? scheduleData.matches : [];
      const matches = matchesIn.slice().map(m => {
        const date = safeText(m.date);
        const time = safeText(m.time || "TBD");

        let ts = null;
        if (time && time !== "TBD"){
          // try Date.parse on ISO-ish
          ts = Date.parse(date + "T" + time + ":00");
        } else {
          ts = Date.parse(date + "T23:59:59");
        }

        return {
          id: safeText(m.id || ""),
          date,
          time,
          stage: safeText(m.stage || "Match"),
          home: safeText(m.home || "TBD"),
          away: safeText(m.away || "TBD"),
          ts: isNaN(ts) ? 0 : ts
        };
      });

      const now = Date.now();
      const upcoming = matches.filter(m => m.ts >= now).sort((a,b)=>a.ts-b.ts);
      const nextId = upcoming.length ? upcoming[0].id : null;

      matches.sort((a,b)=>a.ts-b.ts).forEach(m => {
        const row = document.createElement("div");
        row.className = "match" + (m.id && m.id === nextId ? " next" : "");

        const left = document.createElement("div");
        left.className = "left";

        const line1 = document.createElement("div");
        line1.innerHTML = "<b></b> ‚Ä¢ ";
        line1.querySelector("b").textContent = m.stage;
        // append "home vs away" safely
        line1.appendChild(document.createTextNode(m.home + " vs " + m.away));

        const line2 = document.createElement("div");
        line2.className = "when";
        const timeTxt = (m.time && m.time !== "TBD") ? m.time : "TBD";
        line2.textContent = m.date + " ‚Ä¢ " + timeTxt;

        left.appendChild(line1);
        left.appendChild(line2);

        const idPill = document.createElement("div");
        idPill.className = "pill";
        idPill.textContent = m.id || "";

        row.appendChild(left);
        row.appendChild(idPill);

        el.appendChild(row);
      });
    }

    function updateMatchDayMode(){
      const todayISO = new Date().toISOString().slice(0,10);
      const matchesIn = (scheduleData && Array.isArray(scheduleData.matches)) ? scheduleData.matches : [];
      const isMatch = matchesIn.some(m => safeText(m.date) === todayISO);

      if (isMatch){
        pillMode.textContent = "Mode: Match-day";

        const bannerText =
          (config && config.business_rules && config.business_rules.match_day_banner) ?
            safeText(config.business_rules.match_day_banner) :
            "Match-day hours";

        matchBanner.textContent = bannerText;
        matchBanner.classList.add("show");

        matchdayBox.textContent = "üèüÔ∏è Match-day mode is ON today. Expect higher traffic ‚Äî reserve early!";
        matchdayBox.classList.add("show");
      } else {
        pillMode.textContent = "Mode: Standard";
        matchBanner.classList.remove("show");
        matchdayBox.classList.remove("show");
      }
    }

    // -----------------------
    // Menu rendering
    // -----------------------
    function renderMenu(items){
      const el = document.getElementById("menu");
      el.innerHTML = "";

      (items || []).forEach(it => {
        const d = document.createElement("div");
        d.className = "menuitem";

        const name = document.createElement("div");
        name.className = "name";
        name.textContent = safeText(it.name);

        const desc = document.createElement("div");
        desc.className = "desc";
        desc.textContent = safeText(it.desc);

        const price = document.createElement("div");
        price.className = "price";
        price.textContent = safeText(it.price);

        d.appendChild(name);
        d.appendChild(desc);
        d.appendChild(price);

        el.appendChild(d);
      });
    }

    // -----------------------
    // Chat send (supports app.py endpoint changes)
    // -----------------------
    function buildChatPayload(message){
      // keep your original feature: send message + full history + session + lang
      // but also add alternate keys some backends might now expect.
      return {
        message,
        lang,
        session_id: sessionId,
        history: history.slice(), // preserve feature
        // compatibility extras (harmless if ignored)
        sessionId,
        messages: history.slice(),
        input: message
      };
    }

    async function sendMessage(){
      const text = msgEl.value.trim();
      if (!text) return;

      addBubble("user", text);
      history.push({ role:"user", content: text });

      msgEl.value = "";
      msgEl.style.height = "44px";
      setSending(true);

      try{
        const payload = buildChatPayload(text);

        const { json } = await fetchFirstOk(
          [
            "/chat",            // your original
            "/api/chat",        // common update
            "/api/message",     // alt
            "/message"          // alt
          ],
          {
            method:"POST",
            headers: { "Content-Type":"application/json" },
            body: JSON.stringify(payload)
          }
        );

        const out = normalizeChatResponse(json);
        const reply = out.reply || "Sorry ‚Äî no reply received.";

        addBubble("assistant", reply);
        history.push({ role:"assistant", content: reply });

      } catch(e){
        addBubble("assistant", "‚ö†Ô∏è Network error. Please try again.");
        history.push({ role:"assistant", content: "‚ö†Ô∏è Network error. Please try again." });
      } finally{
        setSending(false);
        msgEl.focus();
      }
    }

    sendBtn.addEventListener("click", sendMessage);

    // Enter to send, Shift+Enter newline
    msgEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Auto-grow textarea
    msgEl.addEventListener("input", () => {
      msgEl.style.height = "44px";
      msgEl.style.height = Math.min(msgEl.scrollHeight, 130) + "px";
    });

    // -----------------------
    // Init
    // -----------------------
    (async function init(){
      // restore language selection UI
      pillLang.textContent = lang.toUpperCase();
      document.querySelectorAll(".langbtn").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.lang === lang);
      });

      // Load server resources (update-friendly fallbacks)
      try { await loadConfig(); } catch (_) { config = normalizeConfig({}); }
      try { await loadUI(lang); } catch (_) { ui = normalizeUI({ strings: { welcome: "Welcome!", helper: "" , lang_set: "" } }); }
      try { await loadSchedule(); } catch (_) { scheduleData = normalizeSchedule({ matches: [] }); renderSchedule(); updateMatchDayMode(); }
      try { await loadMenu(lang); } catch (_) { renderMenu([]); }

      startCountdown();

      // Welcome bubble (keeps your existing feature)
      const welcome = ui && ui.strings && ui.strings.welcome ? safeText(ui.strings.welcome) : "Welcome!";
      addBubble("assistant", welcome);
      history.push({ role:"assistant", content: welcome });

      helperHint.textContent = safeText(ui.strings.helper || "");
    })();
  </script>
</body>
</html>