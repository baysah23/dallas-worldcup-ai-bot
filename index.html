<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dallas World Cup 2026 Concierge</title>
  <style>
    :root{
      --bg:#070a12;
      --panel:#0d1326;
      --panel2:#0b1020;
      --line:rgba(255,255,255,.10);
      --text:#eef2ff;
      --muted:#b9c3e6;
      --accent:#22c55e;
      --accent2:#60a5fa;
      --danger:#fb7185;
      --chip:#111a34;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(96,165,250,.18), transparent 55%),
        radial-gradient(1000px 500px at 90% 20%, rgba(34,197,94,.15), transparent 55%),
        radial-gradient(900px 500px at 50% 100%, rgba(251,113,133,.12), transparent 60%),
        var(--bg);
      color:var(--text);
      height:100vh;
      display:flex;
      justify-content:center;
    }

    .wrap{
      width:100%;
      max-width:1050px;
      display:flex;
      flex-direction:column;
      height:100vh;
    }

    header{
      padding:18px 18px 12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(13,19,38,.9), rgba(13,19,38,.6));
      backdrop-filter: blur(6px);
    }

    .topRow{
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:270px;
    }

    .title{
      font-size:16px;
      font-weight:800;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
    }

    .badge{
      font-size:11px;
      padding:4px 8px;
      border:1px solid var(--line);
      border-radius:999px;
      color:var(--muted);
      background:rgba(255,255,255,.05);
    }

    .subtitle{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }

    .rightTools{
      display:flex;
      gap:10px;
      align-items:flex-start;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .card{
      background:rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      min-width:220px;
    }
    .card h3{
      margin:0 0 6px;
      font-size:12px;
      color:var(--muted);
      font-weight:700;
      letter-spacing:.2px;
    }
    .countdown{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .pill{
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      border-radius:12px;
      padding:8px 10px;
      min-width:68px;
      text-align:center;
    }
    .pill .num{ font-size:16px; font-weight:900; }
    .pill .lab{ font-size:10px; color:var(--muted); }

    .langRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .langBtn{
      background:var(--chip);
      border:1px solid var(--line);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      font-weight:800;
      font-size:12px;
      cursor:pointer;
    }
    .langBtn.active{
      border-color:rgba(96,165,250,.55);
      box-shadow:0 0 0 2px rgba(96,165,250,.16);
    }

    .banner{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(34,197,94,.25);
      background: linear-gradient(90deg, rgba(34,197,94,.12), rgba(96,165,250,.10));
      color:var(--text);
      font-size:12px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .banner strong{ color:#dcfce7; }

    main{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:14px;
      padding:14px 18px;
      flex:1;
      min-height:0;
    }

    @media (max-width: 900px){
      main{ grid-template-columns: 1fr; }
    }

    .panel{
      background:rgba(255,255,255,.03);
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .panelHead{
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      background: rgba(13,19,38,.55);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .panelHead .hint{
      font-size:12px;
      color:var(--muted);
    }

    #chat{
      flex:1;
      overflow:auto;
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
    }

    .bubble{
      max-width: 78%;
      padding: 10px 12px;
      border-radius: 14px;
      line-height: 1.35;
      white-space: pre-wrap;
      word-wrap: break-word;
      border: 1px solid rgba(255,255,255,0.10);
    }

    .user{
      align-self:flex-end;
      background: rgba(96,165,250,.18);
      border-color: rgba(96,165,250,.35);
      border-bottom-right-radius: 6px;
    }

    .bot{
      align-self:flex-start;
      background: rgba(255,255,255,.05);
      border-bottom-left-radius: 6px;
    }

    .composer{
      padding:12px;
      border-top:1px solid var(--line);
      background: rgba(13,19,38,.55);
      display:flex;
      gap:10px;
      align-items:center;
    }

    textarea{
      flex:1;
      resize:none;
      height:44px;
      max-height:140px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25);
      color: var(--text);
      padding:10px 12px;
      font-size:14px;
      outline:none;
    }

    button.send{
      background: var(--accent);
      border:none;
      padding:10px 14px;
      border-radius:12px;
      font-size:14px;
      font-weight:900;
      color:#05210f;
      cursor:pointer;
      min-width:92px;
    }
    button.send:disabled{ opacity:.65; cursor:not-allowed; }

    .side{
      display:flex;
      flex-direction:column;
      gap:14px;
      min-height:0;
    }

    .scheduleList{
      padding:10px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:auto;
      min-height:0;
    }
    .match{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius:14px;
      padding:10px 10px;
    }
    .match .row1{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .tag{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-weight:800;
    }
    .match .when{
      font-weight:900;
      font-size:12px;
    }
    .match .who{
      margin-top:6px;
      font-size:13px;
      font-weight:900;
    }
    .match .meta{
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
    }

    .smallNote{
      font-size:12px;
      color:var(--muted);
      padding:10px 12px;
      border-top:1px solid var(--line);
      background: rgba(13,19,38,.55);
    }
    .smallNote code{
      background:rgba(255,255,255,.07);
      border:1px solid var(--line);
      padding:2px 6px;
      border-radius:8px;
      color:var(--text);
    }
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="topRow">
      <div class="brand">
        <div class="title">
          Dallas World Cup 2026 Concierge
          <span class="badge">Live • Reservations • Schedule</span>
        </div>
        <div class="subtitle">
          World Cup match-day help for Dallas-area businesses — ask about hours, specials, directions, or book a table.
          <br/>
          <span style="color:#dcfce7;font-weight:800;">Languages:</span>
          <span id="langsInline" style="color:var(--muted);">Auto, English, Español, Português, Français</span>
        </div>
      </div>

      <div class="rightTools">
        <div class="card">
          <h3>World Cup countdown</h3>
          <div class="countdown" id="countdown">
            <div class="pill"><div class="num" id="cdDays">--</div><div class="lab">days</div></div>
            <div class="pill"><div class="num" id="cdHours">--</div><div class="lab">hours</div></div>
            <div class="pill"><div class="num" id="cdMins">--</div><div class="lab">mins</div></div>
            <div class="pill"><div class="num" id="cdSecs">--</div><div class="lab">secs</div></div>
          </div>
        </div>

        <div class="card">
          <h3>Language</h3>
          <div class="langRow" id="langButtons"></div>
        </div>
      </div>
    </div>

    <div class="banner" id="matchdayBanner">
      <strong>Match day info:</strong> Loading…
    </div>
  </header>

  <main>
    <!-- CHAT -->
    <section class="panel">
      <div class="panelHead">
        <div class="hint">Tip: “Reservation for Cliff, 2145551212, 06/14/2026 at 3pm, party of 4”</div>
        <div class="hint">Or ask: “What time do you open on match days?”</div>
      </div>

      <div id="chat"></div>

      <div class="composer">
        <textarea id="msg" placeholder="Type your message... (Enter to send, Shift+Enter for new line)"></textarea>
        <button class="send" id="sendBtn" onclick="sendMessage()">Send</button>
      </div>
    </section>

    <!-- SCHEDULE -->
    <aside class="panel side">
      <div class="panelHead">
        <div class="hint"><strong>Dallas match schedule</strong></div>
        <div class="hint"><span class="tag">Dynamic from server</span></div>
      </div>

      <div class="scheduleList" id="scheduleList"></div>

      <div class="smallNote">
        Schedule loads from <code>/api/schedule</code>. You can update it by editing <code>matches_dallas.json</code> on the server/repo.
      </div>
    </aside>
  </main>
</div>

<script>
  // Conversation memory stored in the browser and sent each request
  const history = []; // {role:'user'|'assistant', content:'...'}
  let preferredLanguage = "auto"; // auto|en|es|pt|fr
  let config = null;

  const chatEl = document.getElementById("chat");
  const msgEl = document.getElementById("msg");
  const sendBtn = document.getElementById("sendBtn");

  function addBubble(role, text) {
    const div = document.createElement("div");
    div.className = "bubble " + (role === "user" ? "user" : "bot");
    div.textContent = text;
    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function setSending(isSending){
    sendBtn.disabled = isSending;
    msgEl.disabled = isSending;
    sendBtn.textContent = isSending ? "..." : "Send";
  }

  async function sendMessage() {
    const text = msgEl.value.trim();
    if (!text) return;

    addBubble("user", text);
    history.push({ role: "user", content: text });
    msgEl.value = "";
    msgEl.style.height = "44px";

    setSending(true);
    try{
      const res = await fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          message: text,
          history: history,
          preferred_language: preferredLanguage
        })
      });

      const data = await res.json();
      const reply = data.reply || "Sorry — no reply received.";
      addBubble("assistant", reply);
      history.push({ role: "assistant", content: reply });

    } catch (e){
      addBubble("assistant", "⚠️ Network error. Please try again.");
    } finally {
      setSending(false);
      msgEl.focus();
    }
  }

  // Enter to send, Shift+Enter for newline
  msgEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // Auto-grow textarea height
  msgEl.addEventListener("input", () => {
    msgEl.style.height = "44px";
    msgEl.style.height = Math.min(msgEl.scrollHeight, 140) + "px";
  });

  function renderLanguageButtons(langs){
    const container = document.getElementById("langButtons");
    container.innerHTML = "";

    langs.forEach(l => {
      const b = document.createElement("button");
      b.className = "langBtn" + (l.code === preferredLanguage ? " active" : "");
      b.textContent = l.label;
      b.onclick = () => {
        preferredLanguage = l.code;
        renderLanguageButtons(langs);

        // “toggle buttons that send instruction”
        // We do it safely by setting preferred_language for server system prompt.
        // Also add a small local message so user sees what happened.
        if (preferredLanguage === "auto") {
          addBubble("assistant", "Language set to Auto (I’ll reply in the language you use).");
          history.push({ role: "assistant", content: "Language set to Auto (I’ll reply in the language you use)." });
        } else {
          addBubble("assistant", `Language set to ${l.label}.`);
          history.push({ role: "assistant", content: `Language set to ${l.label}.` });
        }
      };
      container.appendChild(b);
    });

    // Update inline languages display
    document.getElementById("langsInline").textContent = langs.map(x => x.label).join(", ");
  }

  function startCountdown(isoLocal){
    // Safe/local countdown based on client clock
    const target = new Date(isoLocal);
    const cdDays = document.getElementById("cdDays");
    const cdHours = document.getElementById("cdHours");
    const cdMins = document.getElementById("cdMins");
    const cdSecs = document.getElementById("cdSecs");

    function tick(){
      const now = new Date();
      let diff = target - now;
      if (diff < 0) diff = 0;

      const totalSec = Math.floor(diff / 1000);
      const days = Math.floor(totalSec / (3600 * 24));
      const hours = Math.floor((totalSec % (3600 * 24)) / 3600);
      const mins = Math.floor((totalSec % 3600) / 60);
      const secs = totalSec % 60;

      cdDays.textContent = String(days);
      cdHours.textContent = String(hours).padStart(2, "0");
      cdMins.textContent = String(mins).padStart(2, "0");
      cdSecs.textContent = String(secs).padStart(2, "0");
    }

    tick();
    setInterval(tick, 1000);
  }

  function fmtDatePretty(yyyy_mm_dd){
    const [y,m,d] = yyyy_mm_dd.split("-").map(Number);
    const dt = new Date(y, m-1, d);
    return dt.toLocaleDateString(undefined, { weekday: "short", month: "short", day: "numeric", year: "numeric" });
  }

  async function loadSchedule(){
    const box = document.getElementById("scheduleList");
    box.innerHTML = `<div class="match"><div class="meta">Loading schedule…</div></div>`;
    try{
      const res = await fetch("/api/schedule");
      const data = await res.json();
      const matches = data.matches || [];
      box.innerHTML = "";

      matches.forEach(m => {
        const div = document.createElement("div");
        div.className = "match";

        const whenText = `${fmtDatePretty(m.date)} • ${m.time || "TBD"} ${m.tz || ""}`.trim();
        div.innerHTML = `
          <div class="row1">
            <div class="when">${whenText}</div>
            <div class="tag">${m.stage || "Match"}</div>
          </div>
          <div class="who">${m.match || "TBD"}</div>
          <div class="meta">${m.venue || ""}</div>
        `;
        box.appendChild(div);
      });

      if (!matches.length){
        box.innerHTML = `<div class="match"><div class="meta">No Dallas matches found.</div></div>`;
      }
    } catch(e){
      box.innerHTML = `<div class="match"><div class="meta">⚠️ Could not load schedule.</div></div>`;
    }
  }

  async function bootstrap(){
    // Config from server
    const res = await fetch("/api/config");
    config = await res.json();

    // Banner
    const banner = document.getElementById("matchdayBanner");
    banner.innerHTML = `<strong>Match day info:</strong> ${config.matchday_banner || "Welcome!"}`;

    // Languages
    renderLanguageButtons(config.supported_languages || [
      {code:"auto",label:"Auto"},
      {code:"en",label:"English"},
      {code:"es",label:"Español"},
      {code:"pt",label:"Português"},
      {code:"fr",label:"Français"},
    ]);

    // Countdown
    startCountdown(config.tournament_start_local || "2026-06-11T00:00:00");

    // Schedule
    await loadSchedule();

    // Greeting
    const greeting = "Hi! Want to book a table for a match day? Ask me anything.";
    addBubble("assistant", greeting);
    history.push({ role:"assistant", content: greeting });
  }

  bootstrap();
</script>

</body>
</html>