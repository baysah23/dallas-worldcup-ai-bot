<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>World Cup 2026 Dallas Concierge</title>

  <style>
    :root{
      --bg:#071022;
      --panel:#0f1b33;
      --panel2:#0b152c;
      --line:rgba(255,255,255,.12);
      --text:#eaf0ff;
      --muted:#b9c7ee;
      --accent:#2ea043;
      --accent2:#1f6feb;
      --warn:#ffcc66;
    }
    body{
      margin:0; height:100vh; display:flex; flex-direction:column;
      font-family: Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% 10%, #132a5b 0%, var(--bg) 55%);
      color:var(--text);
    }
    .wrap{max-width:1050px; width:100%; margin:0 auto; display:flex; flex-direction:column; height:100%;}
    header{
      padding:16px 18px;
      background: linear-gradient(90deg, #0b1733 0%, #0f1b33 55%, #102246 100%);
      border-bottom:1px solid var(--line);
    }
    .toprow{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    .brand{display:flex; gap:12px; align-items:center;}
    .badge{
      width:44px; height:44px; border-radius:12px;
      background: linear-gradient(135deg, #f5d76e 0%, #2ea043 45%, #1f6feb 100%);
      box-shadow: 0 10px 35px rgba(0,0,0,.25);
    }
    h1{margin:0; font-size:16px; font-weight:800; letter-spacing:.2px;}
    .sub{margin:6px 0 0; color:var(--muted); font-size:12px;}
    .langbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .langbtn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:8px 10px;
      border-radius:10px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .langbtn.active{background:rgba(46,160,67,.18); border-color:rgba(46,160,67,.45);}

    /* --- HERO banner (Session 1) --- */
    .hero{
      position:relative;
      margin:14px 14px 0;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      min-height:158px;
      box-shadow: 0 18px 55px rgba(0,0,0,.28);
      isolation:isolate;
    }
    .heroMedia{position:absolute; inset:0; background:#000;}
    .heroLayer{position:absolute; inset:0; opacity:0; transition: opacity 900ms ease;}
    .heroLayer.on{opacity:1;}
    .heroBg{
      position:absolute; inset:-10%;
      background-size:cover;
      background-position:center 22%;
      filter: blur(18px) saturate(1.05) contrast(1.08);
      transform: scale(1.10);
      opacity:.96;
    }
    .heroFg{
      position:absolute; inset:0;
      background-repeat:no-repeat;
      background-size:contain;         /* keeps the player visible */
      background-position:center 52%;  /* chest/face sits nicely */
      filter: drop-shadow(0 18px 45px rgba(0,0,0,.58));
      opacity:1;
    }
    .heroScrim{
      position:absolute; inset:0;
      background:
        linear-gradient(90deg, rgba(7,16,34,.78) 0%, rgba(7,16,34,.48) 45%, rgba(7,16,34,.86) 100%),
        radial-gradient(900px 340px at 20% 20%, rgba(245,215,110,.18) 0%, rgba(0,0,0,0) 60%),
        radial-gradient(900px 380px at 70% 25%, rgba(31,111,235,.14) 0%, rgba(0,0,0,0) 62%),
        radial-gradient(1100px 520px at 55% 115%, rgba(0,0,0,0) 0%, rgba(0,0,0,.55) 70%);
      pointer-events:none;
      z-index:4;
    }
    /* Crowd bloom (light + atmosphere) */
    .heroBloom{
      position:absolute; inset:-10%;
      background:
        radial-gradient(620px 240px at 18% 28%, rgba(245,215,110,.20) 0%, rgba(0,0,0,0) 65%),
        radial-gradient(740px 300px at 78% 30%, rgba(31,111,235,.18) 0%, rgba(0,0,0,0) 62%),
        radial-gradient(720px 340px at 55% 80%, rgba(46,160,67,.14) 0%, rgba(0,0,0,0) 62%);
      mix-blend-mode: screen;
      opacity:.85;
      pointer-events:none;
      z-index:2;
      animation: bloomPulse 7.6s ease-in-out infinite;
    }
    @keyframes bloomPulse{
      0%{transform:translateY(0) scale(1);}
      50%{transform:translateY(-2px) scale(1.02);}
      100%{transform:translateY(0) scale(1);}
    }
    /* Smoke haze (subtle, animated) */
    .heroSmoke{
      position:absolute; inset:-20% -30%;
      background:
        radial-gradient(520px 280px at 18% 38%, rgba(255,255,255,.08) 0%, rgba(0,0,0,0) 70%),
        radial-gradient(560px 300px at 62% 40%, rgba(255,255,255,.07) 0%, rgba(0,0,0,0) 72%),
        radial-gradient(520px 320px at 45% 74%, rgba(255,255,255,.06) 0%, rgba(0,0,0,0) 72%);
      filter: blur(18px);
      opacity:.55;
      pointer-events:none;
      z-index:3;
      animation: smokeDrift 9.5s ease-in-out infinite;
    }
    @keyframes smokeDrift{
      0%{transform:translateX(-2%) translateY(0);}
      50%{transform:translateX(2%) translateY(-1.5%);}
      100%{transform:translateX(-2%) translateY(0);}
    }
    /* Light sweep */
    .hero:before{
      content:"";
      position:absolute;
      inset:-40% -30%;
      background: linear-gradient(110deg, rgba(255,255,255,0) 32%, rgba(255,255,255,.10) 50%, rgba(255,255,255,0) 68%);
      transform: translateX(-55%) rotate(8deg);
      animation: heroSweep 6.2s ease-in-out infinite;
      pointer-events:none;
      z-index:5;
      mix-blend-mode: overlay;
    }
    @keyframes heroSweep{
      0%{transform: translateX(-55%) rotate(8deg);}
      50%{transform: translateX(25%) rotate(8deg);}
      100%{transform: translateX(55%) rotate(8deg);}
    }
    .heroContent{
      position:relative;
      z-index:6;
      padding:16px 18px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .heroKicker{
      font-weight:900;
      letter-spacing:.9px;
      text-transform:uppercase;
      font-size:13px;
      color:#f5d76e;
      text-shadow: 0 2px 18px rgba(0,0,0,.45);
    }
    .heroSub{
      color:var(--text);
      font-size:12px;
      max-width:760px;
      line-height:1.25;
      opacity:.95;
    }
    .heroChips{display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:2px;}
    .heroChip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      font-size:12px;
      color:var(--text);
      backdrop-filter: blur(6px);
    }
    .heroDot{
      width:8px; height:8px; border-radius:999px;
      background: rgba(46,160,67,.82);
      box-shadow: 0 0 0 6px rgba(46,160,67,.12);
    }
    /* rotating flag rail (visible + tasteful) */
    .flagRail{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:6px;}
    .flagPill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      font-size:12px;
      color:var(--text);
      backdrop-filter: blur(6px);
    }
    .flagEmoji{
      font-size:16px;
      line-height:1;
      transform: translateY(1px);
    }
    .twemoji{width:18px; height:18px; vertical-align:-3px;}
    .hero:hover:before{animation-play-state:paused;}

    /* --- Main grid --- */
    .grid{
      display:grid;
      grid-template-columns: 1.45fr .55fr;
      gap:14px;
      padding:14px;
      flex:1;
      min-height:0;
    }
    @media (max-width: 950px){ .grid{grid-template-columns:1fr;} }

    /* Left column: compact menu + wide chat (desktop) */
    .leftcol{
      display:grid;
      grid-template-columns: 170px 1fr; /* Menu | Chat */
      gap:14px;
      min-height:0;
      height:100%;
      align-items:stretch;
    }
    @media (max-width: 950px){ .leftcol{grid-template-columns:1fr;} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06) 0%, rgba(255,255,255,.03) 100%);
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
      min-height:0;
    }
    .cardhead{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(0,0,0,.12);
    }
    .cardhead .title{font-weight:800; font-size:13px;}
    .pill{
      font-size:11px;
      color:var(--muted);
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      background:rgba(0,0,0,.12);
      white-space:nowrap;
    }

    .chatcard{display:flex; flex-direction:column; min-height:0;}
    .menucard{display:flex; flex-direction:column; min-height:0; max-width:190px; max-height:460px;}
    @media (max-width: 950px){ .menucard{max-width:none; max-height:none;} }

    .banner{
      padding:10px 14px;
      border-bottom:1px dashed rgba(255,255,255,.16);
      color:var(--warn);
      font-size:12px;
      display:none;
    }
    .banner.show{display:block;}

    #chat{padding:14px; height:100%; overflow:auto; display:flex; flex-direction:column; gap:8px;}
    .bubble{
      max-width:78%;
      padding:8px 10px;
      border-radius:14px;
      line-height:1.28;
      white-space:pre-wrap;
      word-wrap:break-word;
      border:1px solid rgba(255,255,255,.10);
      font-size:13px;
    }
    .user{align-self:flex-end; background: rgba(31,111,235,.22); border-color: rgba(31,111,235,.35);}
    .bot{align-self:flex-start; background: rgba(0,0,0,.18); font-size:12px;}

    .composer{
      display:flex;
      gap:10px;
      padding:12px 14px;
      border-top:1px solid var(--line);
      background: rgba(0,0,0,.12);
      align-items:center;
    }
    textarea{
      flex:1;
      resize:none;
      height:44px;
      max-height:130px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color:var(--text);
      padding:10px 12px;
      font-size:13px;
      outline:none;
    }
    button{
      background: var(--accent);
      border:none;
      padding:10px 14px;
      border-radius:12px;
      font-size:14px;
      font-weight:800;
      color:#fff;
      cursor:pointer;
      min-width:92px;
    }
    button.secondary{
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      color: var(--text);
      min-width:88px;
    }
    button.secondary:hover{background: rgba(255,255,255,.14);}
    button:disabled{opacity:.6; cursor:not-allowed;}

    .hint{
      padding:10px 14px;
      font-size:12px;
      color:var(--muted);
      border-top:1px dashed rgba(255,255,255,.14);
    }
    code{background:rgba(255,255,255,.10); padding:2px 6px; border-radius:8px;}

    /* Sidebar */
    .sidepad{padding:12px 14px;}
    .countdown{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid var(--line);
    }
    .countdown .label{font-size:12px; color:var(--muted); font-weight:700;}
    .countdown .nums{
      display:flex;
      gap:10px;
      align-items:baseline;
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
    }
    .nums span{color:var(--text);}
    .nums b{color:#f5d76e;}

    .schedule{flex:1; min-height:160px; overflow:auto;}
    .match{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:9px 10px;
      border-top:1px solid rgba(255,255,255,.10);
      font-size:12px;
    }
    .match .left{display:flex; flex-direction:column; gap:2px;}
    .match .when{color:var(--muted);}
    .match.next{background: rgba(46,160,67,.18); border-top:1px solid rgba(46,160,67,.35);}
    .vs{opacity:.8; margin:0 6px; font-weight:800;}

    .matchday{
      margin:12px 14px 0;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(245,215,110,.35);
      background: rgba(245,215,110,.10);
      font-size:12px;
      display:none;
    }
    .matchday.show{display:block;}

    /* Menu */
    .menu{padding:8px 8px 10px; font-size:9px; line-height:1.25; display:flex; flex-direction:column; gap:8px; overflow:auto; max-height:390px;}
    @media (max-width: 950px){ .menu{max-height:none;} }

    .menuitem{
      padding:7px 7px;
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      background: linear-gradient(135deg, rgba(31,111,235,.16) 0%, rgba(0,0,0,.18) 55%, rgba(46,160,67,.10) 100%);
      position:relative;
      overflow:hidden;
    }
    .menuitem:before{
      content:"";
      position:absolute;
      inset:-1px;
      background: radial-gradient(220px 90px at 15% 10%, rgba(245,215,110,.18) 0%, rgba(0,0,0,0) 60%);
      pointer-events:none;
    }
    .menuitem .name{font-weight:900; font-size:11px; letter-spacing:.15px;}
    .menuitem .desc{color:var(--muted); margin-top:3px; font-size:9px; line-height:1.25;}
    .menuTop{display:flex; align-items:flex-start; justify-content:space-between; gap:10px;}
    .menuBadge{
      border:1px solid rgba(245,215,110,.35);
      background: rgba(245,215,110,.10);
      padding:4px 8px;
      border-radius:999px;
      font-size:11px;
      color:#f5d76e;
      white-space:nowrap;
    }
    .menuMeta{margin-top:6px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    .menuTag{
      font-size:11px;
      color:var(--muted);
      border:1px solid rgba(255,255,255,.12);
      padding:3px 8px;
      border-radius:999px;
      background:rgba(0,0,0,.10);
    }

    /* Announcer emphasis */
    .banner.show, .matchday.show{
      text-transform:uppercase;
      letter-spacing:.7px;
      font-weight:900;
    }
    .banner.show{
      background: linear-gradient(90deg, rgba(245,215,110,.18) 0%, rgba(46,160,67,.10) 40%, rgba(31,111,235,.10) 100%);
      border-bottom: 1px solid rgba(245,215,110,.35);
      text-shadow: 0 2px 18px rgba(0,0,0,.35);
      animation: announcerPulse 1.6s ease-in-out infinite;
    }
    @keyframes announcerPulse{
      0%{transform:translateY(0); filter:brightness(1);}
      50%{transform:translateY(-1px); filter:brightness(1.08);}
      100%{transform:translateY(0); filter:brightness(1);}
    }

    /* Compact mode */
    .compact #chat{gap:6px;}
    .compact .bubble{padding:7px 9px; line-height:1.22;}
    .compact .user{font-size:12.5px;}
    .compact .bot{font-size:11.5px;}
    .compact textarea{height:40px; font-size:13px; padding:9px 11px;}
    .compact .composer{padding:10px 12px;}
    .compact .match{padding:8px 9px; font-size:11px;}
    .compact .pill{padding:5px 9px; font-size:10.5px;}
    .compact .cardhead{padding:10px 12px;}
    .compact .menu{font-size:8.5px;}
  
    /* --- HERO banner upgrades (Session 1+) --- */
    /* Make the player feel more "hero / action figure" */
    .hero{ min-height:190px; }
    @media (max-width: 950px){ .hero{ min-height:175px; } }

    /* Foreground player: bigger + punchier */
    .heroFg{
      background-size: 118% auto;     /* larger than container */
      background-position: 62% 55%;   /* default: slightly right so face is centered in wide banner */
      filter:
        drop-shadow(0 20px 55px rgba(0,0,0,.62))
        contrast(1.06)
        saturate(1.05);
      opacity: 1;
    }

    /* Add a subtle film grain + stadium sparkles */
    .heroGrain{
      position:absolute; inset:0;
      background-image:
        radial-gradient(1px 1px at 12% 22%, rgba(255,255,255,.18) 0%, rgba(0,0,0,0) 55%),
        radial-gradient(1px 1px at 28% 65%, rgba(255,255,255,.16) 0%, rgba(0,0,0,0) 55%),
        radial-gradient(1px 1px at 66% 36%, rgba(255,255,255,.14) 0%, rgba(0,0,0,0) 55%),
        radial-gradient(1px 1px at 82% 58%, rgba(255,255,255,.15) 0%, rgba(0,0,0,0) 55%),
        repeating-linear-gradient(0deg, rgba(255,255,255,.03) 0px, rgba(255,255,255,.03) 1px, rgba(0,0,0,0) 2px, rgba(0,0,0,0) 4px);
      opacity:.28;
      mix-blend-mode: overlay;
      pointer-events:none;
      z-index:3; /* above bloom/smoke, under scrim */
    }

    /* Continuous scrolling flag marquee across the banner */
    .flagMarquee{
      margin-top:8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      overflow:hidden;
      height:34px;
      display:flex;
      align-items:center;
      position:relative;
      backdrop-filter: blur(6px);
    }
    .flagMarquee:before,
    .flagMarquee:after{
      content:"";
      position:absolute;
      top:0; bottom:0;
      width:60px;
      pointer-events:none;
      z-index:2;
    }
    .flagMarquee:before{
      left:0;
      background: linear-gradient(90deg, rgba(0,0,0,.55) 0%, rgba(0,0,0,0) 100%);
    }
    .flagMarquee:after{
      right:0;
      background: linear-gradient(270deg, rgba(0,0,0,.55) 0%, rgba(0,0,0,0) 100%);
    }
    .flagTrack{
      display:flex;
      align-items:center;
      gap:14px;
      padding:0 16px;
      white-space:nowrap;
      will-change: transform;
      animation: flagScroll 38s linear infinite;
    }
    .flagTrack:hover{ animation-play-state: paused; }
    @keyframes flagScroll{
      0%{transform:translateX(0);}
      100%{transform:translateX(-50%);} /* because we duplicate the track */
    }
    .flagItem{
      display:inline-flex;
      align-items:center;
      gap:8px;
      color:var(--text);
      opacity:.98;
      font-size:12px;
      letter-spacing:.2px;
    }
    .flagItem .flagEmoji{ font-size:16px; line-height:1; transform: translateY(1px); }
    .flagItem b{ font-weight:900; }
    .twemoji{width:18px; height:18px; vertical-align:-3px;}

  </style>

  <!-- Optional: Twemoji makes flags consistently visible across platforms -->
  <script src="https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js" crossorigin="anonymous"></script>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="toprow">
        <div class="brand">
          <div class="badge" aria-hidden="true"></div>
          <div>
            <h1>World Cup 2026 ‚Ä¢ Dallas Match-Day Concierge</h1>
            <div class="sub">Reserve tables, see Dallas match schedule, and chat in English ‚Ä¢ Espa√±ol ‚Ä¢ Portugu√™s ‚Ä¢ Fran√ßais</div>
          </div>
        </div>

        <div class="langbar" aria-label="Language toggle">
          <div class="langbtn active" data-lang="en">English</div>
          <div class="langbtn" data-lang="es">Espa√±ol</div>
          <div class="langbtn" data-lang="pt">Portugu√™s</div>
          <div class="langbtn" data-lang="fr">Fran√ßais</div>
        </div>
      </div>
    </header>

    <!-- HERO banner (ABOVE menu/chat/schedule) -->
    <div class="hero" id="heroBanner" aria-label="World Cup 2026 hero banner">
      <div class="heroMedia" aria-hidden="true">
        <div class="heroLayer" id="heroLayerA">
          <div class="heroBg" id="heroBgA"></div>
          <div class="heroFg" id="heroFgA"></div>
        </div>
        <div class="heroLayer" id="heroLayerB">
          <div class="heroBg" id="heroBgB"></div>
          <div class="heroFg" id="heroFgB"></div>
        </div>

        <div class="heroBloom"></div>
        <div class="heroSmoke"></div>
        <div class="heroGrain"></div>
        <div class="heroScrim"></div>
      </div>

      <div class="heroContent">
        <div class="heroKicker">WORLD CUP 2026 ‚Ä¢ DALLAS MATCH DAY HQ</div>
        <div class="heroSub">A cinematic match-day hub for fans: chat, reserve tables, and browse the schedule ‚Äî all in one place.</div>
        <div class="heroChips" id="heroChips"></div>
        <div class="flagMarquee" id="flagMarquee" aria-label="World Cup country flags">
          <div class="flagTrack" id="flagTrack"></div>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- Left column: Menu + Chat -->
      <div class="leftcol">
        <!-- Menu -->
        <div class="card menucard">
          <div class="cardhead">
            <div class="title" id="menuTitle">Menu</div>
            <div class="pill" id="menuPill">4 languages</div>
          </div>
          <div class="menu" id="menu"></div>
        </div>

        <!-- Chat / Reservations -->
        <div class="card chatcard">
          <div class="cardhead">
            <div class="title" id="chatTitle">Chat</div>
            <div style="display:flex; gap:8px; align-items:center;">
              <div class="pill" id="pillMode">Live</div>
              <button id="compactToggle" class="secondary" style="min-width:auto; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:800;">Compact</button>
            </div>
          </div>

          <div class="banner" id="matchBanner"></div>
          <div id="chat"></div>

          <div class="composer">
            <textarea id="msg" placeholder="Type here..."></textarea>
            <button id="sendBtn">Send</button>
            <button id="clearBtn" class="secondary">Clear</button>
          </div>

          <div class="hint" id="helperHint"></div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="card" style="display:flex;flex-direction:column;min-height:0;">
        <div class="cardhead">
          <div class="title" id="sideTitle">Dallas Schedule</div>
          <div class="pill" id="pillLang">EN</div>
        </div>

        <div class="countdown">
          <div>
            <div class="label" id="countLabel">World Cup countdown</div>
            <div class="sub" style="margin:4px 0 0;" id="countSub">Dallas / Arlington match days</div>
          </div>
          <div class="nums" id="countNums">
            <span><b id="d">0</b>d</span>
            <span><b id="h">0</b>h</span>
            <span><b id="m">0</b>m</span>
            <span><b id="s">0</b>s</span>
          </div>
        </div>

        <div class="matchday" id="matchdayBox"></div>

        <div class="sidepad" style="padding-top:10px; padding-bottom:0;">
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <div class="pill" style="padding:6px 10px;">Schedule</div>
            <div class="langbar" style="gap:6px;">
              <div class="langbtn active" id="scopeDallas">Dallas</div>
              <div class="langbtn" id="scopeAll">All Matches</div>
            </div>
          </div>
          <div style="margin-top:10px; display:flex; gap:10px; align-items:center;">
            <input id="teamSearch" placeholder="Search team / venue / date (e.g., June 13 or 2026-06-13)..." style="flex:1; height:40px; border-radius:12px; border:1px solid rgba(255,255,255,.14); background: rgba(0,0,0,.22); color:var(--text); padding:0 12px; font-size:13px; outline:none;" />
            <div class="pill" id="matchCount">0</div>
          </div>
        </div>

        <div class="sidepad" style="padding-bottom:0;">
          <div class="pill" style="display:inline-block;" id="nextHint">Next upcoming match is highlighted</div>
        </div>

        <div class="schedule" id="schedule"></div>

        <div class="sidepad" id="pager" style="display:none; padding-top:10px;">
          <div style="display:flex; gap:10px; align-items:center; justify-content:space-between;">
            <button id="prevPage" class="secondary" style="min-width:88px;">Prev</button>
            <div class="pill" id="pageIndicator">Page 1 of 1</div>
            <button id="nextPage" class="secondary" style="min-width:88px;">Next</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/**
 * Frontend endpoints (unchanged):
 *  - GET /schedule.json?scope=dallas|all&q=...
 *  - GET /menu.json?lang=en|es|pt|fr
 *  - POST /chat { message, session_id, language, history }
 */

// -----------------------
// Session + state
// -----------------------
const sessionId = (localStorage.getItem("session_id") || (() => {
  const id = "sess_" + Math.random().toString(16).slice(2) + "_" + Date.now();
  localStorage.setItem("session_id", id);
  return id;
})());

let lang = localStorage.getItem("lang") || "en";
let scheduleData = null;
let scope = localStorage.getItem("schedule_scope") || "dallas";
let scheduleQuery = "";

// Pagination sizes (restore expected behavior)
const PAGE_SIZE_DALLAS = 5;
const PAGE_SIZE_ALL = 10;
function pageSize(){ return (scope === "all") ? PAGE_SIZE_ALL : PAGE_SIZE_DALLAS; }
let currentPage = 1;

// Conversation memory (client-side history) ‚Äî kept
const history = [];

// DOM refs
const chatEl = document.getElementById("chat");
const msgEl = document.getElementById("msg");
const sendBtn = document.getElementById("sendBtn");
const helperHint = document.getElementById("helperHint");
const pillLang = document.getElementById("pillLang");
const pillMode = document.getElementById("pillMode");
const matchBanner = document.getElementById("matchBanner");
const matchdayBox = document.getElementById("matchdayBox");

const clearBtn = document.getElementById("clearBtn");
const scopeDallasBtn = document.getElementById("scopeDallas");
const scopeAllBtn = document.getElementById("scopeAll");
const teamSearchEl = document.getElementById("teamSearch");
const matchCountEl = document.getElementById("matchCount");
const pagerEl = document.getElementById("pager");
const prevPageBtn = document.getElementById("prevPage");
const nextPageBtn = document.getElementById("nextPage");
const pageIndicatorEl = document.getElementById("pageIndicator");

// -----------------------
// HERO banner (Session 1) ‚Äî UI-only
// (Wikimedia images: stable + typically high-res; "contain" keeps faces visible)
// -----------------------
const HERO_SLIDES = [
  { name: "Kylian Mbapp√©", country: "France", flag: "üá´üá∑",
    img: "https://upload.wikimedia.org/wikipedia/commons/9/96/Kylian_Mbapp%C3%A9_2019.jpg",
    fgPos: "60% 52%", bgPos: "center 25%" },

  { name: "Lionel Messi", country: "Argentina", flag: "üá¶üá∑",
    img: "https://upload.wikimedia.org/wikipedia/commons/8/89/Lionel_Messi_20180626.jpg",
    fgPos: "58% 54%", bgPos: "center 22%" },

  { name: "Erling Haaland", country: "Norway", flag: "üá≥üá¥",
    img: "https://upload.wikimedia.org/wikipedia/commons/0/0d/Erling_Haaland_2023_%28cropped%29.jpg",
    fgPos: "62% 54%", bgPos: "center 26%" },

  { name: "Jude Bellingham", country: "England", flag: "üè¥",
    img: "https://upload.wikimedia.org/wikipedia/commons/5/5c/Jude_Bellingham_2022.jpg",
    fgPos: "62% 54%", bgPos: "center 25%" },

  { name: "Vin√≠cius J√∫nior", country: "Brazil", flag: "üáßüá∑",
    img: "https://upload.wikimedia.org/wikipedia/commons/6/6a/Vinicius_Junior_2022.jpg",
    fgPos: "60% 55%", bgPos: "center 25%" },

  { name: "Neymar Jr.", country: "Brazil", flag: "üáßüá∑",
    img: "https://upload.wikimedia.org/wikipedia/commons/8/83/Neymar_2018.jpg",
    fgPos: "60% 56%", bgPos: "center 24%" },

  { name: "Pedri", country: "Spain", flag: "üá™üá∏",
    img: "https://upload.wikimedia.org/wikipedia/commons/8/80/Pedri_2021.jpg",
    fgPos: "60% 56%", bgPos: "center 25%" },

  { name: "Jamal Musiala", country: "Germany", flag: "üá©üá™",
    img: "https://upload.wikimedia.org/wikipedia/commons/0/0d/Jamal_Musiala_2022.jpg",
    fgPos: "60% 56%", bgPos: "center 25%" },

  { name: "Florian Wirtz", country: "Germany", flag: "üá©üá™",
    img: "https://upload.wikimedia.org/wikipedia/commons/8/8b/Florian_Wirtz_2022.jpg",
    fgPos: "60% 56%", bgPos: "center 25%" },

  { name: "Bukayo Saka", country: "England", flag: "üè¥",
    img: "https://upload.wikimedia.org/wikipedia/commons/a/a3/Bukayo_Saka_2022.jpg",
    fgPos: "60% 56%", bgPos: "center 25%" },

  { name: "Alphonso Davies", country: "Canada", flag: "üá®üá¶",
    img: "https://upload.wikimedia.org/wikipedia/commons/1/1c/Alphonso_Davies_2019.jpg",
    fgPos: "60% 56%", bgPos: "center 25%" },

  { name: "Endrick", country: "Brazil", flag: "üáßüá∑",
    img: "https://upload.wikimedia.org/wikipedia/commons/2/21/Endrick_2023.jpg",
    fgPos: "60% 56%", bgPos: "center 25%" },

  { name: "Cristiano Ronaldo", country: "Portugal", flag: "üáµüáπ",
    img: "https://upload.wikimedia.org/wikipedia/commons/8/8c/Cristiano_Ronaldo_2018.jpg",
    fgPos: "60% 54%", bgPos: "center 23%" }
];

let heroIdx = 0;
let heroTimer = null;
let heroUseA = true;
let heroPaused = false;

const heroBannerEl = document.getElementById("heroBanner");
const heroLayerA = document.getElementById("heroLayerA");
const heroLayerB = document.getElementById("heroLayerB");
const heroBgA = document.getElementById("heroBgA");
const heroFgA = document.getElementById("heroFgA");
const heroBgB = document.getElementById("heroBgB");
const heroFgB = document.getElementById("heroFgB");
const heroChips = document.getElementById("heroChips");
const flagTrackEl = document.getElementById("flagTrack");

// Render emoji as SVG using Twemoji (helps "flags not visible" on some systems)
// -----------------------
// World flags marquee (continuous scroll)
// -----------------------
// Note: 2026 qualifiers are not final here; this UI list is a broad "World Cup nations" vibe.
// If your /schedule.json?scope=all includes country names, you can later derive this dynamically.
// For now we provide a rich set of common WC nations + hosts (48-ish vibe).
const WORLD_FLAG_EMOJIS = [
  "üá∫üá∏","üá≤üáΩ","üá®üá¶","üá¶üá∑","üáßüá∑","üá∫üáæ","üá®üá¥","üá™üá®","üá®üá±","üáµüá™","üáµüáæ",
  "üá´üá∑","üá©üá™","üá™üá∏","üáµüáπ","üáÆüáπ","üá≥üá±","üáßüá™","üá≠üá∑","üá©üá∞","üá∏üá™","üá≥üá¥","üá®üá≠","üá¶üáπ","üáµüá±","üá∫üá¶","üá∑üá∏","üáπüá∑","üá¨üá∑","üá®üáø","üá≠üá∫","üá∑üá¥",
  "üè¥","üè¥","üè¥", /* UK home nations (England/Scotland/Wales) */
  "üáØüáµ","üá∞üá∑","üá¶üá∫","üá≥üáø","üáÆüá∑","üá∏üá¶","üá∂üá¶","üá¶üá™","üáÆüá∂",
  "üá≤üá¶","üá∏üá≥","üá¨üá≠","üá≥üá¨","üá®üá≤","üáπüá≥","üá©üáø","üáøüá¶","üá™üá¨","üá®üáÆ","üá≤üá±"
];

function buildFlagMarquee(){
  if (!flagTrackEl) return;

  // Build a long rail, then duplicate it once for seamless scroll.
  const base = WORLD_FLAG_EMOJIS.map(f => `<span class="flagItem"><span class="flagEmoji">${f}</span></span>`).join("");
  flagTrackEl.innerHTML = base + base;

  renderTwemoji(flagTrackEl);

  // Ensure animation restarts cleanly (useful after hot reload)
  flagTrackEl.style.animation = "none";
  // force reflow
  void flagTrackEl.offsetHeight;
  flagTrackEl.style.animation = "";
}

function renderTwemoji(node){
  try{
    if (window.twemoji && node){
      window.twemoji.parse(node, {folder: "svg", ext: ".svg", className: "twemoji"});
    }
  }catch(e){}
}

function setHeroSlide(idx){
  const s = HERO_SLIDES[idx % HERO_SLIDES.length];

  const nextWrap = heroUseA ? heroLayerA : heroLayerB;
  const nextBg = heroUseA ? heroBgA : heroBgB;
  const nextFg = heroUseA ? heroFgA : heroFgB;

  const prevWrap = heroUseA ? heroLayerB : heroLayerA;

  if (nextBg){
    nextBg.style.backgroundImage = `url('${s.img}')`;
    nextBg.style.backgroundPosition = s.bgPos || "center 22%";
  }
  if (nextFg){
    nextFg.style.backgroundImage = `url('${s.img}')`;
    nextFg.style.backgroundPosition = s.fgPos || "center 54%";
  }

  if (nextWrap) nextWrap.classList.add("on");
  if (prevWrap) prevWrap.classList.remove("on");

  if (heroChips){
    heroChips.innerHTML = `
      <span class="heroChip"><span class="heroDot"></span> Live ‚Ä¢ Dallas</span>
      <span class="heroChip"><span class="flagEmoji">${s.flag}</span> <b>${escapeHtml(s.name)}</b> ‚Ä¢ ${escapeHtml(s.country)}</span>
      <span class="heroChip">AT&amp;T Stadium ‚Ä¢ Arlington</span>
    `;
    renderTwemoji(heroChips);
  }
  // World flags marquee is managed separately (continuous scroll)

  heroUseA = !heroUseA;
}

function startHeroRotation(){
  if (!heroBannerEl || !heroLayerA || !heroLayerB || !heroBgA || !heroFgA || !heroBgB || !heroFgB) return;

  // initial
  setHeroSlide(heroIdx);

  // rotate
  if (heroTimer) clearInterval(heroTimer);
  heroTimer = setInterval(() => {
    if (heroPaused) return;
    heroIdx = (heroIdx + 1) % HERO_SLIDES.length;
    setHeroSlide(heroIdx);
  }, 5200);

  // pause on hover (bind once)
  if (!heroBannerEl.dataset.bound){
    heroBannerEl.addEventListener("mouseenter", () => { heroPaused = true; });
    heroBannerEl.addEventListener("mouseleave", () => { heroPaused = false; });
    heroBannerEl.dataset.bound = "1";
  }
}

// -----------------------
// Compact mode
// -----------------------
let compactMode = (localStorage.getItem("compact_mode") || "0") === "1";
const compactToggleBtn = document.getElementById("compactToggle");

function applyCompactMode(){
  document.body.classList.toggle("compact", compactMode);
  if (compactToggleBtn){
    compactToggleBtn.textContent = compactMode ? "Compact: ON" : "Compact";
    compactToggleBtn.classList.toggle("active", compactMode);
  }
}

if (compactToggleBtn){
  compactToggleBtn.addEventListener("click", () => {
    compactMode = !compactMode;
    localStorage.setItem("compact_mode", compactMode ? "1" : "0");
    applyCompactMode();
  });
}

// -----------------------
// Copy strings (preserve existing behavior)
// -----------------------
const STRINGS = {
  en: {
    welcome: "‚öΩ Welcome, World Cup fan! I‚Äôm your Dallas Match-Day Concierge.\nType \"reservation\" to book a table, or ask about Dallas matches, all matches, or the menu.",
    lang_set: "Language set to English.",
    helper: 'Try: <code>reservation</code> to book ‚Ä¢ <code>Recall reservation so far</code> ‚Ä¢ Ask about the menu ‚Ä¢ Ask about Dallas match days. Search by team, venue, or date (e.g., "June 13").',
    send: "Send",
    typing: "...",
    chat_title: "Chat",
    side_title: "Dallas Schedule",
    countdown: "World Cup countdown",
    countdown_sub: "Dallas / Arlington match days",
    next_hint: "Next upcoming match is highlighted",
    schedule_empty: "Schedule coming soon ‚Äî update the match list in <code>app.py</code> (DALLAS_MATCHES).",
    menu_title: "Menu"
  },
  es: {
    welcome: "‚öΩ ¬°Bienvenido, fan del Mundial! Soy tu concierge de d√≠as de partido en Dallas.\nEscribe \"reserva\" para reservar una mesa, o pregunta por los partidos (Dallas / todos) o el men√∫.",
    lang_set: "Idioma cambiado a Espa√±ol.",
    helper: 'Prueba: <code>reserva</code> para reservar ‚Ä¢ <code>Recordar reserva</code> ‚Ä¢ Pregunta por el men√∫ ‚Ä¢ Pregunta por los partidos en Dallas.',
    send: "Enviar",
    typing: "...",
    chat_title: "Chat",
    side_title: "Horario Dallas + Men√∫",
    countdown: "Cuenta regresiva",
    countdown_sub: "D√≠as de partido Dallas / Arlington",
    next_hint: "El pr√≥ximo partido est√° resaltado",
    schedule_empty: "El calendario estar√° disponible pronto ‚Äî actualiza <code>DALLAS_MATCHES</code> en <code>app.py</code>.",
    menu_title: "Men√∫"
  },
  pt: {
    welcome: "‚öΩ Bem-vindo, f√£ da Copa do Mundo! Sou seu concierge de dias de jogo em Dallas.\nDigite \"reserva\" para reservar uma mesa, ou pergunte sobre jogos em Dallas, todos os jogos ou o card√°pio.",
    lang_set: "Idioma definido para Portugu√™s.",
    helper: 'Tente: <code>reserva</code> para reservar ‚Ä¢ <code>Relembrar reserva</code> ‚Ä¢ Pergunte sobre o card√°pio ‚Ä¢ Pergunte sobre jogos em Dallas.',
    send: "Enviar",
    typing: "...",
    chat_title: "Chat",
    side_title: "Agenda Dallas + Card√°pio",
    countdown: "Contagem regressiva",
    countdown_sub: "Dias de jogo Dallas / Arlington",
    next_hint: "O pr√≥ximo jogo est√° destacado",
    schedule_empty: "Agenda em breve ‚Äî atualize <code>DALLAS_MATCHES</code> no <code>app.py</code>.",
    menu_title: "Card√°pio"
  },
  fr: {
    welcome: "‚öΩ Bienvenue, fan de la Coupe du Monde ! Je suis votre concierge des jours de match √† Dallas.\nTapez \"r√©servation\" pour r√©server une table, ou demandez les matchs (Dallas / tous) ou le menu.",
    lang_set: "Langue d√©finie sur Fran√ßais.",
    helper: 'Essayez : <code>r√©servation</code> pour r√©server ‚Ä¢ <code>Rappeler la r√©servation</code> ‚Ä¢ Demandez le menu ‚Ä¢ Demandez les matchs √† Dallas.',
    send: "Envoyer",
    typing: "...",
    chat_title: "Chat",
    side_title: "Programme Dallas + Menu",
    countdown: "Compte √† rebours",
    countdown_sub: "Jours de match Dallas / Arlington",
    next_hint: "Le prochain match est surlign√©",
    schedule_empty: "Programme bient√¥t disponible ‚Äî mettez √† jour <code>DALLAS_MATCHES</code> dans <code>app.py</code>.",
    menu_title: "Menu"
  }
};
function L(){ return STRINGS[lang] || STRINGS.en; }

// -----------------------
// Helpers
// -----------------------
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function stripHtml(html){
  const tmp = document.createElement("div");
  tmp.innerHTML = html;
  return tmp.textContent || tmp.innerText || "";
}
function addBubble(role, text){
  const b = document.createElement("div");
  b.className = "bubble " + (role === "user" ? "user" : "bot");
  b.textContent = text;
  chatEl.appendChild(b);
  chatEl.scrollTop = chatEl.scrollHeight;
}
function setSending(isSending){
  sendBtn.disabled = isSending;
  msgEl.disabled = isSending;
  sendBtn.textContent = isSending ? L().typing : L().send;
}

// -----------------------
// Language toggle
// -----------------------
function applyLanguageToUI(){
  pillLang.textContent = lang.toUpperCase();

  document.querySelectorAll(".langbtn[data-lang]").forEach(btn => {
    btn.classList.toggle("active", btn.dataset.lang === lang);
  });

  // scope UI
  scopeDallasBtn?.classList.toggle("active", scope === "dallas");
  scopeAllBtn?.classList.toggle("active", scope === "all");

  // titles
  document.getElementById("chatTitle").textContent = L().chat_title;
  document.getElementById("sideTitle").textContent = L().side_title;
  document.getElementById("countLabel").textContent = L().countdown;
  document.getElementById("countSub").textContent = L().countdown_sub;
  document.getElementById("nextHint").textContent = L().next_hint;
  document.getElementById("menuTitle").textContent = L().menu_title;

  helperHint.innerHTML = L().helper;
  sendBtn.textContent = L().send;

  applyCompactMode();
}

async function setLanguage(newLang){
  lang = newLang;
  localStorage.setItem("lang", lang);
  applyLanguageToUI();

  // UI-only
  buildFlagMarquee();
  startHeroRotation();

  await loadMenu();

  addBubble("assistant", L().lang_set + "\n\n" + stripHtml(L().helper));
  history.push({role:"assistant", content: L().lang_set});
}

document.querySelectorAll(".langbtn[data-lang]").forEach(btn => {
  btn.addEventListener("click", () => setLanguage(btn.dataset.lang));
});

// -----------------------
// Fetchers
// -----------------------
async function loadSchedule(){
  const res = await fetch(`/schedule.json?scope=${encodeURIComponent(scope)}&q=${encodeURIComponent(scheduleQuery)}`, {cache:"no-store"});
  scheduleData = await res.json();
  renderSchedule();
  updateMatchDayMode();
  restartCountdown();
}

async function loadMenu(){
  const res = await fetch("/menu.json?lang=" + encodeURIComponent(lang), {cache:"no-store"});
  const data = await res.json();
  const menuData = data.menu;
  const items = (menuData && Array.isArray(menuData.items)) ? menuData.items : [];
  renderMenu(items);
}

function safeParseTimestamp(dateIso, timeStr){
  if (!dateIso) return null;

  const raw = (timeStr || "").toString().trim();
  if (raw && raw.toUpperCase() !== "TBD"){
    // 24-hour "HH:MM"
    const m24 = raw.match(/^(\d{1,2}):(\d{2})$/);
    if (m24){
      const hh = m24[1].padStart(2,"0");
      const mm = m24[2];
      return Date.parse(`${dateIso}T${hh}:${mm}:00`);
    }
    // 12-hour "H(:MM)? AM/PM"
    const m12 = raw.match(/^(\d{1,2})(?::(\d{2}))?\s*([AaPp][Mm])$/);
    if (m12){
      let hh = parseInt(m12[1],10);
      const mm = (m12[2] || "00");
      const ap = m12[3].toUpperCase();
      if (ap === "PM" && hh !== 12) hh += 12;
      if (ap === "AM" && hh === 12) hh = 0;
      const hh2 = String(hh).padStart(2,"0");
      return Date.parse(`${dateIso}T${hh2}:${mm}:00`);
    }
    // "7 PM"
    const m12b = raw.match(/^(\d{1,2})\s*([AaPp][Mm])$/);
    if (m12b){
      let hh = parseInt(m12b[1],10);
      const ap = m12b[2].toUpperCase();
      if (ap === "PM" && hh !== 12) hh += 12;
      if (ap === "AM" && hh === 12) hh = 0;
      const hh2 = String(hh).padStart(2,"0");
      return Date.parse(`${dateIso}T${hh2}:00:00`);
    }
  }
  // end-of-day fallback
  return Date.parse(`${dateIso}T23:59:59`);
}

// -----------------------
// Countdown
// -----------------------
let countdownTimer = null;

function chooseCountdownTarget(){
  if (scheduleData && scheduleData.next_match && scheduleData.next_match.date){
    const nm = scheduleData.next_match;
    const ts = safeParseTimestamp(nm.date, nm.time);
    if (ts) return new Date(ts);
  }
  return new Date("2026-06-11T00:00:00");
}

function restartCountdown(){
  if (countdownTimer) clearInterval(countdownTimer);

  const target = chooseCountdownTarget();
  const dEl = document.getElementById("d");
  const hEl = document.getElementById("h");
  const mEl = document.getElementById("m");
  const sEl = document.getElementById("s");

  function tick(){
    const now = new Date();
    let diff = Math.max(0, target - now);

    const days = Math.floor(diff / (1000*60*60*24));
    diff -= days*(1000*60*60*24);
    const hrs = Math.floor(diff / (1000*60*60));
    diff -= hrs*(1000*60*60);
    const mins = Math.floor(diff / (1000*60));
    diff -= mins*(1000*60);
    const secs = Math.floor(diff / 1000);

    dEl.textContent = days;
    hEl.textContent = hrs;
    mEl.textContent = mins;
    sEl.textContent = secs;
  }

  tick();
  countdownTimer = setInterval(tick, 1000);
}

// -----------------------
// Schedule rendering + highlight + pagination
// -----------------------
function formatKickoffTime(t){
  const s = (t || "").toString().trim();
  if (!s || s.toUpperCase() === "TBD") return "TBD";
  if (/[AP]M/i.test(s)){
    return s.replace(/\s+/g," ").replace(/am/i,"AM").replace(/pm/i,"PM");
  }
  const m = s.match(/^(\d{1,2}):(\d{2})$/);
  if (m){
    let hh = parseInt(m[1],10);
    const mm = m[2];
    const ap = hh >= 12 ? "PM" : "AM";
    hh = hh % 12; if (hh === 0) hh = 12;
    return `${hh}:${mm} ${ap}`;
  }
  return s;
}

// normalize search input so "June 13" can match backend ISO dates
function normalizeScheduleSearch(raw){
  const s = (raw || "").toString().trim();
  if (!s) return "";
  if (/^20\d{2}-\d{2}-\d{2}$/.test(s)) return s;

  const slash = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
  if (slash){
    let mm = parseInt(slash[1],10);
    let dd = parseInt(slash[2],10);
    let yy = parseInt(slash[3],10);
    if (yy < 100) yy += 2000;
    return `${yy}-${String(mm).padStart(2,"0")}-${String(dd).padStart(2,"0")}`;
  }

  const lower = s.toLowerCase();
  const monthMap = {
    january:1, jan:1, february:2, feb:2, march:3, mar:3, april:4, apr:4, may:5,
    june:6, jun:6, july:7, jul:7, august:8, aug:8, september:9, sep:9, sept:9,
    october:10, oct:10, november:11, nov:11, december:12, dec:12,
    // Spanish
    enero:1, febrero:2, marzo:3, abril:4, mayo:5, junio:6, julio:7, agosto:8, septiembre:9, octubre:10, noviembre:11, diciembre:12,
    // Portuguese
    janeiro:1, fevereiro:2, mar√ßo:3, marco:3, abril:4, maio:5, junho:6, julho:7, agosto:8, setembro:9, outubro:10, novembro:11, dezembro:12,
    // French
    janvier:1, f√©vrier:2, fevrier:2, mars:3, avril:4, mai:5, juin:6, juillet:7, ao√ªt:8, aout:8, septembre:9, octobre:10, novembre:11, d√©cembre:12, decembre:12
  };
  const words = lower.split(/[\s,\-]+/).filter(Boolean);
  let mon = null;
  for (const w of words){
    if (monthMap[w] != null){ mon = monthMap[w]; break; }
  }
  if (mon != null){
    const dayMatch = lower.match(/\b(\d{1,2})\b/);
    if (dayMatch){
      const dd = parseInt(dayMatch[1],10);
      const yMatch = lower.match(/\b(20\d{2})\b/);
      const yy = yMatch ? parseInt(yMatch[1],10) : 2026;
      return `${yy}-${String(mon).padStart(2,"0")}-${String(dd).padStart(2,"0")}`;
    }
  }
  return s;
}

function getEnrichedMatches(){
  const raw = (scheduleData && Array.isArray(scheduleData.matches)) ? scheduleData.matches.slice() : [];
  return raw.map(m => ({...m, ts: safeParseTimestamp(m.date, m.time)}))
            .filter(m => m.ts !== null)
            .sort((a,b)=>a.ts-b.ts);
}

function renderSchedule(){
  const el = document.getElementById("schedule");
  el.innerHTML = "";

  if (scheduleData && scheduleData.notice){
    const row = document.createElement("div");
    row.className = "match";
    row.innerHTML = `<div class="left"><div><b>Notice</b></div><div class="when">${escapeHtml(scheduleData.notice)}</div></div><div class="pill">i</div>`;
    el.appendChild(row);
    matchCountEl.textContent = "0";
    pagerEl.style.display = "none";
    return;
  }

  const enriched = getEnrichedMatches();
  matchCountEl.textContent = String(enriched.length);

  if (!enriched.length){
    const empty = document.createElement("div");
    empty.className = "match";
    empty.innerHTML = `<div class="left"><div><b>Notice</b></div><div class="when">${L().schedule_empty}</div></div><div class="pill">‚Äî</div>`;
    el.appendChild(empty);
    pagerEl.style.display = "none";
    return;
  }

  const now = Date.now();
  const upcoming = enriched.filter(m => m.ts >= now);
  const nextId = upcoming.length ? upcoming[0].id : null;

  const totalPages = Math.max(1, Math.ceil(enriched.length / pageSize()));
  if (currentPage > totalPages) currentPage = 1;

  const start = (currentPage - 1) * pageSize();
  const pageMatches = enriched.slice(start, start + pageSize());

  pagerEl.style.display = (totalPages > 1) ? "block" : "none";
  pageIndicatorEl.textContent = (totalPages > 1) ? `Page ${currentPage} of ${totalPages}` : "";
  prevPageBtn.disabled = (currentPage <= 1);
  nextPageBtn.disabled = (currentPage >= totalPages);

  pageMatches.forEach(m => {
    const row = document.createElement("div");
    row.className = "match" + (m.id === nextId ? " next" : "");

    const timeTxt = formatKickoffTime(m.time);

    // Prefer home/away; fallback parse m.teams
    let homeName = (m.home || "").toString().trim();
    let awayName = (m.away || "").toString().trim();
    if ((!homeName || !awayName) && m.teams){
      const rawTeams = String(m.teams).trim();
      const parts = rawTeams.split(/\s+vs\s+|\s+v\.?\s+/i);
      if (parts.length >= 2){
        homeName = homeName || parts[0].trim();
        awayName = awayName || parts[1].trim();
      }
    }
    homeName = homeName || "TBD";
    awayName = awayName || "TBD";

    const venueTxt = m.venue ? ` ‚Ä¢ ${m.venue}` : "";

    row.innerHTML = `
      <div class="left">
        <div><b>${escapeHtml(m.stage || "Match")}</b> ‚Ä¢ ${escapeHtml(homeName)} <span class="vs">vs</span> ${escapeHtml(awayName)}</div>
        <div class="when">${escapeHtml(m.date || "")} ‚Ä¢ ${escapeHtml(timeTxt)}${escapeHtml(venueTxt)}</div>
      </div>
      <div class="pill">${escapeHtml(m.id || "")}</div>
    `;
    el.appendChild(row);
  });
}

function updateMatchDayMode(){
  const isMatchDay = !!(scheduleData && scheduleData.is_match_day);

  if (isMatchDay){
    pillMode.textContent = "Mode: Match-day";
    matchBanner.textContent = (scheduleData && scheduleData.match_day_banner) ? scheduleData.match_day_banner : "Match-day hours";
    matchBanner.classList.add("show");

    matchdayBox.textContent = "üèüÔ∏è Match-day mode is ON today. Expect higher traffic ‚Äî reserve early!";
    matchdayBox.classList.add("show");
  } else {
    pillMode.textContent = "Mode: Standard";
    matchBanner.classList.remove("show");
    matchdayBox.classList.remove("show");
  }
}

// -----------------------
// Menu rendering
// -----------------------
function renderMenu(items){
  const el = document.getElementById("menu");
  el.innerHTML = "";

  if (!items || !items.length){
    const d = document.createElement("div");
    d.className = "menuitem";
    d.innerHTML = `<div class="menuTop"><div><div class="name">‚öΩ ‚Äî</div><div class="desc">Menu not available.</div></div><div class="menuBadge">‚Äî</div></div>`;
    el.appendChild(d);
    return;
  }

  const icons = ["‚öΩ","üåÆ","üçó","ü•§","üî•","üèüÔ∏è","üåé","ü•á"];
  items.forEach((it, idx) => {
    const d = document.createElement("div");
    d.className = "menuitem";

    const icon = icons[idx % icons.length];
    const name = escapeHtml(it.name || "");
    const desc = escapeHtml(it.desc || "");
    const price = escapeHtml(it.price || "");

    const tags = [];
    const lower = ((it.name||"") + " " + (it.desc||"")).toLowerCase();
    if (lower.includes("spicy") || lower.includes("picante")) tags.push("Spicy");
    if (lower.includes("wings") || lower.includes("alitas") || lower.includes("asinhas")) tags.push("Share");
    if (lower.includes("nacho")) tags.push("Snack");

    d.innerHTML = `
      <div class="menuTop">
        <div>
          <div class="name">${icon} ${name}</div>
          <div class="desc">${desc}</div>
          <div class="menuMeta">
            ${tags.map(t => `<span class="menuTag">${escapeHtml(t)}</span>`).join("")}
          </div>
        </div>
        <div class="menuBadge">${price || "‚Äî"}</div>
      </div>
    `;
    el.appendChild(d);
  });
}

// -----------------------
// Chat send
// -----------------------
async function sendMessage(){
  const text = msgEl.value.trim();
  if (!text) return;

  addBubble("user", text);
  history.push({role:"user", content:text});

  msgEl.value = "";
  msgEl.style.height = "44px";
  setSending(true);

  try{
    const res = await fetch("/chat", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({
        message: text,
        session_id: sessionId,
        language: lang,
        history
      })
    });

    const data = await res.json().catch(() => ({}));
    const reply = (data && data.reply) ? data.reply : "Sorry ‚Äî no reply received.";

    addBubble("assistant", reply);
    history.push({role:"assistant", content: reply});
  } catch(e){
    addBubble("assistant", "‚ö†Ô∏è Network error. Please try again.");
  } finally{
    setSending(false);
    msgEl.focus();
  }
}

sendBtn.addEventListener("click", sendMessage);

// Enter to send, Shift+Enter newline
msgEl.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

// Auto-grow textarea
msgEl.addEventListener("input", () => {
  msgEl.style.height = "44px";
  msgEl.style.height = Math.min(msgEl.scrollHeight, 130) + "px";
});

// -----------------------
// Schedule scope toggle + search
// -----------------------
function setScope(newScope){
  scope = (newScope === "all") ? "all" : "dallas";
  localStorage.setItem("schedule_scope", scope);
  currentPage = 1;
  scopeDallasBtn?.classList.toggle("active", scope === "dallas");
  scopeAllBtn?.classList.toggle("active", scope === "all");
  loadSchedule();
}
scopeDallasBtn?.addEventListener("click", () => setScope("dallas"));
scopeAllBtn?.addEventListener("click", () => setScope("all"));

// Pagination controls
prevPageBtn?.addEventListener("click", () => {
  if (currentPage > 1){
    currentPage--;
    renderSchedule();
  }
});
nextPageBtn?.addEventListener("click", () => {
  const totalPages = Math.max(1, Math.ceil(getEnrichedMatches().length / pageSize()));
  if (currentPage < totalPages){
    currentPage++;
    renderSchedule();
  }
});

// Team search (filters before pagination on backend)
let _searchTimer = null;
function setScheduleQuery(q){
  scheduleQuery = normalizeScheduleSearch((q || "").trim());
  currentPage = 1;
  if (_searchTimer) clearTimeout(_searchTimer);
  _searchTimer = setTimeout(() => loadSchedule(), 250);
}
teamSearchEl?.addEventListener("input", (e) => setScheduleQuery(e.target.value));

// -----------------------
// Clear conversation (UI-only reset, keeps session id)
// -----------------------
function clearConversation(){
  history.length = 0;
  chatEl.innerHTML = "";
  addBubble("assistant", L().welcome);
  history.push({role:"assistant", content: L().welcome});
  msgEl.value = "";
  msgEl.style.height = "44px";
  msgEl.focus();
}
clearBtn?.addEventListener("click", clearConversation);

// -----------------------
// Init
// -----------------------
(async function init(){
  applyLanguageToUI();

  // build continuous world flags marquee (UI-only)
  buildFlagMarquee();

  // start hero rotation immediately (UI-only)
  startHeroRotation();

  // Load sidebar + menu
  await loadSchedule();
  await loadMenu();

  // Welcome message (preserved)
  addBubble("assistant", L().welcome);
  history.push({role:"assistant", content: L().welcome});

  msgEl.focus();
})();
</script>

</body>
</html>
