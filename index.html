<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dallas World Cup 2026 Concierge</title>
  <style>
    :root{
      --bg:#07111f;
      --card:#0e1b33;
      --card2:#0b162b;
      --text:#eaf0ff;
      --muted:#b7c3e6;
      --accent:#2ea043;
      --accent2:#1f6feb;
      --danger:#ff5a5f;
      --border:rgba(255,255,255,0.10);
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, #12345f 0%, rgba(7,17,31,0.2) 60%) ,
                  radial-gradient(1000px 600px at 80% 10%, #2b114b 0%, rgba(7,17,31,0.2) 60%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px;
      display:grid;
      grid-template-columns: 1.15fr 0.85fr;
      gap: 14px;
    }
    @media(max-width: 980px){
      .wrap{grid-template-columns: 1fr}
    }

    header{
      grid-column: 1 / -1;
      background: linear-gradient(135deg, rgba(31,111,235,0.25), rgba(46,160,67,0.18));
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px 16px;
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    header:before{
      content:"";
      position:absolute;
      inset:-40px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.10), transparent 45%),
                  radial-gradient(circle at 70% 10%, rgba(255,255,255,0.08), transparent 40%);
      transform: rotate(-8deg);
      pointer-events:none;
    }
    .titleRow{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      position:relative;
      z-index:1;
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .brand h1{
      margin:0;
      font-size: 18px;
      letter-spacing: 0.3px;
    }
    .brand p{
      margin:0;
      color: var(--muted);
      font-size: 13px;
      line-height:1.3;
    }
    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
    }
    .pill{
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.18);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
    }
    .pill b{color: var(--text)}
    .banner{
      margin-top: 12px;
      position:relative;
      z-index:1;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .matchBanner{
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.06);
      font-size: 13px;
    }
    .matchBanner b{color: #fff}
    .langs{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
    }
    .langBtn{
      border:1px solid var(--border);
      background: rgba(0,0,0,0.25);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:700;
      font-size:12px;
    }
    .langBtn.active{
      outline: 2px solid rgba(46,160,67,0.55);
      background: rgba(46,160,67,0.18);
    }

    .card{
      background: rgba(14,27,51,0.82);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding: 12px 14px;
      background: rgba(255,255,255,0.04);
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .cardHeader h2{
      margin:0;
      font-size: 14px;
    }
    .cardHeader small{
      color: var(--muted);
    }
    .cardBody{padding: 14px;}

    /* Chat */
    #chat{
      height: 430px;
      overflow:auto;
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .bubble{
      max-width: 80%;
      padding: 10px 12px;
      border-radius: 14px;
      line-height: 1.35;
      white-space: pre-wrap;
      word-wrap: break-word;
      border: 1px solid rgba(255,255,255,0.10);
    }
    .user{
      align-self:flex-end;
      background: rgba(31,111,235,0.85);
      border-bottom-right-radius: 6px;
    }
    .bot{
      align-self:flex-start;
      background: rgba(11,22,43,0.85);
      border-bottom-left-radius: 6px;
    }
    .composer{
      display:flex;
      gap:10px;
      padding: 12px;
      border-top:1px solid var(--border);
      background: rgba(255,255,255,0.03);
      align-items:center;
    }
    textarea{
      flex:1;
      resize:none;
      height: 44px;
      max-height: 140px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.20);
      color: var(--text);
      padding: 10px 12px;
      font-size: 14px;
      outline:none;
    }
    .btn{
      border:none;
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 800;
      cursor:pointer;
      color:#fff;
      background: var(--accent2);
      min-width: 92px;
    }
    .btn:disabled{opacity:0.6; cursor:not-allowed}
    .btn.secondary{background: rgba(255,255,255,0.10); border:1px solid var(--border)}
    .btn.good{background: var(--accent)}
    .btn.danger{background: rgba(255,90,95,0.85)}

    /* Schedule list */
    .scheduleList{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:10px;
    }
    .matchItem{
      border:1px solid var(--border);
      background: rgba(0,0,0,0.18);
      border-radius: 12px;
      padding: 10px 10px;
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .matchTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .tag{
      display:inline-block;
      font-size:11px;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--muted);
    }
    .muted{color: var(--muted)}

    /* Reservation form */
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media(max-width: 980px){
      .grid{grid-template-columns: 1fr}
    }
    .field label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .field input{
      width:100%;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.20);
      color: var(--text);
      outline:none;
      font-size: 14px;
    }
    .smallNote{
      font-size: 12px;
      color: var(--muted);
      line-height:1.35;
    }
    .rowBtns{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .countdown{
      font-weight:900;
      font-size: 14px;
      color: #ffffff;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="titleRow">
        <div class="brand">
          <h1>Dallas World Cup 2026 Concierge</h1>
          <p>Match-day questions, reservations, and Dallas schedule ‚Äî fast & friendly.</p>
        </div>

        <div class="pillRow">
          <div class="pill">üèüÔ∏è <b>Dallas / Arlington</b> host city</div>
          <div class="pill">üóìÔ∏è Countdown: <span class="countdown" id="countdown">‚Ä¶</span></div>
        </div>
      </div>

      <div class="banner">
        <div class="matchBanner">
          üá∫üá∏ <b>Match-Day Banner:</b> Opening at <b>11:00am</b> on match days. Arrive early for seating.
        </div>

        <div class="langs">
          <span class="muted" style="font-size:12px;">Languages:</span>
          <button class="langBtn active" id="btn-en" onclick="setLanguage('en')">English</button>
          <button class="langBtn" id="btn-es" onclick="setLanguage('es')">Espa√±ol</button>
          <button class="langBtn" id="btn-pt" onclick="setLanguage('pt')">Portugu√™s</button>
          <button class="langBtn" id="btn-fr" onclick="setLanguage('fr')">Fran√ßais</button>
        </div>
      </div>
    </header>

    <!-- LEFT: Chat -->
    <div class="card">
      <div class="cardHeader">
        <h2>Concierge Chat</h2>
        <small id="langHint">Language: English</small>
      </div>

      <div id="chat"></div>

      <div class="composer">
        <textarea id="msg" placeholder="Type... (Enter to send, Shift+Enter for new line)"></textarea>
        <button class="btn" id="sendBtn" onclick="sendMessage()">Send</button>
        <button class="btn secondary" onclick="recallReservation()">Recall</button>
      </div>

      <div class="cardBody">
        <div class="smallNote">
          Tip: You can type <b>‚Äúrecall reservation so far‚Äù</b> or <b>‚Äúreset reservation‚Äù</b> anytime.
        </div>
      </div>
    </div>

    <!-- RIGHT: Schedule + Reservation Form -->
    <div class="card">
      <div class="cardHeader">
        <h2>Dallas Match Schedule</h2>
        <small>Dynamic from server</small>
      </div>
      <div class="cardBody">
        <div class="smallNote">These are the currently published Dallas/Arlington match dates. Knockout matchups may show as TBD.</div>
        <div class="scheduleList" id="scheduleList"></div>
      </div>

      <div class="cardHeader">
        <h2>Quick Reservation Form</h2>
        <small>Saves directly</small>
      </div>
      <div class="cardBody">
        <div class="grid">
          <div class="field">
            <label>Date (YYYY-MM-DD)</label>
            <input id="r_date" placeholder="2026-06-23" />
          </div>
          <div class="field">
            <label>Time</label>
            <input id="r_time" placeholder="7pm" />
          </div>
          <div class="field">
            <label>Party size</label>
            <input id="r_party" placeholder="4" />
          </div>
          <div class="field">
            <label>Name</label>
            <input id="r_name" placeholder="Cliff" />
          </div>
          <div class="field" style="grid-column: 1 / -1;">
            <label>Phone (10 digits)</label>
            <input id="r_phone" placeholder="2145551212" />
          </div>
        </div>

        <div class="rowBtns">
          <button class="btn good" onclick="submitReservation()">Save Reservation</button>
          <button class="btn secondary" onclick="loadReservationDraft()">Load Draft</button>
          <button class="btn danger" onclick="resetReservationDraft()">Reset Draft</button>
        </div>

        <div class="smallNote" id="formStatus" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>

  <script>
    // -----------------------------
    // Client state
    // -----------------------------
    const history = []; // {role:'user'|'assistant', content:'...'}
    let currentLang = "en";

    const chatEl = document.getElementById("chat");
    const msgEl = document.getElementById("msg");
    const sendBtn = document.getElementById("sendBtn");
    const langHint = document.getElementById("langHint");
    const formStatus = document.getElementById("formStatus");

    function addBubble(role, text) {
      const div = document.createElement("div");
      div.className = "bubble " + (role === "user" ? "user" : "bot");
      div.textContent = text;
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function setSending(isSending) {
      sendBtn.disabled = isSending;
      msgEl.disabled = isSending;
      sendBtn.textContent = isSending ? "..." : "Send";
    }

    function setLanguage(lang) {
      currentLang = lang;

      // Button UI
      ["en","es","pt","fr"].forEach(x => {
        document.getElementById("btn-" + x).classList.toggle("active", x === lang);
      });

      const label = {en:"English", es:"Espa√±ol", pt:"Portugu√™s", fr:"Fran√ßais"}[lang] || "English";
      langHint.textContent = "Language: " + label;

      // Send a silent instruction via history so the assistant stays consistent
      const instruction = {
        en: "Respond in English.",
        es: "Respond in Spanish.",
        pt: "Respond in Portuguese.",
        fr: "Respond in French."
      }[lang];

      // Add as assistant-visible context (not shown in chat)
      history.push({ role: "user", content: instruction });
      formStatus.textContent = "‚úÖ Language set to " + label;
    }

    async function sendMessage() {
      const text = msgEl.value.trim();
      if (!text) return;

      addBubble("user", text);
      history.push({ role: "user", content: text });
      msgEl.value = "";
      msgEl.style.height = "44px";

      setSending(true);

      try {
        const res = await fetch("/chat", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({
            message: text,
            history: history,
            lang: currentLang
          })
        });

        const data = await res.json();
        const reply = data.reply || "Sorry ‚Äî no reply received.";

        addBubble("assistant", reply);
        history.push({ role: "assistant", content: reply });

      } catch (e) {
        addBubble("assistant", "‚ö†Ô∏è Network error. Please try again.");
      } finally {
        setSending(false);
        msgEl.focus();
      }
    }

    msgEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    msgEl.addEventListener("input", () => {
      msgEl.style.height = "44px";
      msgEl.style.height = Math.min(msgEl.scrollHeight, 140) + "px";
    });

    // -----------------------------
    // Reservation helpers
    // -----------------------------
    async function recallReservation() {
      try {
        const res = await fetch("/reservation/status");
        const data = await res.json();
        addBubble("assistant", data.summary || "No reservation draft yet.");
        history.push({ role: "assistant", content: data.summary || "" });
      } catch (e) {
        addBubble("assistant", "‚ö†Ô∏è Could not recall reservation.");
      }
    }

    async function loadReservationDraft() {
      try {
        const res = await fetch("/reservation/status");
        const data = await res.json();
        const d = data.draft || {};
        document.getElementById("r_date").value = d.date || "";
        document.getElementById("r_time").value = d.time || "";
        document.getElementById("r_party").value = d.party_size || "";
        document.getElementById("r_name").value = d.name || "";
        document.getElementById("r_phone").value = d.phone || "";
        formStatus.textContent = "‚úÖ Draft loaded.";
      } catch (e) {
        formStatus.textContent = "‚ö†Ô∏è Could not load draft.";
      }
    }

    async function resetReservationDraft() {
      try {
        await fetch("/reservation/reset", { method: "POST" });
        formStatus.textContent = "‚úÖ Draft reset.";
        document.getElementById("r_date").value = "";
        document.getElementById("r_time").value = "";
        document.getElementById("r_party").value = "";
        document.getElementById("r_name").value = "";
        document.getElementById("r_phone").value = "";
      } catch (e) {
        formStatus.textContent = "‚ö†Ô∏è Could not reset.";
      }
    }

    async function submitReservation() {
      const payload = {
        date: document.getElementById("r_date").value.trim(),
        time: document.getElementById("r_time").value.trim(),
        party_size: document.getElementById("r_party").value.trim(),
        name: document.getElementById("r_name").value.trim(),
        phone: document.getElementById("r_phone").value.trim(),
      };

      try {
        const res = await fetch("/reserve", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });
        const data = await res.json();

        if (data.ok) {
          formStatus.textContent = "‚úÖ Saved! Check Google Sheet.";
          addBubble("assistant", "‚úÖ Reservation saved via form. See you soon!");
          history.push({ role: "assistant", content: "Reservation saved via form." });
        } else {
          formStatus.textContent = "‚ö†Ô∏è " + (data.error || "Could not save.");
        }
      } catch (e) {
        formStatus.textContent = "‚ö†Ô∏è Network error saving reservation.";
      }
    }

    // -----------------------------
    // Countdown widget (local safe clock)
    // World Cup 26 kickoff: 2026-06-11
    // -----------------------------
    function updateCountdown() {
      const kickoff = new Date("2026-06-11T00:00:00"); // local
      const now = new Date();
      const diff = kickoff - now;

      const el = document.getElementById("countdown");
      if (diff <= 0) {
        el.textContent = "It‚Äôs here!";
        return;
      }
      const days = Math.floor(diff / (1000*60*60*24));
      const hrs = Math.floor((diff / (1000*60*60)) % 24);
      const mins = Math.floor((diff / (1000*60)) % 60);
      el.textContent = `${days}d ${hrs}h ${mins}m`;
    }
    setInterval(updateCountdown, 1000 * 10);
    updateCountdown();

    // -----------------------------
    // Schedule loader (dynamic from server)
    // -----------------------------
    async function loadSchedule() {
      const list = document.getElementById("scheduleList");
      list.innerHTML = "Loading‚Ä¶";

      try {
        const res = await fetch("/schedule");
        const data = await res.json();
        const matches = data.matches || [];

        list.innerHTML = "";
        matches.forEach(m => {
          const div = document.createElement("div");
          div.className = "matchItem";

          const top = document.createElement("div");
          top.className = "matchTop";

          const left = document.createElement("div");
          left.innerHTML = `<b>${m.match}</b><div class="muted">${m.venue}</div>`;

          const right = document.createElement("div");
          right.innerHTML = `<span class="tag">${m.stage}</span>`;

          top.appendChild(left);
          top.appendChild(right);

          const bottom = document.createElement("div");
          bottom.className = "muted";
          bottom.textContent = `Date: ${m.date}  ‚Ä¢  Time (CT): ${m.time_ct}`;

          div.appendChild(top);
          div.appendChild(bottom);

          list.appendChild(div);
        });

      } catch (e) {
        list.innerHTML = "‚ö†Ô∏è Could not load schedule.";
      }
    }

    // Initial greeting
    addBubble("assistant", "Hi! Want to book a table for a match day? Ask me anything.");
    history.push({ role: "assistant", content: "Hi! Want to book a table for a match day? Ask me anything." });

    // Default language
    setLanguage("en");

    // Load schedule on startup
    loadSchedule();
  </script>
</body>
</html>