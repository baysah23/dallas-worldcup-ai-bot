<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>World Cup 2026 Dallas Concierge</title>
  <style>
    :root{
      --bg:#071022;
      --panel:#0f1b33;
      --panel2:#0b152c;
      --line:rgba(255,255,255,.12);
      --text:#eaf0ff;
      --muted:#b9c7ee;
      --accent:#2ea043;
      --accent2:#1f6feb;
      --warn:#ffcc66;
    }
    body{
      margin:0; height:100vh; display:flex; flex-direction:column;
      font-family: Arial, sans-serif; background: radial-gradient(1200px 600px at 20% 10%, #132a5b 0%, var(--bg) 55%);
      color:var(--text);
    }
    .wrap{max-width:1050px; width:100%; margin:0 auto; display:flex; flex-direction:column; height:100%;}
    header{
      padding:16px 18px; background: linear-gradient(90deg, #0b1733 0%, #0f1b33 55%, #102246 100%);
      border-bottom:1px solid var(--line);
    }
    .toprow{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    .brand{ display:flex; gap:12px; align-items:center; }
    .badge{
      width:44px; height:44px; border-radius:12px;
      background: linear-gradient(135deg, #f5d76e 0%, #2ea043 45%, #1f6feb 100%);
      box-shadow: 0 10px 35px rgba(0,0,0,.25);
    }
    h1{margin:0; font-size:16px; font-weight:800; letter-spacing:.2px;}
    .sub{margin:6px 0 0; color:var(--muted); font-size:12px;}
    .langbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .langbtn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:8px 10px;
      border-radius:10px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .langbtn.active{background:rgba(46,160,67,.18); border-color:rgba(46,160,67,.45);}
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      padding:14px;
      flex:1;
      min-height:0;
    }
    @media (max-width: 950px){
      .grid{grid-template-columns:1fr;}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06) 0%, rgba(255,255,255,.03) 100%);
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
      min-height:0;
    }
    .cardhead{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(0,0,0,.12);
    }
    .cardhead .title{font-weight:800; font-size:13px;}
    .pill{
      font-size:11px;
      color:var(--muted);
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      background:rgba(0,0,0,.12);
      white-space:nowrap;
    }
    .banner{
      padding:10px 14px;
      border-bottom:1px dashed rgba(255,255,255,.16);
      color:var(--warn);
      font-size:12px;
      display:none;
    }
    .banner.show{display:block;}
    #chat{
      padding:14px;
      height:100%;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .bubble{
      max-width:78%;
      padding:10px 12px;
      border-radius:14px;
      line-height:1.35;
      white-space:pre-wrap;
      word-wrap:break-word;
      border:1px solid rgba(255,255,255,.10);
    }
    .user{
      align-self:flex-end;
      background: rgba(31,111,235,.22);
      border-color: rgba(31,111,235,.35);
    }
    .bot{
      align-self:flex-start;
      background: rgba(0,0,0,.18);
    }
    .composer{
      display:flex;
      gap:10px;
      padding:12px 14px;
      border-top:1px solid var(--line);
      background: rgba(0,0,0,.12);
      align-items:center;
    }
    textarea{
      flex:1;
      resize:none;
      height:44px;
      max-height:130px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color:var(--text);
      padding:10px 12px;
      font-size:14px;
      outline:none;
    }
    button{
      background: var(--accent);
      border:none;
      padding:10px 14px;
      border-radius:12px;
      font-size:14px;
      font-weight:800;
      color:#fff;
      cursor:pointer;
      min-width:92px;
    }
    button:disabled{opacity:.6; cursor:not-allowed;}
    .sidepad{padding:12px 14px;}
    .countdown{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
    }
    .countdown .label{font-size:12px; color:var(--muted); font-weight:700;}
    .countdown .nums{
      display:flex;
      gap:10px;
      align-items:baseline;
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
    }
    .nums span{color:var(--text);}
    .nums b{color:#f5d76e;}
    .schedule{max-height:260px; overflow:auto;}
    .match{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-top:1px solid rgba(255,255,255,.10);
      font-size:12px;
    }
    .match .left{display:flex; flex-direction:column; gap:2px;}
    .match .when{color:var(--muted);}
    .match.next{
      background: rgba(46,160,67,.18);
      border-top:1px solid rgba(46,160,67,.35);
    }
    .matchday{
      margin:12px 14px 0;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(245,215,110,.35);
      background: rgba(245,215,110,.10);
      font-size:12px;
      display:none;
    }
    .matchday.show{display:block;}
    .menu{
      border-top:1px solid rgba(255,255,255,.10);
      padding:10px 12px;
      font-size:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .menuitem{
      padding:8px 10px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      background: rgba(0,0,0,.14);
    }
    .menuitem .name{font-weight:800;}
    .menuitem .desc{color:var(--muted); margin-top:3px;}
    .menuitem .price{margin-top:6px; font-weight:800; color:#f5d76e;}
    .hint{
      padding:10px 14px;
      font-size:12px;
      color:var(--muted);
      border-top:1px dashed rgba(255,255,255,.14);
    }
    code{background:rgba(255,255,255,.10); padding:2px 6px; border-radius:8px;}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="toprow">
        <div class="brand">
          <div class="badge" aria-hidden="true"></div>
          <div>
            <h1>World Cup 2026 ‚Ä¢ Dallas Match-Day Concierge</h1>
            <div class="sub">Reserve tables, see Dallas match schedule, and chat in English ‚Ä¢ Espa√±ol ‚Ä¢ Portugu√™s ‚Ä¢ Fran√ßais</div>
          </div>
        </div>
        <div class="langbar" aria-label="Language toggle">
          <div class="langbtn active" data-lang="en">English</div>
          <div class="langbtn" data-lang="es">Espa√±ol</div>
          <div class="langbtn" data-lang="pt">Portugu√™s</div>
          <div class="langbtn" data-lang="fr">Fran√ßais</div>
        </div>
      </div>
    </header>

    <div class="grid">
      <!-- Chat -->
      <div class="card" style="display:flex;flex-direction:column;min-height:0;">
        <div class="cardhead">
          <div class="title">Chat</div>
          <div class="pill" id="pillMode">Mode: Standard</div>
        </div>

        <div class="banner" id="matchBanner"></div>

        <div id="chat"></div>

        <div class="composer">
          <textarea id="msg" placeholder="Type your message... (Enter to send, Shift+Enter for new line)"></textarea>
          <button id="sendBtn">Send</button>
        </div>

        <div class="hint" id="helperHint"></div>
      </div>

      <!-- Sidebar -->
      <div class="card" style="display:flex;flex-direction:column;min-height:0;">
        <div class="cardhead">
          <div class="title">Dallas Schedule + Menu</div>
          <div class="pill" id="pillLang">EN</div>
        </div>

        <div class="countdown">
          <div>
            <div class="label">World Cup countdown</div>
            <div class="sub" style="margin:4px 0 0;">Dallas / Arlington match days</div>
          </div>
          <div class="nums" id="countNums">
            <span><b id="d">0</b>d</span>
            <span><b id="h">0</b>h</span>
            <span><b id="m">0</b>m</span>
            <span><b id="s">0</b>s</span>
          </div>
        </div>

        <div class="matchday" id="matchdayBox"></div>

        <div class="sidepad" style="padding-bottom:0;">
          <div class="pill" style="display:inline-block;">Next upcoming match is highlighted</div>
        </div>

        <div class="schedule" id="schedule"></div>

        <div class="cardhead" style="border-top:1px solid var(--line); border-bottom:none;">
          <div class="title" id="menuTitle">Menu</div>
          <div class="pill">4 languages</div>
        </div>
        <div class="menu" id="menu"></div>
      </div>
    </div>
  </div>

  <script>
    // =========================================================
    // Session + state
    // =========================================================
    const sessionId = (localStorage.getItem("session_id") || (() => {
      const id = "sess_" + Math.random().toString(16).slice(2) + "_" + Date.now();
      localStorage.setItem("session_id", id);
      return id;
    })());

    let lang = localStorage.getItem("lang") || "en";

    // Mirrors app.py LANG strings (client-side UI only)
    const UI = {
      en: {
        welcome: "Hi! Want to book a table for a match day? Ask me anything.",
        helper: "Tips:\n‚Ä¢ Type ‚Äúreservation‚Äù to start a booking.\n‚Ä¢ Type ‚ÄúRecall reservation so far‚Äù to see what I‚Äôve captured.\n‚Ä¢ You can also ask about the menu or match schedule.",
        lang_set: "Language set to English."
      },
      es: {
        welcome: "¬°Hola! ¬øQuieres reservar una mesa para un d√≠a de partido? Preg√∫ntame lo que sea.",
        helper: "Consejos:\n‚Ä¢ Escribe ‚Äúreserva‚Äù para comenzar.\n‚Ä¢ Escribe ‚ÄúRecordar reserva‚Äù para ver lo guardado.\n‚Ä¢ Tambi√©n puedes preguntar por el men√∫ o el calendario.",
        lang_set: "Idioma cambiado a Espa√±ol."
      },
      pt: {
        welcome: "Ol√°! Quer reservar uma mesa para dia de jogo? Pergunte qualquer coisa.",
        helper: "Dicas:\n‚Ä¢ Digite ‚Äúreserva‚Äù para come√ßar.\n‚Ä¢ Digite ‚ÄúRelembrar reserva‚Äù para ver o que foi salvo.\n‚Ä¢ Voc√™ tamb√©m pode perguntar sobre o card√°pio ou a agenda.",
        lang_set: "Idioma definido para Portugu√™s."
      },
      fr: {
        welcome: "Bonjour ! Vous voulez r√©server une table pour un jour de match ? Demandez-moi !",
        helper: "Astuces :\n‚Ä¢ √âcrivez ‚Äúr√©servation‚Äù pour commencer.\n‚Ä¢ √âcrivez ‚ÄúRappeler la r√©servation‚Äù pour revoir les d√©tails.\n‚Ä¢ Vous pouvez aussi demander le menu ou le calendrier.",
        lang_set: "Langue d√©finie sur Fran√ßais."
      }
    };

    // Conversation memory (client-side history)
    const history = [];

    // Server data
    let scheduleData = null;   // from /schedule.json
    let menuData = null;       // from /menu.json

    // Elements
    const chatEl = document.getElementById("chat");
    const msgEl = document.getElementById("msg");
    const sendBtn = document.getElementById("sendBtn");
    const helperHint = document.getElementById("helperHint");
    const pillLang = document.getElementById("pillLang");
    const pillMode = document.getElementById("pillMode");
    const matchBanner = document.getElementById("matchBanner");
    const matchdayBox = document.getElementById("matchdayBox");
    const menuTitle = document.getElementById("menuTitle");

    function addBubble(role, text){
      const b = document.createElement("div");
      b.className = "bubble " + (role === "user" ? "user" : "bot");
      b.textContent = text;
      chatEl.appendChild(b);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function setSending(isSending){
      sendBtn.disabled = isSending;
      msgEl.disabled = isSending;
      sendBtn.textContent = isSending ? "..." : "Send";
    }

    // =========================================================
    // Language toggle
    // =========================================================
    function setLanguage(newLang){
      lang = newLang;
      localStorage.setItem("lang", lang);

      document.querySelectorAll(".langbtn").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.lang === lang);
      });

      pillLang.textContent = lang.toUpperCase();

      // Update helper/welcome UI (client-side)
      const ui = UI[lang] || UI.en;
      helperHint.textContent = ui.helper;

      // Keep the feature: show a bot notice after switching
      addBubble("assistant", ui.lang_set + "\n\n" + ui.helper);
      history.push({role:"assistant", content: ui.lang_set + "\n\n" + ui.helper});

      // Reload menu in the selected language (server source of truth)
      loadMenu(lang);

      // Optional: if schedule uses localized labels later, re-render
      if (scheduleData) renderSchedule();
    }

    document.querySelectorAll(".langbtn").forEach(btn => {
      btn.addEventListener("click", () => setLanguage(btn.dataset.lang));
    });

    // =========================================================
    // Fetchers (MATCH app.py routes)
    //   - /schedule.json
    //   - /menu.json?lang=en
    // =========================================================
    async function loadSchedule(){
      const res = await fetch("/schedule.json", { cache: "no-store" });
      if (!res.ok) throw new Error("Failed to load schedule.json");
      scheduleData = await res.json();
      renderSchedule();
      updateMatchDayMode();
      startCountdown(); // uses next_match (or a fallback)
    }

    async function loadMenu(lang){
      const res = await fetch("/menu.json?lang=" + encodeURIComponent(lang), { cache: "no-store" });
      if (!res.ok) throw new Error("Failed to load menu.json");
      const data = await res.json();
      menuData = data;
      // menuData.menu = {title, items}
      menuTitle.textContent = (menuData && menuData.menu && menuData.menu.title) ? menuData.menu.title : "Menu";
      renderMenu((menuData && menuData.menu && menuData.menu.items) ? menuData.menu.items : []);
    }

    // =========================================================
    // Countdown
    // - app.py does not have /api/config; we derive a target from schedule.json.
    // - Prefer next_match.date/time if present; otherwise fall back to June 11, 2026.
    // =========================================================
    function getCountdownTarget(){
      // If next match exists, count down to that (more relevant for your sidebar)
      if (scheduleData && scheduleData.next_match && scheduleData.next_match.date) {
        const nm = scheduleData.next_match;
        // next_match in app.py is one of DALLAS_MATCHES items; may be missing time
        if (nm.time) {
          // date: YYYY-MM-DD, time: "17:00" or "7:00 pm" depending on how you store matches
          // Handle "HH:MM" (24h) best; if "7:00 pm" we still parse reasonably in most browsers
          const maybeISO = nm.time.match(/^\d{1,2}:\d{2}$/) ? (nm.date + "T" + nm.time + ":00") : (nm.date + " " + nm.time);
          const dt = new Date(maybeISO);
          if (!isNaN(dt.getTime())) return dt;
        }
        // date only
        const dt2 = new Date(nm.date + "T12:00:00");
        if (!isNaN(dt2.getTime())) return dt2;
      }
      // fallback: World Cup 2026 opening day (approx). Keeps your countdown feature alive.
      return new Date("2026-06-11T12:00:00");
    }

    function startCountdown(){
      const target = getCountdownTarget();
      const dEl = document.getElementById("d");
      const hEl = document.getElementById("h");
      const mEl = document.getElementById("m");
      const sEl = document.getElementById("s");

      function tick(){
        const now = new Date();
        let diff = Math.max(0, target - now);
        const days = Math.floor(diff / (1000*60*60*24));
        diff -= days*(1000*60*60*24);
        const hrs = Math.floor(diff / (1000*60*60));
        diff -= hrs*(1000*60*60);
        const mins = Math.floor(diff / (1000*60));
        diff -= mins*(1000*60);
        const secs = Math.floor(diff / 1000);
        dEl.textContent = days;
        hEl.textContent = hrs;
        mEl.textContent = mins;
        sEl.textContent = secs;
      }

      tick();
      // Avoid multiple intervals if user reloads schedule (simple guard)
      if (window.__countdownTimer) clearInterval(window.__countdownTimer);
      window.__countdownTimer = setInterval(tick, 1000);
    }

    // =========================================================
    // Schedule rendering + next match highlight
    // app.py schedule_json returns:
    //   { today, is_match_day, match_day_banner, next_match, matches }
    // matches items are your DALLAS_MATCHES list
    // =========================================================
    function renderSchedule(){
      const el = document.getElementById("schedule");
      el.innerHTML = "";

      const matchesRaw = (scheduleData && Array.isArray(scheduleData.matches)) ? scheduleData.matches : [];
      if (!matchesRaw.length) {
        const row = document.createElement("div");
        row.className = "match";
        row.innerHTML = `
          <div class="left">
            <div><b>No Dallas matches loaded yet</b></div>
            <div class="when">Update <code>DALLAS_MATCHES</code> in app.py when official dates are finalized.</div>
          </div>
          <div class="pill">TBD</div>
        `;
        el.appendChild(row);
        return;
      }

      const matches = matchesRaw.slice().map((m, idx) => {
        const id = m.id || ("dal-" + String(idx+1).padStart(3,"0"));
        const dateStr = m.date || "";
        const timeStr = m.time || "TBD";

        let ts = null;
        if (dateStr) {
          if (timeStr && timeStr !== "TBD") {
            // Prefer ISO-ish time like 17:00
            const maybeISO = timeStr.match(/^\d{1,2}:\d{2}$/) ? (dateStr + "T" + timeStr + ":00") : (dateStr + " " + timeStr);
            const d = new Date(maybeISO);
            ts = isNaN(d.getTime()) ? Date.parse(dateStr + "T23:59:59") : d.getTime();
          } else {
            ts = Date.parse(dateStr + "T23:59:59");
          }
        } else {
          ts = Date.now() + 999999999; // push unknown to bottom
        }

        // Keep your existing layout fields, but map from app.py list
        // Your app.py placeholder suggested "teams" string; venue optional
        const teams = m.teams || (m.home && m.away ? `${m.home} vs ${m.away}` : "TBD vs TBD");
        const stage = m.stage || m.round || (m.venue ? "Match" : "Dallas Match");
        const venue = m.venue || "AT&T Stadium";

        return { ...m, id, date: dateStr, time: timeStr, teams, stage, venue, ts };
      });

      const now = Date.now();
      const upcoming = matches.filter(m => m.ts >= now).sort((a,b)=>a.ts-b.ts);
      const nextId = upcoming.length ? upcoming[0].id : null;

      matches.sort((a,b)=>a.ts-b.ts).forEach(m => {
        const row = document.createElement("div");
        row.className = "match" + (m.id === nextId ? " next" : "");
        row.innerHTML = `
          <div class="left">
            <div><b>${escapeHtml(m.stage)}</b> ‚Ä¢ ${escapeHtml(m.teams)}</div>
            <div class="when">${escapeHtml(m.date || "TBD")} ‚Ä¢ ${escapeHtml(m.time || "TBD")} ‚Ä¢ ${escapeHtml(m.venue || "")}</div>
          </div>
          <div class="pill">${escapeHtml(m.id)}</div>
        `;
        el.appendChild(row);
      });
    }

    function updateMatchDayMode(){
      const isMatch = !!(scheduleData && scheduleData.is_match_day);
      if (isMatch){
        pillMode.textContent = "Mode: Match-day";
        const banner = (scheduleData && scheduleData.match_day_banner) ? scheduleData.match_day_banner : "Match-day hours";
        matchBanner.textContent = banner;
        matchBanner.classList.add("show");
        matchdayBox.textContent = "üèüÔ∏è Match-day mode is ON today. Expect higher traffic ‚Äî reserve early!";
        matchdayBox.classList.add("show");
      } else {
        pillMode.textContent = "Mode: Standard";
        matchBanner.classList.remove("show");
        matchdayBox.classList.remove("show");
      }
    }

    // =========================================================
    // Menu rendering (server source of truth: /menu.json)
    // =========================================================
    function renderMenu(items){
      const el = document.getElementById("menu");
      el.innerHTML = "";

      if (!items || !items.length){
        const d = document.createElement("div");
        d.className = "menuitem";
        d.innerHTML = `
          <div class="name">No menu items</div>
          <div class="desc">Update <code>MENU</code> in app.py.</div>
          <div class="price">‚Äî</div>
        `;
        el.appendChild(d);
        return;
      }

      items.forEach(it => {
        const d = document.createElement("div");
        d.className = "menuitem";
        d.innerHTML = `
          <div class="name">${escapeHtml(it.name || "")}</div>
          <div class="desc">${escapeHtml(it.desc || "")}</div>
          <div class="price">${escapeHtml(it.price || "")}</div>
        `;
        el.appendChild(d);
      });
    }

    // =========================================================
    // Chat send (MATCH app.py /chat contract)
    // app.py expects:
    //   { message, language, session_id }
    // It returns:
    //   { reply, rate_limit_remaining }
    //
    // NOTE: your old HTML sent {history, lang}; app.py ignores history and uses "language" key.
    // We keep history on the client (feature retained), but only send what server expects.
    // =========================================================
    async function sendMessage(){
      const text = msgEl.value.trim();
      if (!text) return;

      addBubble("user", text);
      history.push({role:"user", content:text});

      msgEl.value = "";
      msgEl.style.height = "44px";
      setSending(true);

      try{
        const res = await fetch("/chat", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({
            message: text,
            language: lang,      // IMPORTANT: matches app.py
            session_id: sessionId
          })
        });

        const data = await res.json().catch(() => ({}));
        const reply = (data && data.reply) ? data.reply : "Sorry ‚Äî no reply received.";
        addBubble("assistant", reply);
        history.push({role:"assistant", content: reply});

        // Optional: if user asked about schedule/menu, we already show sidebar.
        // (No changes needed ‚Äî feature retained via sidebar.)

      } catch(e){
        addBubble("assistant", "‚ö†Ô∏è Network error. Please try again.");
      } finally{
        setSending(false);
        msgEl.focus();
      }
    }

    sendBtn.addEventListener("click", sendMessage);

    // Enter to send, Shift+Enter newline
    msgEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Auto-grow textarea
    msgEl.addEventListener("input", () => {
      msgEl.style.height = "44px";
      msgEl.style.height = Math.min(msgEl.scrollHeight, 130) + "px";
    });

    // =========================================================
    // Small helper
    // =========================================================
    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // =========================================================
    // Init
    // =========================================================
    (async function init(){
      // Apply saved language to UI
      pillLang.textContent = lang.toUpperCase();
      document.querySelectorAll(".langbtn").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.lang === lang);
      });

      // Set helper text for current lang (client-side)
      helperHint.textContent = (UI[lang] || UI.en).helper;

      // Load server data
      try{
        await loadSchedule();
      } catch (e) {
        // keep app usable even if schedule fails
        console.error(e);
      }

      try{
        await loadMenu(lang);
      } catch (e) {
        console.error(e);
      }

      // Welcome message
      const ui = UI[lang] || UI.en;
      addBubble("assistant", ui.welcome);
      history.push({role:"assistant", content: ui.welcome});
    })();
  </script>
</body>
</html>