name: panels-gate

on:
  push:
    branches: ["main"]
  pull_request:
  workflow_dispatch:

jobs:
  panels:
    if: >
      github.event_name != 'pull_request' ||
      github.event.pull_request.head.repo.full_name == github.repository

    runs-on: windows-latest
    timeout-minutes: 25

    env:
      PORT: 5050
      CI: true

      # Deterministic E2E test hooks (server-side)
      E2E_TEST_MODE: "1"
      E2E_TEST_TOKEN: ${{ secrets.E2E_TEST_TOKEN }}

      # Panel URLs (keep using your existing secrets)
      ADMIN_URL: ${{ secrets.ADMIN_URL }}
      MANAGER_URL: ${{ secrets.MANAGER_URL }}
      FANZONE_URL: ${{ secrets.FANZONE_URL }}

      # Visuals quarantined by default in CI
      RUN_VISUAL: "0"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          if (Test-Path requirements.txt) { pip install -r requirements.txt }

      - name: Install Node deps
        shell: pwsh
        run: |
          if (Test-Path package-lock.json) { npm ci } else { npm install }

      - name: Install Playwright + Chromium
        shell: pwsh
        run: |
          npx playwright install --with-deps chromium

      - name: Start server + wait + run tests (single-step, Windows-safe)
        shell: pwsh
        run: |
          $uri = "http://127.0.0.1:5050/__test__/health"
          $hasToken = -not [string]::IsNullOrWhiteSpace($env:E2E_TEST_TOKEN)
          Write-Host ("E2E_TEST_TOKEN present? " + $hasToken)
          Write-Host ("Starting server on PORT=" + $env:PORT)

          # Start Flask server
          $server = Start-Process -PassThru -NoNewWindow `
            -FilePath python `
            -ArgumentList "-u","app.py" `
            -RedirectStandardOutput "server.log" `
            -RedirectStandardError "server.err"

          Write-Host "Server PID: $($server.Id)"

          try {
            # Wait for server
            $ok = $false
            $lastCode = $null
            $lastBody = $null

            for ($i=0; $i -lt 120; $i++) {
              # If server died, stop early and show logs
              if ($server.HasExited) {
                Write-Host "❌ Server process exited early with code $($server.ExitCode)"
                break
              }

              try {
                if ($hasToken) {
                  $resp = Invoke-WebRequest `
                    -UseBasicParsing `
                    -SkipHttpErrorCheck `
                    -Headers @{ "X-E2E-Test-Token" = $env:E2E_TEST_TOKEN } `
                    -Uri $uri `
                    -TimeoutSec 2
                } else {
                  $resp = Invoke-WebRequest `
                    -UseBasicParsing `
                    -SkipHttpErrorCheck `
                    -Uri $uri `
                    -TimeoutSec 2
                }

                $lastCode = [int]$resp.StatusCode
                $lastBody = (($resp.Content | Out-String).Trim())

                if ($i -eq 0 -or ($i % 20 -eq 0)) {
                  Write-Host "Attempt $i => HTTP $lastCode"
                  if ($lastBody) { Write-Host $lastBody }
                }

                if ($lastCode -eq 200) { $ok = $true; break }
              } catch {
                if ($i -eq 0 -or ($i % 20 -eq 0)) {
                  Write-Host "Attempt $i => exception: $($_.Exception.Message)"
                }
              }

              Start-Sleep -Milliseconds 500
            }

            if (-not $ok) {
              Write-Host "❌ Server not ready (health check failed)"
              Write-Host "Last observed: HTTP $lastCode"
              if ($lastBody) { Write-Host $lastBody }
              if (Test-Path server.log) { Get-Content server.log -Tail 200 | Out-Host }
              if (Test-Path server.err) { Get-Content server.err -Tail 200 | Out-Host }
              throw "Server not ready at $uri"
            }

            Write-Host "✅ Server reachable — running deterministic gate"
            npm run test:panels

            Write-Host "✅ Gate tests finished"
          }
          finally {
            # Always stop server
            if ($server -and -not $server.HasExited) {
              try { Stop-Process -Id $server.Id -Force -ErrorAction SilentlyContinue } catch {}
            }
          }

      - name: Visual checks (optional / non-blocking)
        if: always()
        shell: pwsh
        continue-on-error: true
        env:
          RUN_VISUAL: "1"
        run: |
          npm run test:visual

      - name: Upload Playwright HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report
          if-no-files-found: warn
          retention-days: 7

      - name: Upload Playwright test-results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results
          if-no-files-found: warn
          retention-days: 7

      - name: Upload server logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: server-logs
          path: |
            server.log
            server.err
          if-no-files-found: warn
          retention-days: 7

  panels_fork_notice:
    if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name != github.repository
    runs-on: ubuntu-latest
    steps:
      - run: echo "Skipping panels-gate on fork PRs (GitHub does not provide repo secrets to forked pull_request workflows)."